<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Diary</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style id="trading-diary-styles">
        /* CSS Variables for Light and Dark Themes */
        :root {
            --bg-color: #ffffff;
            --text-color: #252525;
            --secondary-bg: rgba(235, 232, 232, 0.95);
            --hint-color: rgba(0, 0, 0, 0.445);
            --button-color: #3498dbb4;
            --button-text-color: #f5f5f5;
            --border-color: #c0c0c0;
            --shadow-color: rgba(0, 0, 0, 0.8);
            --positive-color: #2ecc71;
            --negative-color: #e74c3c;
            --refund-color: #3498db;
            --profit-bg: #e8f5e9;
            --loss-bg: #ffebee;
            --refund-bg: #e3f2fd;
            --cell-bg: #fafafa;
            --cell-hover-bg: #e3f2fd;
            --modal-bg: #ffffff;
            --input-bg: #ffffff;
            --input-border: #ddd;
            --progress-bg: #e0e0e0;
            --progress-profit: #4CAF50;
            --progress-loss: #F44336;
            --tab-bg: #ecf0f1;
            --tab-active-bg: #3498dbb4;
            --notification-success: #27ae60;
            --notification-error: #e74c3c;
            --shine-fade: #e11d48;
            --shine-color: #ffffff;
        }

        [data-theme="dark"] {
            --bg-color: #242424;
            --text-color: #dddddd;
            --secondary-bg: #2d2d2d;
            --hint-color: rgba(255, 255, 255, 0.40);
            --button-color: #3498dbb4;
            --button-text-color: #dddddd;
            --border-color: #444444;
            --shadow-color: rgba(0, 0, 0, 0.8);
            --positive-color: #4CAF50;
            --negative-color: #F44336;
            --refund-color: #2196F3;
            --profit-bg: #1b2e1b;
            --loss-bg: #2e1b1b;
            --refund-bg: #1b1e2e;
            --cell-bg: #2d2d2d;
            --cell-hover-bg: #3d3d3d;
            --modal-bg: #2d2d2d;
            --input-bg: #3d3d3d;
            --input-border: #555555;
            --progress-bg: #444444;
            --progress-profit: #4CAF50;
            --progress-loss: #F44336;
            --tab-bg: #2d2d2d;
            --tab-active-bg: #3498dbb4;
            --notification-success: #4CAF50;
            --notification-error: #F44336;
            --shine-fade: #f472b6;
            --shine-color: #ffffff;
        }

        [data-theme="dark"] .balance-label,
        [data-theme="dark"] .progress-label,
        [data-theme="dark"] .setting-label {
            color: var(--text-color);
        }

        [data-theme="dark"] .settings-panel h3 {
            color: var(--text-color);
        }

        [data-theme="dark"] .progress-stats {
            color: var(--hint-color);
        }
        [data-theme="dark"] .progress-bar {
            background: var(--progress-bg);
        }

        [data-theme="dark"] .progress-container {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
        }


        [data-theme="dark"] .date-label {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        [data-theme="dark"] .month-comments textarea {
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
        }

        [data-theme="dark"] .settings-panel {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: revert;
            font-family: 'Roboto', Arial, sans-serif;
        }
        
        body {
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 5px;
            font-size: 14px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: var(--secondary-bg);
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--shadow-color);
            overflow: hidden;
            border: 1px solid var(--hint-color);
        }
        
        header {
            background: var(--secondary-bg);
            color: var(--text-color);
            padding: 10px;
            text-align: left;
            position: relative;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 10px;
            min-height: 40px;
        }

        .header-content h1 {
            margin: 0;
            font-size: 1.5rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .date-display {
            white-space: nowrap;
            flex-shrink: 0;
            font-size: 0.9rem;
        }
        
        /* Адаптивность для мобильных устройств */
        @media (max-width: 480px) {
            .header-content {
                gap: 8px;
            }

            .header-content h1 {
                font-size: 1.3rem;
            }

            .header-actions {
                gap: 8px;
            }

            .export-header-btn {
                font-size: 0.75rem;
                padding: 5px 10px;
            }

            .date-display {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 400px) {
            .header-content {
                gap: 6px;
            }

            .header-content h1 {
                font-size: 1.2rem;
            }

            .export-header-btn {
                font-size: 0.7rem;
                padding: 4px 8px;
            }

            .date-display {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 360px) {
            .header-content {
                gap: 6px;
            }

            .header-content h1 {
                font-size: 1.1rem;
                flex-shrink: 1;
            }

            .header-actions {
                flex-shrink: 0;
            }

            .export-header-btn {
                font-size: 0.65rem;
                padding: 4px 6px;
            }

            .date-display {
                font-size: 0.7rem;
            }
        }

        @media (max-width: 320px) {
            .header-content {
                gap: 4px;
            }

            .header-content h1 {
                font-size: 1.0rem;
                flex-shrink: 1;
            }

            .header-actions {
                flex-shrink: 0;
            }

            .export-header-btn {
                font-size: 0.6rem;
                padding: 3px 5px;
            }

            .date-display {
                font-size: 0.65rem;
            }
        }
        
        .btn {
            background: var(--button-color);
            color: var(--button-text-color);
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            margin: 2px;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-success {
            background: var(--button-color);
        }
        
        .btn-danger {
            background: var(--button-color);
        }
        
        .btn-warning {
            background: var(--button-color);
        }
        
        .main-content {
            padding: 10px;
        }
        
        .balance-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            margin-bottom: 0px;
            background: var(--bg-color);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--hint-color);
            gap: 8px;
            box-shadow: inset 0 2px 4px var(--shadow-color);
        }
        
        .balance-item {
            text-align: center;
            background: var(--secondary-bg);
            border-radius: 8px;
            padding: 8px 4px;
            border: 1px solid var(--hint-color);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            box-shadow: 0px 3px 6px var(--shadow-color)
        }

        .balance-label {
            font-size: 0.7rem;
            color: var(--hint-color);
            line-height: 1.2;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 1.5rem;
            min-height: 1.5rem;
            margin-bottom: 0;
        }

        .balance-value {
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            line-height: 1.2;
            transition: all 0.2s;
            color: var(--text-color);
            word-break: break-all;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 2rem;
            min-height: 2rem;
        }
        
        .starting-balance {
            background-color: var(--button-color);
            border-radius: 8px;
            padding: 6px 8px;
            border: 2px solid var(--button-color);
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            opacity: 0.7;
        }

        .starting-balance:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgb(123, 22, 255);
        }

        .starting-balance.balance-value {
            color: #007bff !important;
            border: 2px solid #007bff;
            background: rgba(0, 123, 255, 0.15);
            opacity: 0.7;
            border-radius: 6px;
            padding: 4px 8px !important;
            font-size: 0.85rem !important;
            min-height: 30px !important;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between  !important;
            gap: 8px;
            width: 100%;
        }

        .balance-amount {
            flex: 1;
            text-align: left;
            padding: 2px 0;
            font-size: 1.0rem !important;
            font-weight: 400;
            color: var(--text-color) !important;
            white-space: nowrap;
            overflow: visible;
            text-overflow: ellipsis;
        }

        .percentage-indicator {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            gap: 4px; /* Расстояние между стрелкой и процентом */
            font-size: 1.2rem !important;
            font-weight: 700;
            min-width: 2px !important;
            max-width: 80px;
            flex-shrink: 0;
            height: 100%;
        }

        .indicator-arrow {
            width: 28px !important;
            height: 18px !important;
            font-size: 16px !important;
            font-weight: 900 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none !important;
            border-radius: 0 !important;
            margin: 0;
            line-height: 1;
        }

        .indicator-percentage {
            font-size: 0.9rem !important;
            font-weight: 700;
            line-height: 1;
            margin: 0;
        }

        /* Цвета для положительной стрелки */
        .indicator-arrow.positive {
            color: #00a105 !important;
        }

        /* Цвета для отрицательной стрелки */
        .indicator-arrow.negative {
            color: var(--negative-color) !important;
        }

        /* Цвета для нейтральной стрелки */
        .indicator-arrow.neutral {
            color: var(--text-color) !important;
        }

        /* Цвета для положительного процента */
        .indicator-percentage.positive {
            color: #00a105 !important;
        }

        /* Цвета для отрицательного процента */
        .indicator-percentage.negative {
            color: var(--negative-color) !important;
        }

        /* Цвета для нейтрального процента */
        .indicator-percentage.neutral {
            color: var(--text-color) !important;
        }

        /* Адаптивные стили для мобильных устройств */
        @media (max-width: 400px) {
            .starting-balance.balance-value {
                padding: 3px 6px !important;
                font-size: 0.8rem !important;
                min-height: 28px !important;
                gap: 1px;
            }

            .balance-amount {
                font-size: 0.9rem !important;
            }

            .percentage-indicator {
                font-size: 1.0rem !important;
                min-width: 1px !important;
                gap: 6px;
            }

            .indicator-arrow {
                width: 24px !important;
                height: 16px !important;
                font-size: 14px !important;
            }

            .indicator-percentage {
                font-size: 0.6rem !important;
            }
        }

        @media (max-width: 360px) {
            .starting-balance.balance-value {
                padding: 2px 4px !important;
                font-size: 0.75rem !important;
                min-height: 26px !important;
                gap: 4px;
            }

            .balance-amount {
                font-size: 0.85rem !important;
            }

            .percentage-indicator {
                font-size: 0.9rem !important;
                min-width: 1px !important;
                gap: 3px;
            }

            .indicator-arrow {
                width: 20px !important;
                height: 14px !important;
                font-size: 12px !important;
            }

            .indicator-percentage {
                font-size: 0.6rem !important;
            }
        }

        @media (max-width: 320px) {
            .starting-balance.balance-value {
                padding: 2px 3px !important;
                font-size: 0.7rem !important;
                min-height: 24px !important;
            }

            .balance-amount {
                font-size: 0.8rem !important;
            }

            .percentage-indicator {
                font-size: 0.8rem !important;
                min-width: 1px !important;
                gap: 6px;
            }

            .indicator-arrow {
                width: 18px !important;
                height: 12px !important;
                font-size: 11px !important;
            }

            .indicator-percentage {
                font-size: 0.6rem !important;
            }
        }

        .positive {
            color: var(--positive-color);
        }

        .negative {
            color: var(--negative-color);
        }

        /* Обновляем стили для индикатора баланса - мобильная адаптация */
        @media (max-width: 400px) {
            #percentage-indicator {
                font-size: 0.4rem !important;
                min-width: 25px !important;
            }

            #indicator-arrow {
                width: 12px !important;
                height: 15px !important;
                font-size: 16px !important;
            }

            #indicator-percentage {
                font-size: 0.7rem !important;
            }
        }

        @media (max-width: 360px) {
            #percentage-indicator {
                font-size: 0.35rem !important;
                min-width: 22px !important;
            }

            #indicator-arrow {
                width: 12px !important;
                height: 15px !important;
                font-size: 16px !important;
            }

            #indicator-percentage {
                font-size: 0.7rem !important;
            }
        }

        @media (max-width: 320px) {
            #percentage-indicator {
                font-size: 0.3rem !important;
                min-width: 20px !important;
            }

            #indicator-arrow {
                width: 12px !important;
                height: 12px !important;
                font-size: 15px !important;
            }

            #indicator-percentage {
                font-size: 0.5rem !important;
            }
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 10px;
            border: 1px solid var(--hint-color);
            border-radius: 10px;
            width: 100%;
            box-shadow: 0 3px 6px var(--shadow-color);
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--bg-color);
            font-size: 0.8rem;
            table-layout: fixed;
            color: var(--text-color);
            border-radius: 10px;
            overflow: hidden;
        }
        
        th, td {
            border-bottom: 1px solid var(--hint-color);
            border-right: 1px solid var(--hint-color);
            padding: 8px;
            text-align: center;
            min-width: 60px;
            height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-color);
        }
        
        th {
            background: var(--button-color);
            color: var(--button-text-color);
            position: sticky;
            top: 0;
            font-weight: 600;
            white-space: normal;
            word-break: keep-all;
            line-height: 1.3;
            padding: 12px 10px;
            text-align: center;
            font-size: 0.8rem;
            min-width: 120px;
            overflow: visible;
            text-overflow: clip;
        }

        
        th:last-child, td:last-child {
            border-right: none;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .trade-header {
            background: var(--bg-color);
            color: var(--text-color);
            width: 50px;
        }
        
        .cell {
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background-color: var(--cell-bg);
        }

        .cell:hover {
            background-color: var(--cell-hover-bg);
        }
        
        .cell.disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
            pointer-events: none;
        }
        
        .cell-content {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .amount-positive {
            background: var(--profit-bg);
            color: var(--positive-color);
            border-left: 5px solid var(--positive-color);
        }

        .amount-negative {
            background: var(--loss-bg);
            color: var(--negative-color);
            border-left: 5px solid var(--negative-color);
        }

        .amount-zero {
            background: var(--refund-bg);
            color: var(--refund-color);
            border-left: 5px solid var(--refund-color);
        }
        
        .summa {
            background-color: #fffd9933;
            color: var(--text-color);
        }
        
        .emotion-cell {
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .comments-cell {
            text-align: left;
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .comments-cell {
            color: var(--text-color);
        }
        
        .add-trade-btn {
            margin-top: 12px;
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .add-trade-btn:hover {
            background: #27ae60; /* Зеленый вместо синего */
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .add-trade-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Убраны кнопки действий */
        .telegram-actions {
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--modal-bg);
            color: var(--text-color);
            padding: 15px;
            border-radius: 8px;
            width: 90%;
            max-width: 300px;
            text-align: center;
        }

        [data-theme="dark"] .modal-content {
            background: var(--modal-bg);
            color: var(--text-color);
        }

        [data-theme="dark"] .emotion-option {
            color: var(--text-color);
            border: 1px solid var(--input-border);
        }

        [data-theme="dark"] .emotion-option:hover {
            background: var(--input-bg);
        }

        [data-theme="dark"] .emotion-label {
            color: var(--text-color);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .modal-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            flex: 1;
            min-width: 80px;
        }
        
        .profit-btn {
            background: var(--positive-color);
            color: var(--button-text-color);
        }
        
        .loss-btn {
            background: var(--negative-color);
            color: var(--button-text-color);
        }
        
        .refund-btn {
            background: var(--refund-color);
            color: var(--button-text-color);
        }
        
        .reset-btn {
            background: var(--hint-color);
            color: var(--button-text-color);
        }
        
        .emotion-modal-content {
            max-width: 250px;
        }
        
        .emotion-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .emotion-option {
            padding: 8px;
            border: 1px solid var(--hint-color);
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            color: var(--text-color);
        }
        
        .emotion-option:hover {
            background: var(--secondary-bg);
        }
        
        .emotion-emoji {
            font-size: 1.5rem;
            margin-bottom: 3px;
            color: var(--text-color);
        }
        
        .emotion-label {
            font-size: 0.7rem;
        }
        
        .comments-modal-content {
            max-width: 300px;
        }
        
        .comments-textarea {
            width: 100%;
            min-height: 100px;
            padding: 8px;
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--hint-color);
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        [data-theme="dark"] .comments-textarea {
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
        }
        
        .comments-textarea::placeholder {
            color: var(--hint-color);
        }
        
        #mainApp .tabs {
            display: flex;
            margin-bottom: 12px;
            background: var(--tab-bg);
            border-radius: 12px;
            overflow: hidden;
            flex-wrap: wrap;
            box-shadow: 0 2px 4px var(--shadow-color);
            border: 1px solid var(--border-color);
            /* Изолируем стили вкладок дневника от гида */
            position: relative;
            z-index: 2;
        }
        
        #mainApp .tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            min-width: 70px;
            color: var(--text-color);
            background: var(--tab-bg);
            font-weight: 500;
            border-right: 1px solid var(--border-color);
            position: relative;
            /* Изолируем стили вкладок дневника от гида */
            z-index: 2;
            
            /* Убедимся, что вкладки дневника используют свои собственные селекторы */
            /* Убираем любые наследуемые стили от гида */
            animation: none;
            transform: none;
        }
        
        #mainApp .tab:last-child {
            border-right: none;
        }
        
        #mainApp .tab:hover {
            background: #27ae60; /* Зеленый вместо синего */
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        
        #mainApp .tab.active {
            background: var(--tab-active-bg);
            color: var(--button-text-color);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }
        
        #mainApp .tab-content {
            display: none;
            /* Изолируем контент вкладок дневника от гида */
            position: relative;
            z-index: 2;
            /* Убедимся, что анимации применяются только к вкладкам дневника */
            animation: none;
        }
        
        #mainApp .tab-content.active {
            display: block;
            animation: diaryFadeInScale 0.3s ease-out;
            /* Убедимся, что анимация применяется только к вкладкам дневника */
            position: relative;
            z-index: 2;
        }
        
        @keyframes diaryFadeInScale {
            from {
                opacity: 0;
                transform: scale(0.98);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes guideFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Убедимся, что анимации применяются только к соответствующим контейнерам */
        #mainApp .tab-content.active {
            display: block;
            animation: diaryFadeInScale 0.3s ease-out;
        }
        
        #guideContainer .tab-content.active {
            display: block;
            animation: guideFadeIn 0.5s ease-in-out;
        }
        
        /* Дополнительная изоляция: переопределяем анимации для вкладок гида */
        #guideContainer .tab-content {
            animation: none;
        }
        
        #guideContainer .tab-content.active {
            animation: guideFadeIn 0.5s ease-in-out;
        }
        
        /* Добавим специфичные селекторы для вкладок дневника */
        #mainApp .tabs {
            position: relative;
            z-index: 2;
        }
        
        #mainApp .tab {
            position: relative;
            z-index: 2;
        }
        
        /* Добавим специфичные селекторы для элементов вкладок дневника */
        #mainApp .tab-content {
            position: relative;
            z-index: 2;
        }
        
        /* Изолируем анимации вкладок дневника от гида */
        #mainApp .tab-content {
            animation: none;
        }
        
        #mainApp .tab-content.active {
            animation: diaryFadeInScale 0.3s ease-out;
        }
        
        /* Дополнительная изоляция стилей вкладок дневника */
        #mainApp .tabs,
        #mainApp .tab,
        #mainApp .tab-content {
            /* Убедимся, что все стили вкладок дневника изолированы */
            all: revert-layer;
        }
        
        /* Более конкретные стили для вкладок дневника */
        #mainApp .tabs {
            display: flex;
            margin-bottom: 0px;
            background: var(--tab-bg);
            border-radius: 12px;
            overflow: hidden;
            flex-wrap: wrap;
            box-shadow: 0 3px 6px var(--shadow-color);
            border: 1px solid var(--border-color);
            position: relative;
            z-index: 2;
        }
        
        #mainApp .tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            min-width: 70px;
            color: var(--text-color);
            background: var(--tab-bg);
            font-weight: 500;
            border-right: 1px solid var(--border-color);
            position: relative;
            z-index: 2;
            animation: none;
            transform: none;
        }
        
        #mainApp .tab-content {
            display: none;
            position: relative;
            z-index: 2;
            animation: none;
        }
        
        .amount-input {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .amount-input::placeholder {
            color: var(--hint-color);
        }
        
        .date-navigation {
            display: flex;
            justify-content: center;
            margin: 10px 0;
            gap: 10px;
            padding: 0 10px;
        }
        
        .date-btn {
            background: var(--button-color);
            color: var(--button-text-color);
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        
        .date-btn:hover {
            background: #27ae60; /* Зеленый вместо синего */
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .date-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .date-label {
            padding: 10px 16px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 150px;
            text-align: center;
            font-weight: bold;
            background: var(--secondary-bg);
            border-radius: 20px;
            border: 1px solid var(--hint-color);
        }

        
        .notification {
            position: fixed;
            top: 0px;
            left: 10px;
            padding: 8px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            max-width: 200px;
            word-wrap: break-word;
        }
        
        .notification.success {
            background: var(--notification-success);
            opacity: 1;
        }

        .notification.error {
            background: var(--notification-error);
            opacity: 1;
        }
        
        /* Styles for General tab */
        .general-header {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .month-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .current-date {
            font-size: 0.9rem;
            color: var(--hint-color);
        }
        
        .general-table-container {
            overflow-x: auto;
            margin-bottom: 10px;
            border: 1px solid var(--hint-color);
            border-radius: 10px;
        }
        
        .general-table {
            font-size: 0.7rem;
        }
        
        .general-table th, .general-table td {
            padding: 6px;
            text-align: center;
            min-width: 80px;
            height: 30px;
        }

        .general-table th {
            white-space: normal;
            word-break: keep-all;
            overflow: visible;
            text-overflow: clip;
            font-size: 0.8rem;
        }
        
        .general-table .editable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .general-table .editable:hover {
            background-color: var(--secondary-bg);
        }
        
        .general-table .current-day {
            background: rgba(52, 152, 219, 0.2);
            color: var(--button-text-color) !important;
            font-weight: bold;
            border: 1px solid rgba(52, 152, 219, 0.5);
        }

        [data-theme="dark"] .general-table .current-day {
            box-shadow: 0 0 3px rgba(52, 152, 219, 0.5);
        }
        
        .withdrawal-table-container {
            margin-top: 15px;
            overflow-x: auto;
            border: 1px solid var(--hint-color);
            border-radius: 10px;
        }
        
        .withdrawal-table {
            font-size: 0.7rem;
            width: 100%;
        }
        
        .withdrawal-table th, .withdrawal-table td {
            padding: 6px;
            text-align: center;
            min-width: 90px;
            height: 30px;
        }

        .withdrawal-table th {
            white-space: normal;
            word-break: keep-all;
            overflow: visible;
            text-overflow: clip;
            font-size: 0.8rem;
        }
        
        .withdrawal-table .editable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .withdrawal-table .editable:hover {
            background-color: var(--secondary-bg);
        }
        
        .add-withdrawal-btn {
            margin-top: 10px;
            width: 100%;
        }
        
        .add-withdrawal-btn:hover {
            background: #27ae60; /* Зеленый вместо синего */
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .month-comments {
            margin-top: 15px;
        }
        
        .month-comments textarea {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--hint-color);
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
            font-size: 0.8rem;
        }

        
        .month-comments textarea::placeholder {
            color: var(--hint-color);
        }
        
        .target-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .target-modal-content {
            background: var(--modal-bg);
            color: var(--text-color);
            padding: 15px;
            border-radius: 8px;
            width: 90%;
            max-width: 280px;
            text-align: center;
        }

        [data-theme="dark"] .target-modal-content {
            background: var(--modal-bg);
            color: var(--text-color);
        }
        
        .target-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .target-modal-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .target-input {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--hint-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        [data-theme="dark"] .target-input {
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
        }
        
        .target-input::placeholder {
            color: var(--hint-color);
        }
        
        .balance-input {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--hint-color);
            border-radius: 4px;
            font-size: 0.9rem;
            text-align: center;
        }

        [data-theme="dark"] .balance-input {
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
        }
        
        .balance-input::placeholder {
            color: var(--hint-color);
        }
        
        .withdrawal-action-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .withdrawal-action-content {
            background: var(--modal-bg);
            color: var(--text-color);
            padding: 15px;
            border-radius: 8px;
            width: 90%;
            max-width: 250px;
            text-align: center;
        }

        [data-theme="dark"] .withdrawal-action-content {
            background: var(--modal-bg);
            color: var(--text-color);
        }
        
        .withdrawal-action-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .withdrawal-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            flex: 1;
        }
        
        .edit-btn {
            background: var(--button-color);
            color: var(--button-text-color);
        }
        
        .delete-btn {
            background: var(--negative-color);
            color: var(--button-text-color);
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .history-table th, .history-table td {
            border: 1px solid var(--hint-color);
            padding: 10px;
            text-align: center;
            min-width: 100px;
        }

        .history-table th {
            white-space: normal;
            word-break: keep-all;
            overflow: visible;
            text-overflow: clip;
            font-size: 0.9rem;
        }
        
        .history-table th {
            background: var(--secondary-bg);
            color: var(--text-color);
        }
        
        .progress-container {
            margin-top: 5px;
            padding: 12px;
            background: var(--secondary-bg);
            border-radius: 12px;
            border: 1px solid var(--hint-color);
            box-shadow: inset 0 3px 6px var(--shadow-color);
        }


        .progress-label {
            font-size: 0.85rem;
            margin-bottom: 8px;
            color: var(--text-color);
            text-align: center;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--progress-bg);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 3px 6px var(--shadow-color);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--progress-profit), var(--progress-profit));
            border-radius: 6px;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, var(--hint-color), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.75rem;
            color: var(--hint-color);
            font-weight: 500;
        }
        
        .progress-loss-fill {
            background: var(--progress-loss) !important;
        }
        
        .center-marker {
            position: absolute;
            left: 50%;
            top: 0;
            height: 100%;
            width: 2px;
            background: var(--text-color);
            transform: translateX(-50%);
            z-index: 2;
        }
        
        /* Добавленные стили для кнопок настроек */
        .settings-btn {
            margin: 5px 0;
            width: 100%;
        }

        .settings-panel {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--secondary-bg);
            border-radius: 8px;
            border: 1px solid var(--hint-color);
        }


        .settings-panel h3 {
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        .setting-row {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .setting-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        
        .setting-label input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .balance-container {
                flex-direction: row;
                gap: 5px;
                padding: 6px;
            }
            
            .balance-value {
                font-size: 1.1rem;
            }
        }
        
        @media (max-width: 360px) {
            table th, table td {
                min-width: 45px;
                padding: 3px;
                font-size: 0.65rem;
            }

            .tab {
                min-width: 60px;
                padding: 6px;
            }

            .trade-header {
                width: 40px;
            }

            .balance-item {
                min-width: 85px;
                margin: 0 1px;
            }

            .balance-label {
                font-size: 0.7rem;
            }

            .balance-value {
                   font-size: 1rem;
               }
        }
        
        /* Ensure cohesive style for Clear buttons */
        .btn-warning {
            background: #ff9800;
            color: #fff;
            border: 2px solid #ff9800;
            border-radius: 6px;
            padding: 4px 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px var(--shadow-color);
            cursor: pointer;
        }

        .btn-warning:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .btn-danger {
            background: #f44336;
            color: #fff;
            border: 2px solid #f44336;
            border-radius: 6px;
            padding: 4px 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px var(--shadow-color);
            cursor: pointer;
        }

        .btn-danger:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        /* Toggle Switch Styles */
        .toggle-switch-container {
            margin-bottom: 15px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 4px 6px;
            font-weight: 600;
            border-radius: 6px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: var(--text-color);
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Размещаем текст по краям */
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 4px 8px; /* Увеличен padding для размещения текста */
            cursor: pointer;
            transition: all 0.3s ease, box-shadow 0.2s ease, transform 0.1s ease; /* Добавлены transition для эффектов */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            width: 120px;
            opacity: 0.9;
            position: relative;
            overflow: visible; /* Изменено для эффекта тени */
        }

        /* Эффект при наведении */
        .toggle-switch:hover {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Эффект при нажатии */
        .toggle-switch:active {
            transform: translateY(0px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.8);
        }

        .toggle-switch.on {
            background: rgba(255, 255, 255, 0.1);
        }

        .toggle-label {
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            z-index: 2;
            transition: opacity 0.3s ease;
            padding: 0;
            user-select: none;
        }

        .toggle-label.off {
            opacity: 1;
            left: 10px;
        }

        .toggle-label.on {
            opacity: 0.5;
            right: 10px;
        }

        .toggle-switch.on .toggle-label.off {
            opacity: 0.5;
        }

        .toggle-switch.on .toggle-label.on {
            opacity: 1;
        }

        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            width: 46%;
            height: calc(100% - 8px);
            background: white;
            border-radius: 20px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            z-index: 1;
        }

        .toggle-switch.on .toggle-slider {
            transform: translateX(100%);
        }

        .toggle-indicator {
            width: 100%;
            height: 100%;
            background: #dc3545; /* red for OFF */
            border-radius: 20px;
            transition: background 0.3s ease;
        }

        .toggle-switch.on .toggle-indicator {
            background: #28a745; /* green for ON */
        }

        .toggle-description {
            font-size: 0.9rem;
            color: white;
            text-align: left;
            flex: 1;
        }

        /* Custom styles for settings buttons */
        #clearCurrentDayBtn {
            color: #d19e1c !important;
            border: 2px solid #d19e1c !important;
            background: #e7e7a1 !important;
            opacity: 0.7;
        }

        #clearCurrentDayBtn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        #clearAllDataBtn {
            color: #B22222 !important;
            border: 2px solid #B22222 !important;
            background: #ff7777 !important;
            opacity: 0.7;
        }

        #clearAllDataBtn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        #lightThemeBtn {
            color: #f5f5f5 !important;
            border: 2px solid #ffffff !important;
            border-radius: 6px;
            background: #c4c4c4 !important;
            opacity: 0.7;
            padding: 4px 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px var(--shadow-color)
               
        }

        #lightThemeBtn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        #darkThemeBtn {
            color: #202020 !important;
            border: 2px solid #202020 !important;
            background: #5e5e5e !important;
            border-radius: 6px;
            padding: 4px 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px var(--shadow-color);
            cursor: pointer;
            opacity: 0.7;
        }

        #darkThemeBtn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        #startingBalanceValue {
            background-color: #0091ca5e !important; /*  blue background */
        }

        /* Добавьте этот CSS в раздел с другими стилями кнопок настроек */
        #exportSettingsBtn {
            background: #28a745 !important;
            color: #fff !important;
            border: 2px solid #28a745 !important;
            border-radius: 6px;
            padding: 4px 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px var(--shadow-color);
            cursor: pointer;
            opacity: 0.7;
            width: 100%;
            margin: 5px 0;
        }

        #exportSettingsBtn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        
        /* Header actions */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            white-space: nowrap;
        }

        /* Export modal styles */
        .export-period {
            margin: 15px 0;
        }

        .period-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .period-row label {
            min-width: 50px;
            color: var(--text-color);
            font-weight: 500;
        }

        .date-input {
            flex: 1;
            padding: 8px;
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .export-tabs {
            display: flex;
            margin: 15px 0;
            background: var(--tab-bg);
            border-radius: 8px;
            overflow: hidden;
        }

        .export-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--button-text-color);
            font-size: 0.8rem;
            background: var(--hint-color);
        }

        .export-tab.active {
            background: var(--tab-active-bg);
            color: var(--button-text-color);
        }

        .export-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            font-size: 0.8rem;
            color: #856404;
            font-weight: 500;
        }

        [data-theme="dark"] .export-warning {
            background: #332701;
            border-color: #665c00;
            color: #f1c40f;
        }

        .export-warning span {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        #openGuideBtn {
            background: #7f36f4;
            color: #fff;
            border: 2px solid #5f36f4;
            border-radius: 6px;
            padding: 4px 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px var(--shadow-color);
            cursor: pointer;
            opacity: 0.7;
        }

        #openGuideBtn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .button-wrapper {
            display: flex;
            justify-content: center; /* Центрируем по горизонтали */
            align-items: center;     /* Центрируем по вертикали (если есть высота) */
            padding: 5px 5px;           /* Отступы вокруг, чтобы сияние не обрезалось */
            text-align: center;
            /* Можно задать ширину/высоту, если нужно */
            width: 100%; 
            box-sizing: border-box;
        }

        #myLink {
            position: relative;
            text-decoration: none;
            border-radius: 12px;
            background-color: var(--border-color);
            padding: 2px;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
            margin: 0;
            line-height: normal;
        }

        #myLink::before {
            content: "";
            position: absolute;
            top: 0;
            left: -150%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                var(--shine-fade),
                var(--shine-color),
                var(--shine-fade), 
                transparent
            );
            transform: skewX(-20deg);
            animation: sborder-shine 2s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        #myLink span {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-color); 
            font-weight: 700;
            text-transform: uppercase;
            font-size: 16px;
            letter-spacing: 1.5px;
            padding: 16px 40px;
            border-radius: 10px;
            z-index: 1;
            transition: background-color 0.3s, color 0.3s;
        }

        .shiny-text {
            /* Создаем градиент: Основной цвет -> Белый блик -> Основной цвет */
            background: linear-gradient(
                110deg,
                var(--shine-fade) 40%,
                var(--shine-color) 50%,  
                var(--shine-fade) 60%
            );
            
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: text-shine-anim 2s linear infinite;
        }

        @keyframes sborder-shine {
            0%  {
                left: -150%;
            }
            50% {
                left: 150%;
            }
            100% {
                left: 150%;
            }
        }

        @keyframes text-shine-anim {
            0% { background-position: 200% center; }
            100% { background-position: -200% center; }
        }

    </style>
</head>
<body>

    
    <!-- Modal for trade result -->
    <div class="modal" id="resultModal" role="dialog" aria-labelledby="resultModalTitle" aria-hidden="true">
        <div class="modal-content">
            <h2 class="modal-title" id="resultModalTitle">Select Trade Result</h2>
            <input type="text" class="amount-input" id="amountInput" placeholder="Enter amount" pattern="^[0-9]+([,.][0-9]+)*$" inputmode="decimal">
            <div class="modal-buttons">
                <button class="modal-btn profit-btn" data-value="profit">Profit</button>
                <button class="modal-btn loss-btn" data-value="loss">Loss</button>
                <button class="modal-btn refund-btn" data-value="refund">Refund</button>
                <button class="modal-btn reset-btn" data-value="reset">Reset</button>
            </div>
        </div>
    </div>

    <!-- Modal for trade amount -->
    <div class="modal" id="tradeAmountModal">
        <div class="modal-content">
            <h2 class="modal-title">Enter Trade Amount</h2>
            <input type="text" class="amount-input" id="tradeAmountInput" placeholder="Enter amount" pattern="^[0-9]+([,.][0-9]+)*$" inputmode="decimal">
            <div class="modal-buttons">
                <button class="modal-btn profit-btn" id="saveTradeAmountBtn">Save</button>
                <button class="modal-btn reset-btn" id="cancelTradeAmountBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for withdrawal -->
    <div class="modal" id="withdrawalModal">
        <div class="modal-content">
            <h2 class="modal-title">Enter Withdrawal Amount</h2>
            <input type="number" class="amount-input" id="withdrawalAmountInput" placeholder="Enter amount" step="0.01">
            <div class="modal-buttons">
                <button class="modal-btn profit-btn" id="saveWithdrawalBtn">Save</button>
                <button class="modal-btn reset-btn" id="cancelWithdrawalBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for withdrawal actions -->
    <div class="withdrawal-action-modal" id="withdrawalActionModal">
        <div class="withdrawal-action-content">
            <h2 class="modal-title">Withdrawal Action</h2>
            <div class="withdrawal-action-buttons">
                <button class="withdrawal-action-btn edit-btn" id="editWithdrawalBtn">Edit</button>
                <button class="withdrawal-action-btn delete-btn" id="deleteWithdrawalBtn">Delete</button>
                <button class="withdrawal-action-btn reset-btn" id="cancelWithdrawalActionBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for emotions -->
    <div class="modal" id="emotionModal">
        <div class="modal-content emotion-modal-content">
            <h2 class="modal-title">Select Emotional State</h2>
            <div class="emotion-options">
                <div class="emotion-option" data-emotion="fear">
                    <div class="emotion-emoji">😰</div>
                    <div class="emotion-label">Fear</div>
                </div>
                <div class="emotion-option" data-emotion="greed">
                    <div class="emotion-emoji">😵</div>
                    <div class="emotion-label">Greed</div>
                </div>
                <div class="emotion-option" data-emotion="joy">
                    <div class="emotion-emoji">🥳</div>
                    <div class="emotion-label">Joy</div>
                </div>
                <div class="emotion-option" data-emotion="concentration">
                    <div class="emotion-emoji">😌</div>
                    <div class="emotion-label">Concentration</div>
                </div>
                <div class="emotion-option" data-emotion="sadness">
                    <div class="emotion-emoji">😕</div>
                    <div class="emotion-label">Sadness</div>
                </div>
                <div class="emotion-option" data-emotion="excitement">
                    <div class="emotion-emoji">🤩</div>
                    <div class="emotion-label">Excitement</div>
                </div>
                <div class="emotion-option" data-emotion="impulsiveness">
                    <div class="emotion-emoji">🫨</div>
                    <div class="emotion-label">Impulsiveness</div>
                </div>
                <div class="emotion-option" data-emotion="anger">
                    <div class="emotion-emoji">😡</div>
                    <div class="emotion-label">Anger</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn reset-btn" id="clearEmotionBtn">Clear</button>
            </div>
        </div>
    </div>

    <!-- Modal for comments -->
    <div class="modal" id="commentsModal">
        <div class="modal-content comments-modal-content">
            <h2 class="modal-title">Add Comment</h2>
            <textarea class="comments-textarea" id="commentsInput" placeholder="Enter comment..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn profit-btn" id="saveCommentBtn">Save</button>
                <button class="modal-btn reset-btn" id="cancelCommentBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for setting balance -->
    <div class="modal" id="balanceModal">
        <div class="modal-content">
            <h2 class="modal-title">Set Starting Balance</h2>
            <input type="number" class="balance-input" id="balanceInput" placeholder="Enter balance" step="0.01">
            <div class="modal-buttons">
                <button class="modal-btn profit-btn" id="saveBalanceBtn">Save</button>
                <button class="modal-btn reset-btn" id="cancelBalanceBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for setting targets -->
    <div class="target-modal" id="targetModal">
        <div class="target-modal-content">
            <h2 class="modal-title" id="targetModalTitle">Set Target (%)</h2>
            <input type="text" class="target-input" id="targetInput" placeholder="Enter value in %" pattern="^[0-9.,-]+$" inputmode="decimal">
            <div class="target-modal-buttons">
                <button class="target-modal-btn" id="applyToDayBtn">Day Only</button>
                <button class="target-modal-btn" id="applyToAllBtn">All Days</button>
                <button class="target-modal-btn" id="cancelTargetBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for export -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <h2 class="modal-title">Export to Excel</h2>
            <div class="export-warning">
                <span>⚠️ Export works only on Telegram Desktop</span>
            </div>
            <div class="export-period">
                <div class="period-row">
                    <label>From:</label>
                    <input type="date" id="exportStartDate" class="date-input">
                </div>
                <div class="period-row">
                    <label>To:</label>
                    <input type="date" id="exportEndDate" class="date-input">
                </div>
            </div>
            <div class="export-tabs">
                <div class="export-tab active" data-tab="table">Daily</div>
                <div class="export-tab" data-tab="general">Monthly</div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn profit-btn" id="saveExportBtn">Export</button>
                <button class="modal-btn reset-btn" id="cancelExportBtn">Cancel</button>
            </div>
        </div>
    </div>
    <!-- Modal for Monthly tab cells -->
    <div class="modal" id="monthlyCellModal">
        <div class="modal-content">
            <h2 class="modal-title">Information</h2>
            <p>This cell is filled in automatically from the Daily tab based on trading statistics.</p>
            <div class="modal-buttons">
                <button class="modal-btn profit-btn" id="monthlyModalOkBtn">OK</button>
                <button class="modal-btn" id="monthlyModalDailyBtn" style="background: var(--button-color); color: var(--button-text-color);">Daily</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>
    
    <script class="trading-diary-script">
        console.log('Trading Diary script loaded');
        // Initialize Telegram Web App
        let tg = window.Telegram?.WebApp;
        console.log('Telegram WebApp object:', tg);
        
        document.addEventListener('DOMContentLoaded', function() {
            // Theme management
            function updateTheme() {
                const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark
                console.log('updateTheme called, savedTheme:', savedTheme);
                if (savedTheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
                console.log('Applied theme: ' + savedTheme);
                console.log('data-theme attribute after updateTheme:', document.documentElement.getAttribute('data-theme'));
                setTimeout(logStartingBalanceStyles, 500);
                setTimeout(logCommentStyles, 500);
            }

            function switchTheme(theme) {
                console.log('switchTheme called with theme:', theme);
                if (theme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
                localStorage.setItem('theme', theme);
                console.log('Switched to ' + theme + ' theme');
                console.log('data-theme attribute set to:', document.documentElement.getAttribute('data-theme'));
                updateTheme();
                updateProgressBar(); // Обновляем прогресс-бар при переключении темы
                console.log('Progress bar updated after theme switch');
                // Обновляем стили для открытых модалей
                const openModals = document.querySelectorAll('.modal[style*="display: flex"], .target-modal[style*="display: flex"], .withdrawal-action-modal[style*="display: flex"]');
                openModals.forEach(modal => {
                    modal.style.background = getComputedStyle(document.documentElement).getPropertyValue('--modal-bg');
                    modal.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
                });
            }

            // Initial theme setup
            updateTheme();

            // Expand the app to full screen
            if (tg && tg.expand) {
                tg.expand();
            }
            
            // Elements
            const tradingTable = document.getElementById('tradingTable');
            const resultModal = document.getElementById('resultModal');
            const tradeAmountModal = document.getElementById('tradeAmountModal');
            const withdrawalModal = document.getElementById('withdrawalModal');
            const withdrawalActionModal = document.getElementById('withdrawalActionModal');
            const emotionModal = document.getElementById('emotionModal');
            const commentsModal = document.getElementById('commentsModal');
            const balanceModal = document.getElementById('balanceModal');
            const historyTable = document.getElementById('historyTable');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const notification = document.getElementById('notification');
            const amountInput = document.getElementById('amountInput');
            const tradeAmountInput = document.getElementById('tradeAmountInput');
            const withdrawalAmountInput = document.getElementById('withdrawalAmountInput');
            const balanceInput = document.getElementById('balanceInput');
            const prevDayBtn = document.getElementById('prevDayBtn');
            const currentDayLabel = document.getElementById('currentDayLabel');
            const nextDayBtn = document.getElementById('nextDayBtn');
            const addTradeBtn = document.getElementById('addTradeBtn');
            const addWithdrawalBtn = document.getElementById('addWithdrawalBtn');
            const monthCommentsInput = document.getElementById('monthCommentsInput');
            
            // Progress elements
            const progressFill = document.getElementById('progressFill');
            const progressStart = document.getElementById('progressStart');
            const progressCurrent = document.getElementById('progressCurrent');
            const progressTarget = document.getElementById('progressTarget');
            
            // Balance elements
            const startingBalanceValue = document.getElementById('startingBalanceValue');
            const currentBalanceValue = document.getElementById('currentBalanceValue');
            const dayResultValue = document.getElementById('dayResultValue');
            const saveBalanceBtn = document.getElementById('saveBalanceBtn');
            const cancelBalanceBtn = document.getElementById('cancelBalanceBtn');
            
            // Clear buttons
            const clearCurrentDayBtn = document.getElementById('clearCurrentDayBtn');
            const clearAllDataBtn = document.getElementById('clearAllDataBtn');
            
            // Elements for General tab
            const currentGeneralDate = document.getElementById('currentGeneralDate');
            const generalTable = document.getElementById('generalTable');
            const saveWithdrawalBtn = document.getElementById('saveWithdrawalBtn');
            const cancelWithdrawalBtn = document.getElementById('cancelWithdrawalBtn');
            const withdrawalTable = document.getElementById('withdrawalTable');
            const targetModal = document.getElementById('targetModal');
            const targetModalTitle = document.getElementById('targetModalTitle');
            const targetInput = document.getElementById('targetInput');
            const applyToDayBtn = document.getElementById('applyToDayBtn');
            const applyToAllBtn = document.getElementById('applyToAllBtn');
            const cancelTargetBtn = document.getElementById('cancelTargetBtn');

            // Elements for emotion and comment modals
            const clearEmotionBtn = document.getElementById('clearEmotionBtn');
            const commentsInput = document.getElementById('commentsInput');
            const saveCommentBtn = document.getElementById('saveCommentBtn');
            const cancelCommentBtn = document.getElementById('cancelCommentBtn');

            // Elements for percentage indicator
            const percentageIndicator = document.getElementById('percentageIndicator');
            const indicatorArrow = document.getElementById('indicatorArrow');
            const indicatorPercentage = document.getElementById('indicatorPercentage');
            const balanceAmount = document.querySelector('.balance-amount');

            console.log('Percentage indicator elements initialized:');
            console.log('percentageIndicator:', percentageIndicator);
            console.log('indicatorArrow:', indicatorArrow);
            console.log('indicatorPercentage:', indicatorPercentage);
            console.log('balanceAmount:', balanceAmount);

            // Elements for trade amount modal
            const saveTradeAmountBtn = document.getElementById('saveTradeAmountBtn');
            const cancelTradeAmountBtn = document.getElementById('cancelTradeAmountBtn');

            // Elements for withdrawal action modal
            const editWithdrawalBtn = document.getElementById('editWithdrawalBtn');
            const deleteWithdrawalBtn = document.getElementById('deleteWithdrawalBtn');
            const cancelWithdrawalActionBtn = document.getElementById('cancelWithdrawalActionBtn');

            // New elements for General tab navigation
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const currentMonthLabel = document.getElementById('currentMonthLabel');
            const nextMonthBtn = document.getElementById('nextMonthBtn');

            // State
            let currentDate = new Date();
            let trades = [];
            let currentCell = null;
            let currentTradeIndex = null;
            let currentColumnType = null;
            let tradeData = {};
            let historyData = JSON.parse(localStorage.getItem('tradeHistory')) || {};
            let generalData = JSON.parse(localStorage.getItem('generalData')) || {};
            let withdrawalData = JSON.parse(localStorage.getItem('withdrawalData')) || {};
            let monthCommentsData = JSON.parse(localStorage.getItem('monthCommentsData')) || {};
            let appSettings = JSON.parse(localStorage.getItem('appSettings')) || {
                initialBalance: 10000,
                startingBalance: 10000,
                currentBalance: 10000
            };
            
            // Emotion mapping
            const emotionMap = {
                'fear': '😰 Fear',
                'greed': '😵 Greed',
                'joy': '🥳 Joy',
                'concentration': '😌 concentration',
                'sadness': '😕 sadness',
                'excitement': '🤩  excitement',
                'impulsiveness': '🫨 impulsiveness',
                'anger': '😡 anger'
            };
            
            // UI Settings
            let uiSettings = JSON.parse(localStorage.getItem('uiSettings')) || {
                showProgressBar: true
            };

            // Variables for target management
            let currentTargetDay = null;
            let currentTargetType = null;

            // Variables for withdrawal management
            let currentWithdrawalDate = null;
            let currentWithdrawalIndex = null;
            let isEditingWithdrawal = false;

            // Variables for General tab month navigation
            let currentGeneralYear, currentGeneralMonth;
            
            // Initialize
            function init() {
                console.log('Initializing trading diary app');

                // Initialize General tab
                initGeneralTab();

                // Load balance settings
                if (appSettings.startingBalance && balanceAmount) {
                    balanceAmount.textContent = formatNumber(appSettings.startingBalance);
                }
                
                console.log('Starting Balance element:', startingBalanceValue);
                console.log('Balance modal:', balanceModal);
                
                // Add global click listener for debugging
                document.addEventListener('click', (e) => {
                    console.log('Click on:', e.target);
                    console.log('Class:', e.target.className);
                });
                
                // Пересчитываем текущий баланс с учетом всех сделок и выводов
                recalculateCurrentBalance();
                
                const dateKey = formatDateKey(currentDate);
                if (historyData[dateKey]) {
                    // Исправление: глубокое копирование данных для дня
                    tradeData = JSON.parse(JSON.stringify(historyData[dateKey]));
                    trades = tradeData.trades || [];
                    renderTable();
                    updateDayResultForCurrentDate();
                } else {
                    initTrades();
                    renderTable();
                }
                
                
                renderHistory();
                
                // Initialize withdrawal table
                renderWithdrawalTable();
                
                // Load month comments
                loadMonthComments();
                
                // Update navigation buttons
                updateNavigationButtons();
                
                // Update current day label
                updateCurrentDayLabel();
                
                // Проверяем, можно ли редактировать текущую дату
                updateEditPermissions();
                
                // Initialize progress bar
                updateProgressBar();

                // Initialize progress bar visibility
                updateProgressBarVisibility();

                // Initialize percentage indicator
                console.log('About to call updatePercentageIndicator() during init');
                updatePercentageIndicator();
                console.log('updatePercentageIndicator() called during init');
                console.log('App initialized successfully');

                // Log Starting Balance styles after init
                setTimeout(logStartingBalanceStyles, 1000);
            }
            
            // Функция для добавления новой сделки без полной перерисовки
            function addTradeToTable() {
                const newTrade = {
                    tradeAmount: null,
                    result: null,
                    emotion: null,
                    comment: ''
                };

                trades.push(newTrade);

                const tbody = tradingTable.querySelector('tbody');
                const row = createTableRow(trades.length - 1, newTrade);
                tbody.appendChild(row);

                // Обновляем права доступа для ячеек
                updateEditPermissions();
                refreshAllDisplays();
                updatePercentageIndicator();
            }
            
            function saveTradeData() {
                // Сохраняем данные только если есть хотя бы одна заполненная сделка
                if (!hasDayData(trades)) {
                    const dateKey = formatDateKey(currentDate);
                    // Удаляем пустые данные из истории
                    delete historyData[dateKey];
                } else {
                    tradeData.trades = trades;
                    const dateKey = formatDateKey(currentDate);
                    historyData[dateKey] = JSON.parse(JSON.stringify(tradeData)); // Глубокое копирование
                }
                
                localStorage.setItem('tradeHistory', JSON.stringify(historyData));
            }
            
            function saveSettings() {
                localStorage.setItem('appSettings', JSON.stringify(appSettings));
            }
            
            function saveUISettings() {
                localStorage.setItem('uiSettings', JSON.stringify(uiSettings));
            }

            // Функция для проверки, есть ли в дне какие-либо данные
            function hasDayData(dayTrades) {
                if (!dayTrades || dayTrades.length === 0) return false;
                
                for (let i = 0; i < dayTrades.length; i++) {
                    const trade = dayTrades[i];
                    if (trade.tradeAmount !== null || trade.result !== null || 
                        trade.emotion !== null || (trade.comment && trade.comment !== '')) {
                        return true;
                    }
                }
                return false;
            }

            // Функция для пересчета текущего баланса с учетом всех сделок и выводов
            function recalculateCurrentBalance() {
                let totalProfitLoss = 0;
                let totalWithdrawals = 0;
                
                // Суммируем все прибыли/убытки из истории
                Object.keys(historyData).forEach(dateKey => {
                    const dayData = historyData[dateKey];
                    if (dayData.trades) {
                        dayData.trades.forEach(trade => {
                            if (trade.result) {
                                if (trade.result.type === 'profit') {
                                    totalProfitLoss += trade.result.amount;
                                } else if (trade.result.type === 'loss') {
                                    totalProfitLoss -= trade.result.amount;
                                }
                            }
                        });
                    }
                });
                
                // Суммируем все выводы
                Object.keys(withdrawalData).forEach(dateKey => {
                    withdrawalData[dateKey].forEach(withdrawal => {
                        totalWithdrawals += withdrawal.amount;
                    });
                });
                
                // Обновляем текущий баланс
                appSettings.currentBalance = appSettings.startingBalance + totalProfitLoss - totalWithdrawals;
                
                // ВСЕГДА обновляем отображение
                if (currentBalanceValue) {
                    currentBalanceValue.textContent = formatNumber(appSettings.currentBalance);
                }
                
                saveSettings();
                
                return appSettings.currentBalance;
            }

            // Функция для обновления результата дня для текущей даты
            function updateDayResultForCurrentDate() {
                if (!dayResultValue) return;

                let dayTotal = 0;
                // Используем текущие данные trades вместо historyData для мгновенного обновления
                for (let i = 0; i < trades.length; i++) {
                    const trade = trades[i];
                    if (trade.result !== null) {
                        const amount = trade.result.amount;
                        const type = trade.result.type;

                        if (type === 'profit') {
                            dayTotal += amount;
                        } else if (type === 'loss') {
                            dayTotal -= amount;
                        }
                    }
                }

                dayResultValue.textContent = formatNumber(dayTotal);
                if (dayTotal > 0) {
                    dayResultValue.classList.add('positive');
                    dayResultValue.classList.remove('negative');
                } else if (dayTotal < 0) {
                    dayResultValue.classList.add('negative');
                    dayResultValue.classList.remove('positive');
                } else {
                    dayResultValue.classList.remove('positive', 'negative');
                }

                // Обновляем процентный индикатор при изменении результата дня
                updatePercentageIndicator();

                // Сохраняем данные
                saveTradeData();
            }
            
            // Функция для обновления отображения результата дня
            function updateDayResultDisplay() {
                if (!dayResultValue) return;
                
                const dateKey = formatDateKey(currentDate);
                const dayData = historyData[dateKey];
                
                if (dayData && dayData.trades) {
                    let dayTotal = 0;
                    for (let i = 0; i < dayData.trades.length; i++) {
                        const trade = dayData.trades[i];
                        if (trade.result !== null) {
                            const amount = trade.result.amount;
                            const type = trade.result.type;
                            
                            if (type === 'profit') {
                                dayTotal += amount;
                            } else if (type === 'loss') {
                                dayTotal -= amount;
                            }
                        }
                    }
                    
                    dayResultValue.textContent = formatNumber(dayTotal);
                    if (dayTotal > 0) {
                        dayResultValue.classList.add('positive');
                        dayResultValue.classList.remove('negative');
                    } else if (dayTotal < 0) {
                        dayResultValue.classList.add('negative');
                        dayResultValue.classList.remove('positive');
                    } else {
                        dayResultValue.classList.remove('positive', 'negative');
                    }
                } else {
                    dayResultValue.textContent = '0';
                    dayResultValue.classList.remove('positive', 'negative');
                }
            }

            // Получить сегодняшнюю дату в локальном часовом поясе
            function getToday() {
                const now = new Date();
                return new Date(now.getFullYear(), now.getMonth(), now.getDate());
            }

            // Форматирование даты в локальном часовом поясе
            function formatDate(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            }
            
            // Форматирование ключа даты в локальном часовом поясе
            function formatDateKey(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // Парсинг ключа даты в локальном часовом поясе
            function parseDateKey(dateKey) {
                const [year, month, day] = dateKey.split('-').map(Number);
                return new Date(year, month - 1, day);
            }
            
            function formatNumber(amount) {
                // Проверяем, является ли число целым
                if (Number.isInteger(amount)) {
                    return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(amount);
                } else {
                    // Для дробных чисел сохраняем значимые цифры
                    return new Intl.NumberFormat('en-US', { maximumFractionDigits: 10 }).format(amount);
                }
            }
            
            function initTrades() {
                trades = [];
                for (let i = 0; i < 5; i++) {
                    trades.push({
                        tradeAmount: null,
                        result: null,
                        emotion: null,
                        comment: ''
                    });
                }
                tradeData.trades = trades;
            }
            
            function renderTable() {
                if (!tradingTable) return;
                
                const tbody = tradingTable.querySelector('tbody');
                
                if (!tbody) return;
                
                // Очищаем таблицу только если это первоначальная отрисовка или количество сделок изменилось
                if (tbody.children.length !== trades.length) {
                    tbody.innerHTML = '';
                    
                    for (let i = 0; i < trades.length; i++) {
                        const row = createTableRow(i, trades[i]);
                        tbody.appendChild(row);
                    }
                } else {
                    // Обновляем только измененные ячейки
                    for (let i = 0; i < trades.length; i++) {
                        updateTableRow(tbody.children[i], i, trades[i]);
                    }
                }
                
                // Обновляем права доступа для ячеек
                updateEditPermissions();
            }
            
            // Создание строки таблицы
            function createTableRow(index, trade) {
                const row = document.createElement('tr');
                
                const tradeCell = document.createElement('td');
                tradeCell.textContent = index + 1;
                tradeCell.className = 'trade-header';
                row.appendChild(tradeCell);
                
                const tradeAmountCell = document.createElement('td');
                tradeAmountCell.className = 'cell';

                if (trade.tradeAmount !== null && trade.tradeAmount !== 0) {
                    tradeAmountCell.textContent = formatNumber(trade.tradeAmount);
                    if (trade.tradeAmount > 0) {
                        tradeAmountCell.classList.add('summa');
                    }
                } else {
                    tradeAmountCell.textContent = 'Click to enter amount';
                    tradeAmountCell.style.color = 'var(--hint-color)';
                    tradeAmountCell.style.fontStyle = 'italic';
                }
                
                tradeAmountCell.addEventListener('click', () => {
                    // Проверяем, можно ли редактировать эту дату
                    if (!canEditCurrentDate()) return;
                    
                    currentCell = tradeAmountCell;
                    currentTradeIndex = index;
                    currentColumnType = 'amount';
                    if (tradeAmountInput) tradeAmountInput.value = (trade.tradeAmount && trade.tradeAmount !== 0) ? trade.tradeAmount : '';
                    if (tradeAmountModal) tradeAmountModal.style.display = 'flex';
                });
                
                row.appendChild(tradeAmountCell);
                
                const resultCell = document.createElement('td');
                resultCell.className = 'cell';

                if (trade.result !== null) {
                    const amount = trade.result.amount;
                    const type = trade.result.type;

                    if (type === 'profit') {
                        resultCell.className += ' profit';
                        if (amount > 0) {
                            resultCell.classList.add('amount-positive');
                        } else if (amount < 0) {
                            resultCell.classList.add('amount-negative');
                        } else {
                            resultCell.classList.add('amount-zero');
                        }
                        resultCell.innerHTML = `<div class="cell-content">+${formatNumber(amount)}</div>`;
                    } else if (type === 'loss') {
                        resultCell.className += ' loss';
                        if (amount > 0) {
                            resultCell.classList.add('amount-negative');
                        } else if (amount < 0) {
                            resultCell.classList.add('amount-positive');
                        } else {
                            resultCell.classList.add('amount-zero');
                        }
                        resultCell.innerHTML = `<div class="cell-content">-${formatNumber(amount)}</div>`;
                    } else if (type === 'refund') {
                        resultCell.className += ' refund';
                        if (amount > 0) {
                            resultCell.classList.add('amount-positive');
                        } else if (amount < 0) {
                            resultCell.classList.add('amount-negative');
                        } else {
                            resultCell.classList.add('amount-zero');
                        }
                        if (amount > 0) {
                            resultCell.innerHTML = `<div class="cell-content">Refund: ${formatNumber(amount)}</div>`;
                        } else {
                            resultCell.innerHTML = `<div class="cell-content">Refund</div>`;
                        }
                    }
                }
                
                resultCell.addEventListener('click', () => {
                    // Проверяем, можно ли редактировать эту дату
                    if (!canEditCurrentDate()) return;
                    
                    currentCell = resultCell;
                    currentTradeIndex = index;
                    currentColumnType = 'result';
                    if (amountInput) amountInput.value = '';
                    if (resultModal) resultModal.style.display = 'flex';
                });
                
                row.appendChild(resultCell);
                
                const emotionCell = document.createElement('td');
                emotionCell.className = 'cell emotion-cell';
                
                if (trade.emotion !== null) {
                    emotionCell.textContent = trade.emotion;
                }
                
                emotionCell.addEventListener('click', () => {
                    // Проверяем, можно ли редактировать эту дату
                    if (!canEditCurrentDate()) return;
                    
                    currentCell = emotionCell;
                    currentTradeIndex = index;
                    currentColumnType = 'emotion';
                    if (emotionModal) emotionModal.style.display = 'flex';
                });
                
                row.appendChild(emotionCell);
                
                const commentsCell = document.createElement('td');
                commentsCell.className = 'cell comments-cell';
                
                if (trade.comment !== '') {
                    commentsCell.textContent = trade.comment;
                } else {
                    commentsCell.textContent = 'Click to add comment';
                    commentsCell.style.color = 'var(--hint-color)';
                    commentsCell.style.fontStyle = 'italic';
                }
                
                commentsCell.addEventListener('click', () => {
                    // Проверяем, можно ли редактировать эту дату
                    if (!canEditCurrentDate()) return;
                    
                    currentCell = commentsCell;
                    currentTradeIndex = index;
                    currentColumnType = 'comments';
                    if (commentsInput) commentsInput.value = trade.comment || '';
                    if (commentsModal) commentsModal.style.display = 'flex';
                });
                
                row.appendChild(commentsCell);
                
                return row;
            }
            
            // Обновление строки таблицы
            function updateTableRow(row, index, trade) {
                const cells = row.cells;
                
                // Обновляем ячейку с номером сделки
                cells[0].textContent = index + 1;
                
                // Обновляем ячейку с суммой сделки
                const tradeAmountCell = cells[1];
                tradeAmountCell.className = 'cell';
                if (trade.tradeAmount !== null && trade.tradeAmount !== 0) {
                    tradeAmountCell.textContent = formatNumber(trade.tradeAmount);
                    tradeAmountCell.style.color = '';
                    tradeAmountCell.style.fontStyle = '';
                    if (trade.tradeAmount > 0) {
                        tradeAmountCell.classList.add('summa');
                    }
                } else {
                    tradeAmountCell.textContent = 'Click to enter amount';
                    tradeAmountCell.style.color = 'var(--hint-color)';
                    tradeAmountCell.style.fontStyle = 'italic';
                }
                
                // Обновляем ячейку с результатом
                const resultCell = cells[2];
                resultCell.className = 'cell';

                if (trade.result !== null) {
                    const amount = trade.result.amount;
                    const type = trade.result.type;

                    if (type === 'profit') {
                        resultCell.className += ' profit';
                        if (amount > 0) {
                            resultCell.classList.add('amount-positive');
                        } else if (amount < 0) {
                            resultCell.classList.add('amount-negative');
                        } else {
                            resultCell.classList.add('amount-zero');
                        }
                        resultCell.innerHTML = `<div class="cell-content">+${formatNumber(amount)}</div>`;
                    } else if (type === 'loss') {
                        resultCell.className += ' loss';
                        if (amount > 0) {
                            resultCell.classList.add('amount-negative');
                        } else if (amount < 0) {
                            resultCell.classList.add('amount-positive');
                        } else {
                            resultCell.classList.add('amount-zero');
                        }
                        resultCell.innerHTML = `<div class="cell-content">-${formatNumber(amount)}</div>`;
                    } else if (type === 'refund') {
                        resultCell.className += ' refund';
                        if (amount > 0) {
                            resultCell.classList.add('amount-positive');
                        } else if (amount < 0) {
                            resultCell.classList.add('amount-negative');
                        } else {
                            resultCell.classList.add('amount-zero');
                        }
                        if (amount > 0) {
                            resultCell.innerHTML = `<div class="cell-content">Refund: ${formatNumber(amount)}</div>`;
                        } else {
                            resultCell.innerHTML = `<div class="cell-content">Refund</div>`;
                        }
                    }
                } else {
                    resultCell.innerHTML = '';
                }
                
                // Обновляем ячейку с эмоциями
                const emotionCell = cells[3];
                emotionCell.className = 'cell emotion-cell';
                if (trade.emotion !== null) {
                    emotionCell.textContent = emotionMap[trade.emotion] || trade.emotion;
                } else {
                    emotionCell.textContent = '';
                }
                
                // Обновляем ячейку с комментариями
                const commentsCell = cells[4];
                commentsCell.className = 'cell comments-cell';
                if (trade.comment !== '') {
                    commentsCell.textContent = trade.comment;
                } else {
                    commentsCell.textContent = 'Click to add comment';
                    commentsCell.style.color = 'var(--hint-color)';
                    commentsCell.style.fontStyle = 'italic';
                }
            }
            
            function updateTotal() {
                let total = 0;
                let winTrades = 0;
                let lossTrades = 0;

                for (let i = 0; i < trades.length; i++) {
                    const trade = trades[i];
                    if (trade.result !== null) {
                        const amount = trade.result.amount;
                        const type = trade.result.type;

                        if (type === 'profit') {
                            total += amount;
                            winTrades++;
                        } else if (type === 'loss') {
                            total -= amount;
                            lossTrades++;
                        }
                    }
                }

                // Обновляем результат дня только если это сегодняшний день
                updateDayResultForCurrentDate();

                // Пересчитываем общий баланс с учетом всех сделок и выводов
                recalculateCurrentBalance();

                // Update progress bar
                updateProgressBar();

                // Update percentage indicator
                updatePercentageIndicator();

                const startingBalance = appSettings.startingBalance;
                const profitLossPercent = startingBalance > 0 ? (total / startingBalance) * 100 : 0;

                const dateKey = formatDateKey(currentDate);
                if (!generalData[dateKey]) {
                    generalData[dateKey] = {};
                }

                generalData[dateKey].actualProfitLoss = profitLossPercent;
                generalData[dateKey].winTrades = winTrades;
                generalData[dateKey].lossTrades = lossTrades;

                localStorage.setItem('generalData', JSON.stringify(generalData));

                // Auto save data только если есть данные
                if (hasDayData(trades)) {
                    saveTradeData();
                }

                updateGeneralTable();
                renderHistory();
            }
            
            // Функция для обновления всех данных при изменении в таблице
            function refreshAllDisplays() {
                recalculateCurrentBalance();
                updateDayResultForCurrentDate();
                renderTable();
                renderHistory();
                updateGeneralTable();
                updateProgressBar();
                updatePercentageIndicator();

                // Добавьте сохранение данных
                saveTradeData();
            }
            
            function saveGeneralData() {
                localStorage.setItem('generalData', JSON.stringify(generalData));
            }
            
            function saveWithdrawalData() {
                localStorage.setItem('withdrawalData', JSON.stringify(withdrawalData));
            }
            
            function saveMonthCommentsData() {
                localStorage.setItem('monthCommentsData', JSON.stringify(monthCommentsData));
            }
            
            function updateProgressBarVisibility() {
                const progressBarContainer = document.querySelector('.progress-container');
                if (progressBarContainer) {
                    if (uiSettings.showProgressBar) {
                        progressBarContainer.style.display = 'block';
                    } else {
                        progressBarContainer.style.display = 'none';
                    }
                }
            }
            
            function loadDateData(date) {
                // Сохраняем данные текущего дня перед переходом только если есть данные
                if (hasDayData(trades)) {
                    saveTradeData();
                }
                
                const today = getToday();
                const selectedDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                
                // Prevent navigation to future dates
                if (selectedDate > today) {
                    showNotification("Cannot view future dates", "error");
                    return;
                }
                
                currentDate = date;

                const dateKey = formatDateKey(currentDate);
                
                if (historyData[dateKey]) {
                    // Исправление: глубокое копирование данных для дня
                    tradeData = JSON.parse(JSON.stringify(historyData[dateKey]));
                    trades = tradeData.trades || [];
                } else {
                    tradeData = {};
                    initTrades();
                }
                
                renderTable();
                
                // Update current day label
                updateCurrentDayLabel();
                
                // Calculate balance for the selected day only (don't update the displayed balances)
                let total = 0;
                for (let i = 0; i < trades.length; i++) {
                    const trade = trades[i];
                    if (trade.result !== null) {
                        const amount = trade.result.amount;
                        const type = trade.result.type;
                        
                        if (type === 'profit') {
                            total += amount;
                        } else if (type === 'loss') {
                            total -= amount;
                        }
                    }
                }
                
                // Обновляем результат дня для выбранной даты
                updateDayResultForCurrentDate();
                
                // Обновляем цвет ячейки day result в таблице General
                updateGeneralTable();
                
                // Update progress bar
                updateProgressBar();

                // Update progress bar visibility
                updateProgressBarVisibility();

                // Update percentage indicator
                updatePercentageIndicator();

                // Добавьте сохранение данных
                saveTradeData();

                renderHistory();
                updateGeneralTable();
                updateNavigationButtons();
                updateEditPermissions();

                // Обновляем цвет ячейки day result в баланс-панели при навигации
                updateDayResultDisplay();
            }
            
            // Функция для обновления метки текущего дня
            function updateCurrentDayLabel() {
                if (!currentDayLabel) return;
                
                const today = getToday();
                const current = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
                
                if (current.getTime() === today.getTime()) {
                    currentDayLabel.textContent = 'Today';
                } else {
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (current.getTime() === yesterday.getTime()) {
                        currentDayLabel.textContent = 'Yesterday';
                    } else {
                        currentDayLabel.textContent = formatDate(currentDate);
                    }
                }
            }
            
            // Функция для проверки, можно ли редактировать текущую дату
            function canEditCurrentDate() {
                const today = getToday();
                const current = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);

                return current.getTime() === today.getTime() || current.getTime() === yesterday.getTime();
            }
            
            // Функция для обновления прав доступа к редактированию
            function updateEditPermissions() {
                const canEdit = canEditCurrentDate();
                
                // Блокируем/разблокируем ячейки таблицы
                const cells = document.querySelectorAll('#tradingTable td.cell');
                cells.forEach(cell => {
                    if (canEdit) {
                        cell.classList.remove('disabled');
                    } else {
                        cell.classList.add('disabled');
                    }
                });
                
                // Блокируем/разблокируем кнопку добавления сделки
                if (addTradeBtn) {
                    addTradeBtn.disabled = !canEdit;
                }
            }
            
            function updateNavigationButtons() {
                const today = getToday();
                const current = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
                
                // Disable next day button if trying to go to future
                if (nextDayBtn) {
                    const nextDay = new Date(current);
                    nextDay.setDate(nextDay.getDate() + 1);
                    
                    if (nextDay > today) {
                        nextDayBtn.disabled = true;
                    } else {
                        nextDayBtn.disabled = false;
                    }
                }
            }
            
            function renderHistory() {
                if (!historyTable) return;
                
                const tbody = historyTable.querySelector('tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                const dates = Object.keys(historyData).sort().reverse();
                
                if (dates.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2" style="text-align: center;">No records in history</td></tr>';
                    return;
                }
                
                dates.forEach(dateKey => {
                    const data = historyData[dateKey];
                    let dayTotal = 0;
                    
                    if (data.trades) {
                        for (let i = 0; i < data.trades.length; i++) {
                            const trade = data.trades[i];
                            if (trade.result !== null) {
                                const amount = trade.result.amount;
                                const type = trade.result.type;
                                
                                if (type === 'profit') {
                                    dayTotal += amount;
                                } else if (type === 'loss') {
                                    dayTotal -= amount;
                                }
                            }
                        }
                    }
                    
                    const row = document.createElement('tr');
                    
                    const dateCell = document.createElement('td');
                    dateCell.textContent = formatDate(parseDateKey(dateKey));
                    row.appendChild(dateCell);
                    
                    const totalCell = document.createElement('td');
                    if (dayTotal > 0) totalCell.classList.add('positive');
                    else if (dayTotal < 0) totalCell.classList.add('negative');
                    totalCell.textContent = formatNumber(dayTotal);
                    row.appendChild(totalCell);
                    
                    tbody.appendChild(row);
                });
            }
            
            function showNotification(message, type) {
                if (!notification) return;

                // Disable all buttons during notification
                const allButtons = document.querySelectorAll('button:not(.modal-btn)');
                allButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                });

                // Укоротить сообщение до 6-8 слов
                const words = message.split(' ');
                const shortMessage = words.length > 8 ? words.slice(0, 8).join(' ') + '...' : message;

                notification.textContent = shortMessage;
                notification.className = `notification ${type}`;

                setTimeout(() => {
                    notification.className = 'notification';

                    // Re-enable all buttons after notification - восстанавливаем исходный opacity
                    allButtons.forEach(btn => {
                       btn.disabled = false;
                       const originalOpacity = btn.getAttribute('data-original-opacity');
                       if (originalOpacity !== null) {
                           btn.style.opacity = originalOpacity;
                           // Удаляем data-атрибут после восстановления
                           if (originalOpacity === '') {
                               btn.style.removeProperty('opacity');
                            }
                            btn.removeAttribute('data-original-opacity');
                        } else {
                            btn.style.opacity = ''; // Сбрасываем к CSS значению
                        }
                    });
                }, 1000);
            }
            
            // Functions for General tab
            function initGeneralTab() {
                const now = new Date();
                currentGeneralYear = now.getFullYear();
                currentGeneralMonth = now.getMonth();
                
                console.log('General tab initialized, currentGeneralYear: ' + currentGeneralYear + ', currentGeneralMonth: ' + currentGeneralMonth);
                if (currentGeneralDate) {
                    console.log('currentGeneralDate element: ' + currentGeneralDate.textContent);
                }
                
                updateGeneralNavigation();
                updateGeneralTable();
                renderWithdrawalTable();
                loadMonthComments();
                updateGeneralEditPermissions();
            }
            
            function updateGeneralNavigation() {
                const monthNames = [
                    "January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"
                ];
                
                if (currentMonthLabel) {
                    currentMonthLabel.textContent = monthNames[currentGeneralMonth];
                }
                
                if (currentGeneralDate) {
                    // currentGeneralDate.textContent = formatDate(new Date()); // Removed month label
                    console.log('Month label removed from General');
                }
                
                // Update month navigation buttons
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();
                
                if (nextMonthBtn) {
                    // Disable next month button if we're viewing current month
                    if (currentGeneralYear === currentYear && currentGeneralMonth === currentMonth) {
                        nextMonthBtn.disabled = true;
                    } else {
                        nextMonthBtn.disabled = false;
                    }
                }
            }
            
            function updateGeneralTable() {
                if (!generalTable) return;
                
                const tbody = generalTable.querySelector('tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                const daysInMonth = new Date(currentGeneralYear, currentGeneralMonth + 1, 0).getDate();
                
                const today = new Date();
                const currentDay = today.getDate();
                const currentMonthIndex = today.getMonth();
                const currentYearValue = today.getFullYear();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const row = document.createElement('tr');
                    
                    if (day === currentDay && currentGeneralMonth === currentMonthIndex && currentGeneralYear === currentYearValue) {
                        row.classList.add('current-day');
                    }
                    
                    const dayCell = document.createElement('td');
                    dayCell.textContent = day;
                    row.appendChild(dayCell);
                    
                    const profitTargetCell = document.createElement('td');
                    profitTargetCell.className = 'editable';
                    const profitTargetValue = getGeneralData(day, 'profitTarget') || '-';
                    profitTargetCell.textContent = profitTargetValue !== '-' ? profitTargetValue + '%' : '-';
                    profitTargetCell.dataset.day = day;
                    profitTargetCell.dataset.type = 'profit';
                    
                    // Add click event only if we can edit this month
                    if (canEditGeneralMonth()) {
                        profitTargetCell.addEventListener('click', handleTargetCellClick);
                    } else {
                        profitTargetCell.style.cursor = 'not-allowed';
                        profitTargetCell.style.opacity = '0.6';
                    }
                    
                    row.appendChild(profitTargetCell);
                    
                    const lossTargetCell = document.createElement('td');
                    lossTargetCell.className = 'editable';
                    const lossTargetValue = getGeneralData(day, 'lossTarget') || '-';
                    lossTargetCell.textContent = lossTargetValue !== '-' ? lossTargetValue + '%' : '-';
                    lossTargetCell.dataset.day = day;
                    lossTargetCell.dataset.type = 'loss';
                    
                    // Add click event only if we can edit this month
                    if (canEditGeneralMonth()) {
                        lossTargetCell.addEventListener('click', handleTargetCellClick);
                    } else {
                        lossTargetCell.style.cursor = 'not-allowed';
                        lossTargetCell.style.opacity = '0.6';
                    }
                    
                    row.appendChild(lossTargetCell);
                    
                    const actualCell = document.createElement('td');
                    const actualValue = getGeneralData(day, 'actualProfitLoss') || 0;
                    actualCell.textContent = actualValue !== 0 ? actualValue.toFixed(2) + '%' : '-';
                    if (actualValue > 0) {
                        actualCell.classList.add('positive');
                    } else if (actualValue < 0) {
                        actualCell.classList.add('negative');
                    }
                    row.appendChild(actualCell);
                    
                    const winTradesCell = document.createElement('td');
                    const winTrades = getGeneralData(day, 'winTrades') || 0;
                    winTradesCell.textContent = winTrades > 0 ? winTrades : '-';
                    row.appendChild(winTradesCell);
                    
                    const lossTradesCell = document.createElement('td');
                    const lossTrades = getGeneralData(day, 'lossTrades') || 0;
                    lossTradesCell.textContent = lossTrades > 0 ? lossTrades : '-';
                    row.appendChild(lossTradesCell);
                    
                    tbody.appendChild(row);
                }
                
                // Set up event delegation for monthly cell modal on the tbody
                // This ensures the event handlers work even for dynamically created cells
                const monthlyCellModal = document.getElementById('monthlyCellModal');
                
                // Function to handle cell click with event delegation
                function handleCellClick(e) {
                    // Check if the clicked element is a cell in the 4th, 5th, or 6th column (Actual P/L, Winning Trades, Losing Trades)
                    if (e.target.tagName === 'TD') {
                        const cellIndex = e.target.cellIndex;
                        if ((cellIndex === 3 || cellIndex === 4 || cellIndex === 5)) {
                            e.stopPropagation(); // Prevent event bubbling
                            if (monthlyCellModal) {
                                monthlyCellModal.style.display = 'flex';
                            }
                        }
                    }
                }
                
                // Remove any existing event listener to avoid duplicates
                tbody.removeEventListener('click', handleCellClick);
                
                // Add event listener to the tbody for event delegation
                tbody.addEventListener('click', handleCellClick);
            }
            
            function getGeneralData(day, field) {
                const dateKey = `${currentGeneralYear}-${String(currentGeneralMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                return generalData[dateKey] ? generalData[dateKey][field] : null;
            }
            
            function handleTargetCellClick(event) {
                // Check if we can edit this month
                if (!canEditGeneralMonth()) {
                    showNotification("Cannot edit past months", "error");
                    return;
                }
                
                const cell = event.target;
                const day = parseInt(cell.dataset.day);
                const type = cell.dataset.type;
                
                currentTargetDay = day;
                currentTargetType = type;
                
                if (targetModalTitle) {
                    targetModalTitle.textContent = `Set ${type === 'profit' ? 'profit target' : 'loss target'} for day ${day} (%)`;
                }
                
                if (targetInput) {
                    const cellText = cell.textContent;
                    targetInput.value = cellText !== '-' ? cellText.replace('%', '') : '';
                }
                
                if (targetModal) {
                    targetModal.style.display = 'flex';
                }
            }
            
            function canEditGeneralMonth() {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();
                
                // Can only edit current month
                return currentGeneralYear === currentYear && currentGeneralMonth === currentMonth;
            }
            
            function updateGeneralEditPermissions() {
                const canEdit = canEditGeneralMonth();
                
                // Update withdrawal button
                if (addWithdrawalBtn) {
                    if (canEdit) {
                        addWithdrawalBtn.disabled = false;
                        addWithdrawalBtn.style.opacity = '1';
                    } else {
                        addWithdrawalBtn.disabled = true;
                        addWithdrawalBtn.style.opacity = '0.5';
                    }
                }
                
                // Update month comments
                if (monthCommentsInput) {
                    monthCommentsInput.disabled = !canEdit;
                    if (!canEdit) {
                        monthCommentsInput.placeholder = "Cannot edit comments for past months";
                    } else {
                        monthCommentsInput.placeholder = "Enter comments for the current month...";
                    }
                }
            }
            
            function loadGeneralMonth(year, month) {
                currentGeneralYear = year;
                currentGeneralMonth = month;
                
                updateGeneralNavigation();
                updateGeneralTable();
                renderWithdrawalTable();
                loadMonthComments();
                updateGeneralEditPermissions();
            }
            
            function addWithdrawal(amount) {
                // Check if we can edit this month
                if (!canEditGeneralMonth()) {
                    showNotification("Cannot add withdrawals to past months", "error");
                    return;
                }

                const today = getToday();
                const dateKey = formatDateKey(today);
                if (!withdrawalData[dateKey]) {
                    withdrawalData[dateKey] = [];
                }

                withdrawalData[dateKey].push({
                    date: dateKey,
                    amount: amount
                });

                // Вместо прямого изменения баланса, пересчитываем его полностью
                recalculateCurrentBalance();

                saveWithdrawalData();
                saveSettings();
                renderWithdrawalTable();

                // Update percentage indicator after withdrawal
                updatePercentageIndicator();

                showNotification(`Withdrawal ${formatNumber(amount)} saved successfully`, 'success');
            }
            
            function editWithdrawal(dateKey, index, newAmount) {
                // Check if we can edit this month
                if (!canEditGeneralMonth()) {
                    showNotification("Cannot edit withdrawals in past months", "error");
                    return;
                }

                if (!withdrawalData[dateKey] || !withdrawalData[dateKey][index]) return;

                const oldAmount = withdrawalData[dateKey][index].amount;
                withdrawalData[dateKey][index].amount = newAmount;

                // Вместо прямого изменения баланса, пересчитываем его полностью
                recalculateCurrentBalance();

                saveWithdrawalData();
                saveSettings();
                renderWithdrawalTable();

                // Update percentage indicator after withdrawal edit
                updatePercentageIndicator();

                showNotification(`Withdrawal updated to ${formatNumber(newAmount)}`, 'success');
            }
            
            function deleteWithdrawal(dateKey, index) {
                // Check if we can edit this month
                if (!canEditGeneralMonth()) {
                    showNotification("Cannot delete withdrawals from past months", "error");
                    return;
                }

                if (!withdrawalData[dateKey] || !withdrawalData[dateKey][index]) return;

                const amount = withdrawalData[dateKey][index].amount;

                withdrawalData[dateKey].splice(index, 1);

                if (withdrawalData[dateKey].length === 0) {
                    delete withdrawalData[dateKey];
                }

                // Вместо прямого изменения баланса, пересчитываем его полностью
                recalculateCurrentBalance();

                saveWithdrawalData();
                saveSettings();
                renderWithdrawalTable();

                // Update percentage indicator after withdrawal deletion
                updatePercentageIndicator();

                showNotification(`Withdrawal ${formatNumber(amount)} deleted`, 'success');
            }
            
            function renderWithdrawalTable() {
                if (!withdrawalTable) return;
                
                const tbody = withdrawalTable.querySelector('tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                const currentMonthKey = `${currentGeneralYear}-${String(currentGeneralMonth + 1).padStart(2, '0')}`;
                let totalWithdrawal = 0;
                let hasWithdrawals = false;
                
                Object.keys(withdrawalData).forEach(dateKey => {
                    if (dateKey.startsWith(currentMonthKey)) {
                        withdrawalData[dateKey].forEach((withdrawal, index) => {
                            hasWithdrawals = true;
                            const row = document.createElement('tr');
                            row.className = 'editable';
                            row.dataset.date = dateKey;
                            row.dataset.index = index;
                            
                            const dateCell = document.createElement('td');
                            dateCell.textContent = formatDate(parseDateKey(withdrawal.date));
                            row.appendChild(dateCell);
                            
                            const amountCell = document.createElement('td');
                            amountCell.textContent = formatNumber(withdrawal.amount);
                            row.appendChild(amountCell);
                            
                            // Only allow editing if we can edit this month
                            if (canEditGeneralMonth()) {
                                row.addEventListener('click', (e) => {
                                    currentWithdrawalDate = e.currentTarget.dataset.date;
                                    currentWithdrawalIndex = parseInt(e.currentTarget.dataset.index);
                                    
                                    if (withdrawalActionModal) {
                                        withdrawalActionModal.style.display = 'flex';
                                    }
                                });
                            } else {
                                row.style.cursor = 'not-allowed';
                                row.style.opacity = '0.6';
                            }
                            
                            tbody.appendChild(row);
                            
                            totalWithdrawal += withdrawal.amount;
                        });
                    }
                });
                
                if (!hasWithdrawals) {
                    const emptyRow = document.createElement('tr');
                    const emptyCell = document.createElement('td');
                    emptyCell.colSpan = 2;
                    emptyCell.textContent = 'No withdrawals for this month';
                    emptyCell.style.textAlign = 'center';
                    emptyCell.style.fontStyle = 'italic';
                    emptyCell.style.color = 'var(--hint-color)';
                    emptyRow.appendChild(emptyCell);
                    tbody.appendChild(emptyRow);
                } else if (totalWithdrawal > 0) {
                    const totalRow = document.createElement('tr');
                    totalRow.style.fontWeight = 'bold';
                    
                    const totalLabelCell = document.createElement('td');
                    totalLabelCell.textContent = 'Total:';
                    totalRow.appendChild(totalLabelCell);
                    
                    const totalAmountCell = document.createElement('td');
                    totalAmountCell.textContent = formatNumber(totalWithdrawal);
                    totalRow.appendChild(totalAmountCell);
                    
                    tbody.appendChild(totalRow);
                }
            }
            
            function applyTargetToDay(value) {
                if (!currentTargetDay || !currentTargetType) return;
                
                const dateKey = `${currentGeneralYear}-${String(currentGeneralMonth + 1).padStart(2, '0')}-${String(currentTargetDay).padStart(2, '0')}`;
                
                if (!generalData[dateKey]) {
                    generalData[dateKey] = {};
                }
                
                generalData[dateKey][currentTargetType + 'Target'] = parseFloat(value);
                
                localStorage.setItem('generalData', JSON.stringify(generalData));
                updateGeneralTable();
                
                if (targetModal) {
                    targetModal.style.display = 'none';
                }
                
                showNotification(`Target for day ${currentTargetDay} set`, 'success');
            }
            
            function applyTargetToAll(value) {
                if (!currentTargetType) return;
                
                const daysInMonth = new Date(currentGeneralYear, currentGeneralMonth + 1, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateKey = `${currentGeneralYear}-${String(currentGeneralMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    if (!generalData[dateKey]) {
                        generalData[dateKey] = {};
                    }
                    
                    generalData[dateKey][currentTargetType + 'Target'] = parseFloat(value);
                }
                
                saveGeneralData();
                updateGeneralTable();
                
                closeModal();
                
                showNotification(`Targets for all days set (${value}%)`, 'success');
            }
            
            function loadMonthComments() {
                if (!monthCommentsInput) return;
                
                const monthKey = `${currentGeneralYear}-${currentGeneralMonth + 1}`;
                monthCommentsInput.value = monthCommentsData[monthKey] || '';
            }
            
            function saveMonthComments() {
                if (!monthCommentsInput) return;
                
                // Check if we can edit this month
                if (!canEditGeneralMonth()) {
                    showNotification("Cannot edit comments for past months", "error");
                    return;
                }
                
                const monthKey = `${currentGeneralYear}-${currentGeneralMonth + 1}`;
                monthCommentsData[monthKey] = monthCommentsInput.value;
                saveMonthCommentsData();
            }

            // Event Listeners
            if (prevDayBtn) {
                prevDayBtn.addEventListener('click', () => {
                    const newDate = new Date(currentDate);
                    newDate.setDate(newDate.getDate() - 1);
                    loadDateData(newDate);
                });
            }
            
            if (currentDayLabel) {
                currentDayLabel.addEventListener('click', () => {
                    loadDateData(getToday());
                });
            }
            
            if (nextDayBtn) {
                nextDayBtn.addEventListener('click', () => {
                    const newDate = new Date(currentDate);
                    newDate.setDate(newDate.getDate() + 1);
                    loadDateData(newDate);
                });
            }
            
            // Month navigation for General tab
            if (prevMonthBtn) {
                prevMonthBtn.addEventListener('click', () => {
                    let newMonth = currentGeneralMonth - 1;
                    let newYear = currentGeneralYear;
                    
                    if (newMonth < 0) {
                        newMonth = 11;
                        newYear--;
                    }
                    
                    loadGeneralMonth(newYear, newMonth);
                });
            }
            
            if (nextMonthBtn) {
                nextMonthBtn.addEventListener('click', () => {
                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth();
                    
                    // Prevent navigation to future months
                    if (currentGeneralYear === currentYear && currentGeneralMonth === currentMonth) {
                        showNotification("Cannot view future months", "error");
                        return;
                    }
                    
                    let newMonth = currentGeneralMonth + 1;
                    let newYear = currentGeneralYear;
                    
                    if (newMonth > 11) {
                        newMonth = 0;
                        newYear++;
                    }
                    
                    // Check if we're trying to navigate to a future month
                    if (newYear > currentYear || (newYear === currentYear && newMonth > currentMonth)) {
                        showNotification("Cannot view future months", "error");
                        return;
                    }
                    
                    loadGeneralMonth(newYear, newMonth);
                });
            }
            
            if (addTradeBtn) {
                addTradeBtn.addEventListener('click', () => {
                    // Проверяем, можно ли редактировать эту дату
                    if (!canEditCurrentDate()) return;
                    
                    addTradeToTable();
                    // Не сохраняем автоматически при добавлении пустой сделки
                });
            }
            
            if (addWithdrawalBtn) {
                addWithdrawalBtn.addEventListener('click', () => {
                    // Check if we can edit this month
                    if (!canEditGeneralMonth()) {
                        showNotification("Cannot add withdrawals to past months", "error");
                        return;
                    }
                    
                    isEditingWithdrawal = false;
                    if (withdrawalAmountInput) withdrawalAmountInput.value = '';
                    if (withdrawalModal) withdrawalModal.style.display = 'flex';
                });
            }
            
            if (monthCommentsInput) {
                monthCommentsInput.addEventListener('change', saveMonthComments);
                monthCommentsInput.addEventListener('blur', saveMonthComments);
            }
            
            // Remove conflicting event listeners that were causing issues
            // with reset and clear buttons
            
            // Закрытие модальных окон по клавише Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });

            if (clearCurrentDayBtn) {
                clearCurrentDayBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to clear current day data?')) {
                        const dateKey = formatDateKey(currentDate);
                        delete historyData[dateKey];
                        saveTradeData();
                        
                        initTrades();
                        renderTable();
                        updateTotal();
                        
                        showNotification('Current day data cleared', 'success');
                    }
                });
            }
            
            if (clearAllDataBtn) {
                clearAllDataBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to clear ALL history? This action cannot be undone.')) {
                        historyData = {};
                        generalData = {};
                        withdrawalData = {};
                        monthCommentsData = {};
                        appSettings = {
                            initialBalance: 0,
                            startingBalance: 0,
                            currentBalance: 0
                        };

                        saveTradeData();
                        saveGeneralData();
                        saveWithdrawalData();
                        saveMonthCommentsData();
                        saveSettings();

                        if (balanceAmount) balanceAmount.textContent = '10000';
                        if (currentBalanceValue) currentBalanceValue.textContent = '10000';

                        initTrades();
                        renderTable();
                        updateTotal();
                        renderHistory();
                        renderWithdrawalTable();
                        updateGeneralTable();

                        // Update percentage indicator immediately after clearing all data
                        console.log('About to call updatePercentageIndicator() after clearing all data');
                        updatePercentageIndicator();
                        console.log('updatePercentageIndicator() called after clearing all data');

                        showNotification('All history cleared', 'success');
                    }
                });
            }
            
            // Modal event listeners - ИСПРАВЛЕННЫЕ ОБРАБОТЧИКИ
            const resultModalButtons = resultModal?.querySelectorAll('.modal-btn');
            if (resultModalButtons) {
                resultModalButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent event bubbling
                        
                        const value = button.dataset.value;
                        const amount = parseFloat(amountInput?.value.replace(',', '.'));
                        
                        if (currentTradeIndex !== null && value === 'reset') {
                            trades[currentTradeIndex].result = null;
                            currentCell.className = 'cell';
                            currentCell.innerHTML = '';
                            
                            updateTotal();
                            refreshAllDisplays();
                            closeModal();
                        } else if (currentTradeIndex !== null && value === 'refund') {
                            currentCell.className = 'cell refund';
                            if (!isNaN(amount) && amount > 0) {
                                currentCell.innerHTML = `<div class="cell-content">Refund: ${formatNumber(amount)}</div>`;
                                trades[currentTradeIndex].result = { type: 'refund', amount: amount };
                            } else {
                                currentCell.innerHTML = `<div class="cell-content">Refund</div>`;
                                trades[currentTradeIndex].result = { type: 'refund', amount: 0 };
                            }
                            
                            updateTotal();
                            refreshAllDisplays();
                            closeModal();
                        } else if (currentTradeIndex !== null && !isNaN(amount) && amount > 0) {
                            if (value === 'profit') {
                                currentCell.className = 'cell profit';
                                currentCell.innerHTML = `<div class="cell-content">+${formatNumber(amount)}</div>`;
                                trades[currentTradeIndex].result = { type: 'profit', amount: amount };
                            } else if (value === 'loss') {
                                currentCell.className = 'cell loss';
                                currentCell.innerHTML = `<div class="cell-content">-${formatNumber(amount)}</div>`;
                                trades[currentTradeIndex].result = { type: 'loss', amount: amount };
                            }
                            
                            updateTotal();
                            refreshAllDisplays();
                            closeModal();
                        } else if (currentTradeIndex !== null && value !== 'reset' && value !== 'refund') {
                            showNotification('Enter a valid positive amount', 'error');
                            if (amountInput) {
                                amountInput.classList.add('error-input');
                                setTimeout(() => amountInput.classList.remove('error-input'), 10);
                            }
                            // НЕ закрываем модальное окно при ошибке
                            return;
                        } else if (currentTradeIndex === null) {
                            showNotification('No trade selected', 'error');
                            closeModal();
                            return;
                        }
                    });
                });
            }
            
            if (resultModal) {
                resultModal.addEventListener('click', (e) => {
                    if (e.target === resultModal) {
                        closeModal();
                    }
                });
            }
            
            // Close modal when pressing Enter in amount input
            if (amountInput) {
                amountInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        // Trigger the first button's action (profit)
                        const profitBtn = document.querySelector('.profit-btn[data-value]');
                        if (profitBtn) {
                            profitBtn.click();
                        }
                    }
                });
            }
            
            // ИСПРАВЛЕННЫЙ ОБРАБОТЧИК для сохранения суммы сделки
            if (saveTradeAmountBtn) {
                saveTradeAmountBtn.addEventListener('click', () => {
                    // Валидация введенных данных
                    const inputValue = tradeAmountInput?.value?.trim();
                    
                    // Если поле пустое или значение равно 0, сбрасываем сумму сделки
                    if (!inputValue || inputValue === '0') {
                        trades[currentTradeIndex].tradeAmount = null;
                        currentCell.textContent = 'Click to enter amount';
                        currentCell.style.color = 'var(--hint-color)';
                        currentCell.style.fontStyle = 'italic';
                    } else {
                        const amount = parseFloat(inputValue.replace(',', '.'));
                        if (isNaN(amount)) {
                            showNotification('Please enter a valid number', 'error');
                            return;
                        }
                        
                        if (amount <= 0) {
                            showNotification('Trade amount must be greater than 0', 'error');
                            return;
                        }
                        
                        // Проверка на слишком большое значение
                        if (amount > 100000) { // 100,000
                            showNotification('Trade amount is too large', 'error');
                            return;
                        }
                        
                        trades[currentTradeIndex].tradeAmount = amount;
                        currentCell.textContent = formatNumber(amount);
                        currentCell.style.color = '';
                        currentCell.style.fontStyle = '';
                    }
                    
                    saveTradeData();
                    updateTotal();
                    refreshAllDisplays();
                    closeModal();
                });
            }
            
            // Валидация ввода в поле суммы сделки (реальное время)
            if (tradeAmountInput) {
                tradeAmountInput.addEventListener('input', function() {
                    // Убираем все, кроме цифр, точки и запятой
                    this.value = this.value.replace(/[^0-9.,]/g, '');
                });
            }

            // Валидация ввода в поле суммы результата (реальное время)
            if (amountInput) {
                amountInput.addEventListener('input', function() {
                    // Убираем все, кроме цифр, точки и запятой
                    this.value = this.value.replace(/[^0-9.,]/g, '');
                });
            }
            
            if (cancelTradeAmountBtn) {
                cancelTradeAmountBtn.addEventListener('click', () => {
                    closeModal();
                });
            }
            
            if (tradeAmountModal) {
                tradeAmountModal.addEventListener('click', (e) => {
                    if (e.target === tradeAmountModal) {
                        closeModal();
                    }
                });
            }
            
            // Close trade amount modal when pressing Enter in trade amount input
            if (tradeAmountInput) {
                tradeAmountInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (saveTradeAmountBtn) saveTradeAmountBtn.click();
                    }
                });
            }
            
            // ИСПРАВЛЕНИЕ: Правильная обработка сохранения вывода (добавление или редактирование)
            if (saveWithdrawalBtn) {
                saveWithdrawalBtn.addEventListener('click', () => {
                    const amount = parseFloat(withdrawalAmountInput?.value.replace(',', '.'));
                    if (!isNaN(amount) && amount > 0) {
                        if (isEditingWithdrawal && currentWithdrawalDate !== null && currentWithdrawalIndex !== null) {
                            editWithdrawal(currentWithdrawalDate, currentWithdrawalIndex, amount);
                        } else {
                            addWithdrawal(amount);
                        }
                        isEditingWithdrawal = false;
                        closeModal();
                    } else {
                        showNotification('Enter a valid positive amount', 'error');
                        if (withdrawalAmountInput) {
                            withdrawalAmountInput.classList.add('error-input');
                            setTimeout(() => withdrawalAmountInput.classList.remove('error-input'), 1000);
                        }
                    }
                });
            }
            
            if (cancelWithdrawalBtn) {
                cancelWithdrawalBtn.addEventListener('click', () => {
                    isEditingWithdrawal = false;
                    closeModal();
                });
            }
            
            if (withdrawalModal) {
                withdrawalModal.addEventListener('click', (e) => {
                    if (e.target === withdrawalModal) {
                        isEditingWithdrawal = false;
                        closeModal();
                    }
                });
            }
            
            // Close withdrawal modal when pressing Enter in withdrawal amount input
            if (withdrawalAmountInput) {
                withdrawalAmountInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (saveWithdrawalBtn) saveWithdrawalBtn.click();
                    }
                });
            }
            
            // ИСПРАВЛЕНИЕ: Установка флага редактирования при нажатии на Edit
            if (editWithdrawalBtn) {
                editWithdrawalBtn.addEventListener('click', () => {
                    if (currentWithdrawalDate !== null && currentWithdrawalIndex !== null) {
                        isEditingWithdrawal = true;
                        const withdrawal = withdrawalData[currentWithdrawalDate][currentWithdrawalIndex];
                        if (withdrawalAmountInput) withdrawalAmountInput.value = withdrawal.amount;
                        if (withdrawalModal) withdrawalModal.style.display = 'flex';
                        if (withdrawalActionModal) withdrawalActionModal.style.display = 'none';
                    }
                });
            }
            
            if (deleteWithdrawalBtn) {
                deleteWithdrawalBtn.addEventListener('click', () => {
                    if (currentWithdrawalDate !== null && currentWithdrawalIndex !== null) {
                        deleteWithdrawal(currentWithdrawalDate, currentWithdrawalIndex);
                        if (withdrawalActionModal) withdrawalActionModal.style.display = 'none';
                    }
                });
            }
            
            if (cancelWithdrawalActionBtn) {
                cancelWithdrawalActionBtn.addEventListener('click', () => {
                    closeModal();
                });
            }
            
            if (withdrawalActionModal) {
                withdrawalActionModal.addEventListener('click', (e) => {
                    if (e.target === withdrawalActionModal) {
                        closeModal();
                    }
                });
            }
            
            // Close withdrawal action modal when pressing Enter
            withdrawalActionModal.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    withdrawalActionModal.style.display = 'none';
                }
            });
            
            const emotionOptions = emotionModal?.querySelectorAll('.emotion-option');
            if (emotionOptions) {
                emotionOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const emotion = option.dataset.emotion;
                        trades[currentTradeIndex].emotion = emotion;
                        // Display using emotion map
                        currentCell.textContent = emotionMap[emotion];
                        saveTradeData();
                        updateTotal();
                        refreshAllDisplays();
                        closeModal();
                    });
                });
            }
            
            // Close emotion modal when clicking outside
            if (emotionModal) {
                emotionModal.addEventListener('click', (e) => {
                    if (e.target === emotionModal) {
                        closeModal();
                    }
                });
            }
            
            if (clearEmotionBtn) {
                clearEmotionBtn.addEventListener('click', () => {
                    trades[currentTradeIndex].emotion = null;
                    currentCell.textContent = '';
                    saveTradeData();
                    updateTotal();
                    refreshAllDisplays();
                    closeModal();
                });
            }
            
            // Close emotion modal when pressing Enter in emotion modal
            if (emotionModal) {
                emotionModal.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        closeModal();
                    }
                });
            }
            
            
            if (saveCommentBtn) {
                saveCommentBtn.addEventListener('click', () => {
                    trades[currentTradeIndex].comment = commentsInput.value;
                    currentCell.textContent = commentsInput.value;
                    currentCell.style.color = '';
                    currentCell.style.fontStyle = '';
                    saveTradeData();
                    updateTotal();
                    refreshAllDisplays();
                    closeModal();
                });
            }
            
            if (cancelCommentBtn) {
                cancelCommentBtn.addEventListener('click', () => {
                    closeModal();
                });
            }
            
            if (commentsModal) {
                commentsModal.addEventListener('click', (e) => {
                    if (e.target === commentsModal) {
                        closeModal();
                    }
                });
            }
            
            // Close comments modal when pressing Enter in comments input
            if (commentsInput) {
                commentsInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (saveCommentBtn) saveCommentBtn.click();
                    }
                });
            }
            
            if (startingBalanceValue) {
                startingBalanceValue.addEventListener('click', () => {
                    console.log('Starting Balance clicked');
                    console.log('Modal display before:', balanceModal ? balanceModal.style.display : 'null');
                    if (balanceInput) balanceInput.value = appSettings.startingBalance;
                    if (balanceModal) balanceModal.style.display = 'flex';
                    console.log('Modal display after:', balanceModal ? balanceModal.style.display : 'null');
                });
            }
            
            if (saveBalanceBtn) {
                saveBalanceBtn.addEventListener('click', () => {
                    const inputValue = balanceInput.value.replace(',', '.');
                    const newBalance = parseFloat(inputValue);
                    if (!isNaN(newBalance)) {
                        appSettings.startingBalance = newBalance;
                        appSettings.currentBalance = newBalance;

                        if (balanceAmount) {
                            balanceAmount.textContent = formatNumber(newBalance);
                        }

                        if (currentBalanceValue) {
                            currentBalanceValue.textContent = formatNumber(newBalance);
                        }

                        updateTotal();
                        saveSettings();

                        // Update percentage indicator after balance change
                        updatePercentageIndicator();

                        if (balanceModal) balanceModal.style.display = 'none';

                        showNotification('Balance updated', 'success');
                    } else {
                        showNotification('Enter a valid number', 'error');
                    }
                });
            }
            
            if (cancelBalanceBtn) {
                cancelBalanceBtn.addEventListener('click', () => {
                    closeModal();
                });
            }
            
            if (balanceModal) {
                balanceModal.addEventListener('click', (e) => {
                    if (e.target === balanceModal) {
                        closeModal();
                    }
                });
            }
            
            // Close balance modal when pressing Enter in balance input
            if (balanceInput) {
                balanceInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (saveBalanceBtn) saveBalanceBtn.click();
                    }
                });
            }
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabContent = document.getElementById(`${tabId}-tab`);
                    if (tabContent) tabContent.classList.add('active');
                    
                    if (tabId === 'general') {
                        // Reset to current month when switching to General tab
                        const now = new Date();
                        loadGeneralMonth(now.getFullYear(), now.getMonth());
                    } else if (tabId === 'table') {
                        updateProgressBar();
                        // Обновляем цвет ячейки day result при переключении на вкладку "table"
                        updateDayResultForCurrentDate();
                    }
                });
            });
            
            if (applyToDayBtn) {
                applyToDayBtn.addEventListener('click', () => {
                    // Валидация введенных данных
                    const inputValue = targetInput?.value?.trim();
                    if (!inputValue) {
                        showNotification('Please enter a target value', 'error');
                        return;
                    }
                    
                    const value = parseFloat(inputValue.replace(',', '.'));
                    if (isNaN(value)) {
                        showNotification('Please enter a valid number', 'error');
                        return;
                    }
                    
                    // Проверка на разумные пределы целевого значения
                    if (Math.abs(value) > 100) {
                        showNotification('Target value seems too high (max ±100%)', 'error');
                        return;
                    }
                    
                    applyTargetToDay(value);
                });
            }
            
            if (applyToAllBtn) {
                applyToAllBtn.addEventListener('click', () => {
                    // Валидация введенных данных
                    const inputValue = targetInput?.value?.trim();
                    if (!inputValue) {
                        showNotification('Please enter a target value', 'error');
                        return;
                    }
                    
                    const value = parseFloat(inputValue.replace(',', '.'));
                    if (isNaN(value)) {
                        showNotification('Please enter a valid number', 'error');
                        return;
                    }
                    
                    // Проверка на разумные пределы целевого значения
                    if (Math.abs(value) > 100) {
                        showNotification('Target value seems too high (max ±100%)', 'error');
                        return;
                    }
                    
                    applyTargetToAll(value);
                });
            }
            
            // Валидация ввода в поле целевого значения (реальное время)
            if (targetInput) {
                targetInput.addEventListener('input', function() {
                    // Убираем все, кроме цифр, точки, запятой и минуса (для отрицательных значений)
                    this.value = this.value.replace(/[^0-9.,-]/g, '');
                });
            }
            
            if (cancelTargetBtn) {
                cancelTargetBtn.addEventListener('click', () => {
                    closeModal();
                });
            }
            
            if (targetModal) {
                targetModal.addEventListener('click', (e) => {
                    if (e.target === targetModal) {
                        closeModal();
                    }
                });
            }
            
            // Универсальная функция для закрытия модальных окон
            function closeModal() {
                // Закрываем все возможные модальные окна
                const modals = [
                    resultModal,
                    tradeAmountModal,
                    withdrawalModal,
                    withdrawalActionModal,
                    emotionModal,
                    commentsModal,
                    balanceModal,
                    targetModal,
                    document.getElementById('monthlyCellModal') // Add monthly cell modal
                ];
                
                modals.forEach(modal => {
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
                
                // Also close monthly cell modal if it exists
                const monthlyCellModal = document.getElementById('monthlyCellModal');
                if (monthlyCellModal) {
                    monthlyCellModal.style.display = 'none';
                }
                
                // Сбрасываем переменные состояния
                currentCell = null;
                currentTradeIndex = null;
                currentColumnType = null;
                currentTargetDay = null;
                currentTargetType = null;
                currentWithdrawalDate = null;
                currentWithdrawalIndex = null;
                
                // Сбрасываем значения полей ввода
                if (amountInput) amountInput.value = '';
                if (tradeAmountInput) tradeAmountInput.value = '';
                if (withdrawalAmountInput) withdrawalAmountInput.value = '';
                if (balanceInput) balanceInput.value = '';
                if (targetInput) targetInput.value = '';
                if (commentsInput) commentsInput.value = '';
            }

            // Функция для обновления прогресс-бара
            function updateProgressBar() {
                console.log('updateProgressBar called');
                if (!progressFill || !progressStart || !progressCurrent || !progressTarget) {
                    console.log('Progress bar elements not found');
                    return;
                }

                // Получаем текущую дату
                const currentDateKey = formatDateKey(currentDate);

                // Получаем данные о целях для текущего дня
                const dayGeneralData = generalData[currentDateKey] || {};
                const profitTarget = dayGeneralData.profitTarget || 2; // По умолчанию 2%
                const lossTarget = dayGeneralData.lossTarget || -2; // По умолчанию -2%

                // Вычисляем результат за текущий день
                let dayResult = 0;
                let dayResultPercent = 0;

                // Используем текущие данные trades для текущей даты, а не historyData для актуальности
                if (currentDateKey === formatDateKey(new Date())) {
                    // Для текущей даты используем актуальные данные из переменной trades
                    for (let i = 0; i < trades.length; i++) {
                        const trade = trades[i];
                        if (trade.result) {
                            if (trade.result.type === 'profit') {
                                dayResult += trade.result.amount;
                            } else if (trade.result.type === 'loss') {
                                dayResult -= trade.result.amount;
                            }
                        }
                    }
                } else {
                    // Для других дат используем данные из historyData
                    if (historyData[currentDateKey] && historyData[currentDateKey].trades) {
                        historyData[currentDateKey].trades.forEach(trade => {
                            if (trade.result) {
                                if (trade.result.type === 'profit') {
                                    dayResult += trade.result.amount;
                                } else if (trade.result.type === 'loss') {
                                    dayResult -= trade.result.amount;
                                }
                            }
                        });
                    }
                }

                // Вычисляем процент результата относительно начального баланса дня
                if (appSettings.startingBalance > 0) {
                    dayResultPercent = (dayResult / appSettings.startingBalance) * 100;
                }

                // Обновляем UI элементы
                progressStart.textContent = `${lossTarget.toFixed(1)}%`;
                progressCurrent.textContent = `${dayResultPercent.toFixed(1)}%`;
                progressTarget.textContent = `${profitTarget.toFixed(1)}%`;

                // Создаем контейнер для прогресс-бара, чтобы корректно отображать двунаправленный прогресс
                const progressBar = document.querySelector('.progress-bar');

                // Очищаем предыдущие элементы прогресса, если они есть
                const existingLossFill = document.querySelector('.progress-loss-fill');
                const existingProfitFill = document.querySelector('.progress-profit-fill');
                const centerMarker = document.querySelector('.center-marker');

                if (existingLossFill) existingLossFill.remove();
                if (existingProfitFill) existingProfitFill.remove();
                if (centerMarker) centerMarker.remove();

                // Создаем отдельные элементы для отрицательного (убыток) и положительного (прибыль) прогресса
                if (dayResultPercent < 0) {
                    // Красная часть (убыток) - от центра влево
                    const lossFill = document.createElement('div');
                    lossFill.className = 'progress-loss-fill';
                    const lossPercentage = (Math.abs(dayResultPercent) / Math.abs(lossTarget)) * 50;
                    lossFill.style.width = `${Math.min(50, Math.max(0, lossPercentage))}%`;
                    lossFill.style.background = 'var(--progress-loss)';
                    lossFill.style.height = '100%';
                    lossFill.style.position = 'absolute';
                    lossFill.style.left = `${50 - lossPercentage}%`;
                    lossFill.style.top = '0';
                    lossFill.style.borderRadius = '6px';
                    progressBar.appendChild(lossFill);
                } else if (dayResultPercent > 0) {
                    // Зеленая часть (прибыль) - от центра вправо
                    const profitFill = document.createElement('div');
                    profitFill.className = 'progress-profit-fill';
                    const profitPercentage = (dayResultPercent / profitTarget) * 50;
                    profitFill.style.width = `${Math.min(50, Math.max(0, profitPercentage))}%`;
                    profitFill.style.background = 'var(--progress-profit)';
                    profitFill.style.height = '100%';
                    profitFill.style.position = 'absolute';
                    profitFill.style.left = '50%';
                    profitFill.style.top = '0';
                    profitFill.style.borderRadius = '6px';
                    progressBar.appendChild(profitFill);
                }

                // Центральная метка (0%)
                const marker = document.createElement('div');
                marker.className = 'center-marker';
                marker.style.position = 'absolute';
                marker.style.left = '50%';
                marker.style.top = '0';
                marker.style.height = '100%';
                marker.style.width = '2px';
                marker.style.background = 'var(--text-color)';
                marker.style.transform = 'translateX(-50%)';
                marker.style.zIndex = '2';
                progressBar.appendChild(marker);

                // Убираем основной элемент прогресс-бара, так как теперь у нас двунаправленный прогресс
                progressFill.style.width = '0%';
                console.log('Progress bar updated successfully');
            }

            // Обновляем функцию updatePercentageIndicator с цветами и одним знаком после запятой для процентов
            function updatePercentageIndicator() {
                console.log('updatePercentageIndicator() called');

                if (!percentageIndicator || !indicatorArrow || !indicatorPercentage || !balanceAmount) {
                    return;
                }

                const startingBalance = appSettings.startingBalance;

                // Рассчитываем текущий баланс только на основе торговой истории
                let tradingProfitLoss = 0;

                Object.keys(historyData).forEach(dateKey => {
                    const dayData = historyData[dateKey];
                    if (dayData.trades) {
                        dayData.trades.forEach(trade => {
                            if (trade.result) {
                                if (trade.result.type === 'profit') {
                                    tradingProfitLoss += trade.result.amount;
                                } else if (trade.result.type === 'loss') {
                                    tradingProfitLoss -= trade.result.amount;
                                }
                            }
                        });
                    }
                });

                const currentDateKey = formatDateKey(currentDate);
                if (trades && trades.length > 0) {
                    const hasSavedData = historyData[currentDateKey] && historyData[currentDateKey].trades;
                    if (!hasSavedData) {
                        trades.forEach(trade => {
                            if (trade.result) {
                                if (trade.result.type === 'profit') {
                                    tradingProfitLoss += trade.result.amount;
                                } else if (trade.result.type === 'loss') {
                                    tradingProfitLoss -= trade.result.amount;
                                }
                            }
                        });
                    }
                }

                const currentTradingBalance = startingBalance + tradingProfitLoss;

                let percentageChange;
                if (startingBalance === 0) {
                    percentageChange = 0;
                } else {
                    percentageChange = ((currentTradingBalance - startingBalance) / startingBalance) * 100;
                }

                // Округляем до одного знака после запятой
                const roundedPercentage = Math.round(percentageChange * 10) / 10;

                // Форматируем отображение процента с одним знаком после запятой
                let displayPercentage;
                if (Math.abs(roundedPercentage) < 0.1) {
                    displayPercentage = '0.0%';
                } else {
                    displayPercentage = (roundedPercentage > 0 ? '+' : '') + roundedPercentage.toFixed(1) + '%';
                }

                // Обрезаем до 5 символов если нужно (например: +12.3%)
                if (displayPercentage.length > 5) {
                    // Для значений больше 99.9% показываем целое число
                    displayPercentage = (roundedPercentage > 0 ? '+' : '') + Math.round(roundedPercentage) + '%';
                }

                // Update percentage text
                indicatorPercentage.textContent = displayPercentage;

                // Update arrow and colors - используем широкие толстые символы с цветами
                if (roundedPercentage > 0) {
                    // ЗЕЛЕНЫЙ для плюса
                    indicatorArrow.textContent = '▲';
                    indicatorArrow.className = 'indicator-arrow positive';
                    indicatorPercentage.className = 'indicator-percentage positive';
                } else if (roundedPercentage < 0) {
                    // КРАСНЫЙ для минуса
                    indicatorArrow.textContent = '▼';
                    indicatorArrow.className = 'indicator-arrow negative';
                    indicatorPercentage.className = 'indicator-percentage negative';
                } else {
                    // Нейтральный цвет для нуля
                    indicatorArrow.textContent = '●';
                    indicatorArrow.className = 'indicator-arrow neutral';
                    indicatorPercentage.className = 'indicator-percentage neutral';
                }

                // Always show the indicator
                percentageIndicator.style.display = 'flex';

                // Обновляем отображение суммы баланса
                updateBalanceDisplay();

                console.log('Percentage indicator updated:', {
                    percentage: roundedPercentage,
                    display: displayPercentage,
                    arrowColor: indicatorArrow.className,
                    percentageColor: indicatorPercentage.className
                });
            }

            // Функция для форматирования суммы баланса с двумя знаками после запятой
            function formatBalanceForDisplay(number) {
                if (number >= 1000000) {
                    // Формат: 1.23M
                    return (number / 1000000).toFixed(2) + 'M';
                } else if (number >= 100000) {
                    // Формат: 123.45K
                    return (number / 1000).toFixed(2) + 'K';
                } else if (number >= 10000) {
                    // Формат: 10.23K
                    return (number / 1000).toFixed(2) + 'K';
                } else if (number >= 1000) {
                    // Формат: 1.23K
                    return (number / 1000).toFixed(2) + 'K';
                } else {
                    // Формат: 123.45
                    return number.toFixed(2);
                }
            }

            function updateBalanceDisplay() {
                if (!balanceAmount) return;

                const startingBalance = appSettings.startingBalance;
                const formattedBalance = formatBalanceForDisplay(startingBalance);

                // Проверяем что не превышаем 7 символов
                if (formattedBalance.length > 7) {
                    // Если превышает, используем более агрессивное форматирование
                    if (startingBalance >= 1000000) {
                        balanceAmount.textContent = Math.round(startingBalance / 1000000) + 'M';
                    } else if (startingBalance >= 1000) {
                        balanceAmount.textContent = Math.round(startingBalance / 1000) + 'K';
                    } else {
                        balanceAmount.textContent = Math.round(startingBalance).toString();
                    }
                } else {
                    balanceAmount.textContent = formattedBalance;
                }
            }

            // Вызываем при инициализации
            updateBalanceDisplay();
            
            // Initialize the app
            init();
            
            // Make sure the General tab is properly initialized on page load
            // since it's the default active tab
            const activeTab = document.querySelector('.tab.active');
            if (activeTab && activeTab.dataset.tab === 'general') {
                const now = new Date();
                loadGeneralMonth(now.getFullYear(), now.getMonth());
            }
            
            // Ensure the initially active tab content is displayed properly
            // by triggering the tab switch logic for the currently active tab
            setTimeout(() => {
                // Explicitly make sure the General tab remains active after init
                const generalTab = document.querySelector('.tab[data-tab="general"]');
                const allTabs = document.querySelectorAll('.tab');
                const allTabContents = document.querySelectorAll('.tab-content');
                
                // Remove active class from all tabs and contents
                allTabs.forEach(tab => tab.classList.remove('active'));
                allTabContents.forEach(tc => tc.classList.remove('active'));
                
                // Add active class to General tab and its content
                if (generalTab) {
                    generalTab.classList.add('active');
                    const generalContent = document.getElementById('general-tab');
                    if (generalContent) {
                        generalContent.classList.add('active');
                    }
                }
            }, 150); // Slightly longer delay to ensure all initialization is complete

            // Initialize progress bar visibility setting
            const showProgressBarToggle = document.getElementById('showProgressBarToggle');
            if (showProgressBarToggle) {
                // Set initial state
                if (uiSettings.showProgressBar) {
                    showProgressBarToggle.classList.add('on');
                } else {
                    showProgressBarToggle.classList.remove('on');
                }
                updateProgressBarVisibility();

                showProgressBarToggle.addEventListener('click', function() {
                    const isOn = showProgressBarToggle.classList.contains('on');
                    if (isOn) {
                        showProgressBarToggle.classList.remove('on');
                        uiSettings.showProgressBar = false;
                    } else {
                        showProgressBarToggle.classList.add('on');
                        uiSettings.showProgressBar = true;
                    }
                    saveUISettings();
                    updateProgressBarVisibility();
                });
            }

            // Вызываем при инициализации
            updateBalanceDisplay();

            // Initialize theme buttons
            const lightThemeBtn = document.getElementById('lightThemeBtn');
            const darkThemeBtn = document.getElementById('darkThemeBtn');
            console.log('Theme buttons found:', { lightThemeBtn, darkThemeBtn });
            if (lightThemeBtn) {
                lightThemeBtn.addEventListener('click', () => {
                    console.log('Light Theme button clicked');
                    switchTheme('light');
                });
            }
            if (darkThemeBtn) {
                darkThemeBtn.addEventListener('click', () => {
                    console.log('Dark Theme button clicked');
                    switchTheme('dark');
                });
            }

            // Добавляем логи для отладки переноса слов в заголовках таблицы
            function logTableHeaderStyles() {
                const thElements = document.querySelectorAll('th');
                console.log('Стили заголовков таблицы для переноса слов:');
                thElements.forEach((th, index) => {
                    const computedStyle = getComputedStyle(th);
                    console.log(`TH ${index} (${th.textContent.trim()}):`);
                    console.log(`  white-space: ${computedStyle.whiteSpace}`);
                    console.log(`  word-break: ${computedStyle.wordBreak}`);
                    console.log(`  hyphens: ${computedStyle.hyphens}`);
                    console.log(`  width: ${computedStyle.width}`);
                    console.log(`  min-width: ${computedStyle.minWidth}`);
                    console.log(`  padding: ${computedStyle.padding}`);
                    console.log(`  text-align: ${computedStyle.textAlign}`);
                    console.log(`  line-height: ${computedStyle.lineHeight}`);
                    console.log(`  overflow: ${computedStyle.overflow}`);
                    console.log(`  text-overflow: ${computedStyle.textOverflow}`);
                    console.log(`  font-size: ${computedStyle.fontSize}`);
                });
            }

            // Логируем стили после инициализации
            setTimeout(logTableHeaderStyles, 1500);

            // Добавляем логи для проверки примененных стилей к th
            setTimeout(() => {
                console.log('Проверка примененных стилей к th элементам после обновлений:');
                const thElements = document.querySelectorAll('th');
                thElements.forEach((th, index) => {
                    const computedStyle = getComputedStyle(th);
                    console.log(`TH ${index} (${th.textContent.trim()}):`);
                    console.log(`  white-space: ${computedStyle.whiteSpace}`);
                    console.log(`  word-break: ${computedStyle.wordBreak}`);
                    console.log(`  font-size: ${computedStyle.fontSize}`);
                    console.log(`  padding: ${computedStyle.padding}`);
                    console.log(`  min-width: ${computedStyle.minWidth}`);
                    console.log(`  line-height: ${computedStyle.lineHeight}`);
                    console.log(`  overflow: ${computedStyle.overflow}`);
                    console.log(`  text-overflow: ${computedStyle.textOverflow}`);
                });
                console.log('Стили успешно применены: white-space: normal; word-break: keep-all; overflow: visible; для всех th.');
            }, 2000);

            // Добавляем логи для проверки примененных стилей к th
            setTimeout(() => {
                console.log('Applied styles to th: white-space: nowrap; word-break: keep-all;');
                const thElements = document.querySelectorAll('th');
                thElements.forEach((th, index) => {
                    const computedStyle = getComputedStyle(th);
                    console.log(`TH ${index} (${th.textContent}): white-space: ${computedStyle.whiteSpace}, word-break: ${computedStyle.wordBreak}`);
                });
            }, 1600);

            // Дополнительные логи для проверки изменений в стилях th
            setTimeout(() => {
                console.log('CSS changes applied to th elements: word-break: break-word; white-space: normal; font-size: 0.75rem; padding: 12px 10px; min-width: 100px;');
                const thElements = document.querySelectorAll('th');
                thElements.forEach((th, index) => {
                    const computedStyle = getComputedStyle(th);
                    console.log(`TH ${index} (${th.textContent}): font-size: ${computedStyle.fontSize}, word-break: ${computedStyle.wordBreak}, padding: ${computedStyle.padding}, white-space: ${computedStyle.whiteSpace}, min-width: ${computedStyle.minWidth}`);
                });
            }, 1600);

            // Add logging for balance alignment and styles
            function logBalanceAlignment() {
                const balanceItems = document.querySelectorAll('.balance-item');
                console.log('Balance alignment check:');
                balanceItems.forEach((item, index) => {
                    console.log(`Balance item ${index} (${item.querySelector('.balance-label').textContent}): width=${item.offsetWidth}, height=${item.offsetHeight}`);
                    const label = item.querySelector('.balance-label');
                    const value = item.querySelector('.balance-value');
                    console.log(`  Label: width=${label.offsetWidth}, height=${label.offsetHeight}`);
                    console.log(`  Value: width=${value.offsetWidth}, height=${value.offsetHeight}`);
                });
            }

            // Add logging for Starting Balance styles
            function logStartingBalanceStyles() {
                const startingBalance = document.getElementById('startingBalanceValue');
                if (startingBalance) {
                    const computedStyle = getComputedStyle(startingBalance);
                    console.log('Starting Balance computed styles:');
                    console.log('  background-color:', computedStyle.backgroundColor);
                    console.log('  color:', computedStyle.color);
                    console.log('  border:', computedStyle.border);
                    console.log('  border-radius:', computedStyle.borderRadius);
                    console.log('  padding:', computedStyle.padding);
                    console.log('  cursor:', computedStyle.cursor);
                    console.log('  box-shadow:', computedStyle.boxShadow);
                    console.log('  opacity:', computedStyle.opacity);
                    console.log('  transform:', computedStyle.transform);
                    console.log('  transition:', computedStyle.transition);
                    console.log('  classList:', startingBalance.classList.toString());
                    console.log('  Current theme:', document.documentElement.getAttribute('data-theme'));
                    console.log('  CSS variables:');
                    console.log('    --button-color:', getComputedStyle(document.documentElement).getPropertyValue('--button-color'));
                    console.log('    --button-text-color:', getComputedStyle(document.documentElement).getPropertyValue('--button-text-color'));
                    console.log('    --bg-color:', getComputedStyle(document.documentElement).getPropertyValue('--bg-color'));
                    console.log('    --text-color:', getComputedStyle(document.documentElement).getPropertyValue('--text-color'));
                } else {
                    console.log('Starting Balance element not found');
                }
            }

            // Add logging for Comment styles
            function logCommentStyles() {
                const monthCommentsTextarea = document.getElementById('monthCommentsInput');
                const commentsCells = document.querySelectorAll('.comments-cell');
                const currentTheme = document.documentElement.getAttribute('data-theme');
                console.log('Logging comment styles for theme:', currentTheme);
                console.log('  CSS variables:');
                console.log('    --text-color:', getComputedStyle(document.documentElement).getPropertyValue('--text-color'));
                console.log('    --bg-color:', getComputedStyle(document.documentElement).getPropertyValue('--bg-color'));
                if (monthCommentsTextarea) {
                    const computedStyle = getComputedStyle(monthCommentsTextarea);
                    console.log('Month Comments textarea styles:');
                    console.log('  color:', computedStyle.color);
                    console.log('  background-color:', computedStyle.backgroundColor);
                    console.log('  Applied styles confirmed: color set to var(--text-color) for visibility in dark theme.');
                } else {
                    console.log('Month Comments textarea not found');
                }
                commentsCells.forEach((cell, index) => {
                    const computedStyle = getComputedStyle(cell);
                    console.log(`Comments cell ${index} styles:`);
                    console.log('  color:', computedStyle.color);
                });
                console.log('Comment visibility updated for dark theme.');
            }

            // Log after init
            setTimeout(logBalanceAlignment, 1000);

            // Add theme toggle for testing
            document.addEventListener('keydown', function(e) {
                if (e.key === 't' || e.key === 'T') {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    if (currentTheme === 'dark') {
                        document.documentElement.removeAttribute('data-theme');
                        console.log('Switched to light theme');
                    } else {
                        document.documentElement.setAttribute('data-theme', 'dark');
                        console.log('Switched to dark theme');
                    }
                    setTimeout(logBalanceAlignment, 500);
                    setTimeout(logStartingBalanceStyles, 500);
                }
            });

            // ==================== EXPORT FUNCTIONALITY ====================

            // Elements for export
            const exportSettingsBtn = document.getElementById('exportSettingsBtn');
            const exportModal = document.getElementById('exportModal');
            const exportStartDate = document.getElementById('exportStartDate');
            const exportEndDate = document.getElementById('exportEndDate');
            const saveExportBtn = document.getElementById('saveExportBtn');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const exportTabs = document.querySelectorAll('.export-tab');

            // State for export
            let currentExportType = 'table';
            let isExportInProgress = false;

            // Initialize export functionality
            function initExport() {
                console.log('initExport: Starting export initialization');

                // Set default dates (last 30 days)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);

                if (exportStartDate) exportStartDate.value = formatDateForInput(startDate);
                if (exportEndDate) exportEndDate.value = formatDateForInput(endDate);

                // Export tab handling
                if (exportTabs) {
                    exportTabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            exportTabs.forEach(t => t.classList.remove('active'));
                            tab.classList.add('active');
                            currentExportType = tab.dataset.tab;
                        });
                    });
                }

                // Инициализируем только кнопку в настройках
                if (exportSettingsBtn) {
                    exportSettingsBtn.disabled = false;
                    exportSettingsBtn.addEventListener('click', handleExportClick);
                    console.log('initExport: Export button initialized successfully');
                } else {
                    console.error('initExport: exportSettingsBtn not found');
                }
                
            }

            // Функция для безопасного управления состоянием кнопки экспорта
            function setExportButtonState(disabled, reason = '') {
                // Обновляем состояние только кнопки в настройках
                if (!exportSettingsBtn) return;

                const wasDisabled = exportSettingsBtn.disabled;
                exportSettingsBtn.disabled = disabled;

                console.log(`setExportButtonState: Button exportSettingsBtn ${disabled ? 'disabled' : 'enabled'} (${reason})`);

                isExportInProgress = disabled;
            }

            // Обработчик клика по кнопке экспорта
            function handleExportClick() {
                console.log('handleExportClick: Export button clicked');

                // Проверяем состояние экспорта
                if (isExportInProgress) {
                    console.log('handleExportClick: Export already in progress, ignoring click');
                    return;
                }

                if (!exportModal) {
                    console.error('handleExportClick: exportModal not found');
                    return;
                }

                console.log('handleExportClick: Opening export modal');

                // Открываем модальное окно
                exportModal.style.display = 'flex';

                // Сбрасываем даты при каждом открытии
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);

                if (exportStartDate) exportStartDate.value = formatDateForInput(startDate);
                if (exportEndDate) exportEndDate.value = formatDateForInput(endDate);

                console.log('handleExportClick: Export modal opened successfully');
            }

            // Format date for input[type="date"]
            function formatDateForInput(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // Parse date from input
            function parseExportDate(dateString) {
                const [year, month, day] = dateString.split('-').map(Number);
                return new Date(year, month - 1, day);
            }

            // Export data to Excel
            function exportToExcel() {
                console.log('exportToExcel: Starting export process');

                // Проверяем, что экспорт не выполняется
                if (isExportInProgress) {
                    console.log('exportToExcel: Export already in progress');
                    return;
                }

                try {
                    // Отключаем кнопку экспорта
                    setExportButtonState(true, 'starting export');

                    const startDate = parseExportDate(exportStartDate.value);
                    const endDate = parseExportDate(exportEndDate.value);

                    if (startDate > endDate) {
                        showNotification('Start date cannot be after end date', 'error');
                        // Восстанавливаем состояние кнопки при ошибке валидации
                        setExportButtonState(false, 'validation error');
                        return;
                    }

                    let data;
                    let filename;

                    if (currentExportType === 'table') {
                        data = prepareTableDataForExport(startDate, endDate);
                        filename = `trading_diary_${formatDateForInput(startDate)}_to_${formatDateForInput(endDate)}.xlsx`;
                    } else {
                        data = prepareGeneralDataForExport(startDate, endDate);
                        filename = `trading_general_${formatDateForInput(startDate)}_to_${formatDateForInput(endDate)}.xlsx`;
                    }

                    // Create workbook and worksheet
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(data);

                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'Trading Data');

                    // Export to file
                    XLSX.writeFile(wb, filename);

                    // Close modal after successful export
                    closeModal();

                    // Show success notification
                    showNotification('Excel file downloaded successfully', 'success');
                    console.log('exportToExcel: Export completed successfully');

                } catch (error) {
                    console.error('Export error:', error);
                    showNotification('Export error occurred', 'error');
                } finally {
                    // ВСЕГДА восстанавливаем состояние кнопки экспорта
                    setExportButtonState(false, 'export finished');
                    console.log('exportToExcel: Finally block executed, button state restored');
                }
            }

            // Prepare table data for export
            function prepareTableDataForExport(startDate, endDate) {
                const exportData = [];

                // Get all dates in range
                const datesInRange = getDatesInRange(startDate, endDate);

                datesInRange.forEach(date => {
                    const dateKey = formatDateKey(date);
                    const dayData = historyData[dateKey];

                    if (dayData && dayData.trades) {
                        dayData.trades.forEach((trade, tradeIndex) => {
                            // Only export trades with data
                            if (trade.tradeAmount || trade.result || trade.emotion || trade.comment) {
                                const rowData = {
                                    'Date': formatDate(date),
                                    'Trade Number': tradeIndex + 1,
                                    'Trade Amount': trade.tradeAmount || 0,
                                    'Result Type': trade.result ? trade.result.type : '',
                                    'Result Amount': trade.result ? trade.result.amount : 0,
                                    'Emotional State': trade.emotion || '',
                                    'Comments': trade.comment || ''
                                };
                                exportData.push(rowData);
                            }
                        });
                    }
                });

                return exportData;
            }

            // Prepare general data for export
            function prepareGeneralDataForExport(startDate, endDate) {
                const exportData = [];

                // Get all dates in range
                const datesInRange = getDatesInRange(startDate, endDate);

                datesInRange.forEach(date => {
                    const dateKey = formatDateKey(date);
                    const dayData = historyData[dateKey];
                    const generalDayData = generalData[dateKey] || {};

                    // Calculate withdrawals for this date
                    const dayWithdrawals = withdrawalData[dateKey] || [];
                    const totalWithdrawal = dayWithdrawals.reduce((sum, withdrawal) => sum + withdrawal.amount, 0);

                    if (dayData && dayData.trades) {
                        // Calculate day totals
                        let dayProfit = 0;
                        let dayLoss = 0;
                        let winTrades = 0;
                        let lossTrades = 0;
                        let totalTrades = 0;

                        dayData.trades.forEach(trade => {
                            if (trade.result) {
                                totalTrades++;
                                if (trade.result.type === 'profit') {
                                    dayProfit += trade.result.amount;
                                    winTrades++;
                                } else if (trade.result.type === 'loss') {
                                    dayLoss += trade.result.amount;
                                    lossTrades++;
                                }
                            }
                        });

                        const netResult = dayProfit - dayLoss;
                        const rowData = {
                            'Date': formatDate(date),
                            'Profit Target (%)': generalDayData.profitTarget || '',
                            'Loss Target (%)': generalDayData.lossTarget || '',
                            'Actual P/L (%)': generalDayData.actualProfitLoss || 0,
                            'Total Profit': dayProfit,
                            'Total Loss': dayLoss,
                            'Net Result': netResult,
                            'Withdrawals': totalWithdrawal,
                            'Total (Net - Withdrawals)': netResult - totalWithdrawal, // Новая колонка
                            'Winning Trades': winTrades,
                            'Losing Trades': lossTrades,
                            'Total Trades': totalTrades,
                            'Win Rate (%)': totalTrades > 0 ? ((winTrades / totalTrades) * 100).toFixed(2) : 0
                        };

                        exportData.push(rowData);
                    } else if (totalWithdrawal > 0) {
                        // Если нет торгов, но есть выводы - все равно экспортируем
                        const rowData = {
                            'Date': formatDate(date),
                            'Profit Target (%)': generalDayData.profitTarget || '',
                            'Loss Target (%)': generalDayData.lossTarget || '',
                            'Actual P/L (%)': generalDayData.actualProfitLoss || 0,
                            'Total Profit': 0,
                            'Total Loss': 0,
                            'Net Result': 0,
                            'Withdrawals': totalWithdrawal,
                            'Total (Net - Withdrawals)': -totalWithdrawal,
                            'Winning Trades': 0,
                            'Losing Trades': 0,
                            'Total Trades': 0,
                            'Win Rate (%)': 0
                        };
                        exportData.push(rowData);
                    }
                });

                return exportData;
            }

            // Get all dates in a range
            function getDatesInRange(startDate, endDate) {
                const dates = [];
                const currentDate = new Date(startDate);

                while (currentDate <= endDate) {
                    dates.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                return dates;
            }

            // Event listeners for export
            if (saveExportBtn) {
                saveExportBtn.addEventListener('click', () => {
                    console.log('saveExportBtn: clicked');
                    if (!isExportInProgress) {
                        exportToExcel();
                    } else {
                        console.log('saveExportBtn: Export already in progress');
                    }
                });
            }

            if (cancelExportBtn) {
                cancelExportBtn.addEventListener('click', () => {
                    console.log('cancelExportBtn: clicked');
                    closeModal();
                });
            }

            if (exportModal) {
                exportModal.addEventListener('click', (e) => {
                    if (e.target === exportModal) {
                        console.log('exportModal: clicked outside');
                        closeModal();
                    }
                });
            }

            // Close export modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && exportModal && exportModal.style.display === 'flex') {
                    console.log('Escape key pressed in export modal');
                    closeModal();
                }
            });
            
            // Monthly cell modal Escape key handling
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const monthlyCellModal = document.getElementById('monthlyCellModal');
                    if (monthlyCellModal && monthlyCellModal.style.display === 'flex') {
                        monthlyCellModal.style.display = 'none';
                    }
                }
            });

            // Update closeModal function to include export modal
            function closeModal() {
                console.log('closeModal: Closing all modals');

                const modals = [
                    resultModal,
                    tradeAmountModal,
                    withdrawalModal,
                    withdrawalActionModal,
                    emotionModal,
                    commentsModal,
                    balanceModal,
                    targetModal,
                    exportModal,  // Add export modal to the list
                    document.getElementById('monthlyCellModal')  // Add monthly cell modal to the list
                ];

                modals.forEach(modal => {
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
                
                // Also close monthly cell modal if it exists
                const monthlyCellModal = document.getElementById('monthlyCellModal');
                if (monthlyCellModal) {
                    monthlyCellModal.style.display = 'none';
                }

                // Reset state variables
                currentCell = null;
                currentTradeIndex = null;
                currentColumnType = null;
                currentTargetDay = null;
                currentTargetType = null;
                currentWithdrawalDate = null;
                currentWithdrawalIndex = null;

                // Reset input fields
                if (amountInput) amountInput.value = '';
                if (tradeAmountInput) tradeAmountInput.value = '';
                if (withdrawalAmountInput) withdrawalAmountInput.value = '';
                if (balanceInput) balanceInput.value = '';
                if (targetInput) targetInput.value = '';
                if (commentsInput) commentsInput.value = '';

                // Гарантированное восстановление состояния кнопки экспорта при закрытии любого модального окна
                setExportButtonState(false, 'modal closed');
            }

            // Initialize monthly cell modal event handlers separately
            // This needs to be done during initial app setup to ensure the modal works from the first open
            function initMonthlyCellModal() {
                const monthlyCellModal = document.getElementById('monthlyCellModal');
                const monthlyModalOkBtn = document.getElementById('monthlyModalOkBtn');
                const monthlyModalDailyBtn = document.getElementById('monthlyModalDailyBtn');
                
                // Set up event handlers for monthly cell modal
                if (monthlyCellModal) {
                    monthlyCellModal.addEventListener('click', function(e) {
                        if (e.target === monthlyCellModal) {
                            monthlyCellModal.style.display = 'none';
                        }
                    });
                }
                
                if (monthlyModalOkBtn) {
                    monthlyModalOkBtn.addEventListener('click', function() {
                        const modal = document.getElementById('monthlyCellModal');
                        if (modal) {
                            modal.style.display = 'none';
                        }
                        // Also call the main closeModal function to ensure all state is properly reset
                        closeModal();
                    });
                }
                
                if (monthlyModalDailyBtn) {
                    monthlyModalDailyBtn.addEventListener('click', function() {
                        const modal = document.getElementById('monthlyCellModal');
                        if (modal) {
                            modal.style.display = 'none';
                        }
                        // Also call the main closeModal function to ensure all state is properly reset
                        closeModal();
                        
                        // Find and activate the Daily tab
                        const dailyTab = document.querySelector('.tab[data-tab="table"]');
                        const dailyTabContent = document.getElementById('table-tab');
                        
                        if (dailyTab && dailyTabContent) {
                            // Remove active class from all tabs and contents
                            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                            
                            // Add active class to Daily tab and its content
                            dailyTab.classList.add('active');
                            dailyTabContent.classList.add('active');
                        }
                    });
                }
            }

            // Initialize export when app starts
            initExport();
            
            // Initialize monthly cell modal event handlers
            initMonthlyCellModal();
            
            // Debug function for Telegram
            function checkTelegramEnvironment() {
                const isTelegram = window.Telegram && Telegram.WebApp;
                const platform = isTelegram ? Telegram.WebApp.platform : 'browser';
    
                console.log('Environment check:', {
                    isTelegram: isTelegram,
                    platform: platform,
                    userAgent: navigator.userAgent,
                    exportSupported: typeof XLSX !== 'undefined'
                });
    
                return isTelegram;
            }

            // Call this on startup
            setTimeout(checkTelegramEnvironment, 500);
        });
        
        // Ждём полной загрузки страницы
        document.addEventListener('DOMContentLoaded', function() {
            const link = document.getElementById('myLink');
            if (link) {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    Telegram.WebApp.openLink('https://t.me/m8y_chat');
                });
            }
        });
  
    </script>
    
    <!-- Main App Container - Обернем основное приложение в контейнер -->
    <div id="mainApp" class="trading-diary-container">
        <div class="container">
            <header>
                <div class="balance-container">
                    <div class="balance-item">
                        <div class="balance-label">Starting Balance</div>
                        <div class="balance-value starting-balance" id="startingBalanceValue">
                            <span class="balance-amount" id="balanceAmount">10000</span>
                            <div class="percentage-indicator" id="percentageIndicator">
                                <div class="indicator-arrow" id="indicatorArrow">●</div>
                                <span class="indicator-percentage" id="indicatorPercentage">0.0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">Current Balance</div>
                        <div class="balance-value" id="currentBalanceValue">1000</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">Day Result</div>
                        <div class="balance-value" id="dayResultValue">0</div>
                    </div>
                </div>
            </header>
            
            <div class="tabs">
                <div class="tab active" data-tab="general">Monthly</div>
                <div class="tab" data-tab="table">Daily</div>
                <div class="tab" data-tab="history">History</div>
                <div class="tab" data-tab="settings">Settings</div>
            </div>
            
            <div class="main-content">
                <!-- General Tab -->
                <div class="tab-content active" id="general-tab">
                    <div class="general-header">
                        <div class="current-date" id="currentGeneralDate"></div>
                    </div>
                    
                    <div class="date-navigation">
                        <button class="date-btn" id="prevMonthBtn">←</button>
                        <div class="date-label" id="currentMonthLabel">Month Year</div>
                        <button class="date-btn" id="nextMonthBtn" disabled>→</button>
                    </div>
                    
                    <div class="general-table-container">
                        <table class="general-table" id="generalTable">
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Profit Target</th>
                                    <th>Loss Target</th>
                                    <th>Actual P/L</th>
                                    <th>Winning Trades</th>
                                    <th>Losing Trades</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table rows will be generated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="withdrawal-table-container">
                        <table class="withdrawal-table" id="withdrawalTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Withdrawal</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Withdrawal rows will be generated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <button class="btn add-withdrawal-btn" id="addWithdrawalBtn">+ Add Withdrawal</button>
                    
                    <div class="month-comments">
                        <h3>Month Comments</h3>
                        <textarea id="monthCommentsInput" placeholder="Enter comments for the current month..."></textarea>
                    </div>
                </div>
                
                <div class="tab-content" id="table-tab">

                    <div class="progress-container">
                        <div class="progress-label">Daily Progress</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 50%"></div>
                        </div>
                        <div class="progress-stats">
                            <span id="progressStart">-2%</span>
                            <span id="progressCurrent">0%</span>
                            <span id="progressTarget">+2%</span>
                        </div>
                    </div>
                    
                    <div class="date-navigation">
                        <button class="date-btn" id="prevDayBtn" aria-label="Previous day">←</button>
                        <div class="date-label" id="currentDayLabel">Today</div>
                        <button class="date-btn" id="nextDayBtn" disabled aria-label="Next day">→</button>
                    </div>
                    
                    <div class="table-container">
                        <table id="tradingTable">
                            <thead>
                                <tr>
                                    <th class="trade-header">Trade</th>
                                    <th>Trade Amount</th>
                                    <th>Profit/Loss Refund</th>
                                    <th>Emotional State</th>
                                    <th>Comments</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Table rows will be generated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <button class="btn add-trade-btn" id="addTradeBtn" aria-label="Add new trade">+ Add Trade</button>
                </div>
                
                <div class="tab-content" id="history-tab">
                    <h2>Trading Days History</h2>
                    <div class="table-container">
                        <table class="history-table" id="historyTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- History rows will be generated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-content" id="settings-tab">
                    <h2>Application Settings</h2>
                    
                    <div class="settings-panel">
                        <h3>Data Management</h3>
                        <button class="btn btn-success settings-btn" id="exportSettingsBtn">Export to Excel</button>
                        <button class="btn btn-warning settings-btn" id="clearCurrentDayBtn">Clear Current Day</button>
                        <button class="btn btn-danger settings-btn" id="clearAllDataBtn">Delete all history</button>
                    </div>
                    
                    <div class="settings-panel">
                        <h3>Display Settings</h3>
                        <div class="setting-row">
                            <button class="btn settings-btn" id="lightThemeBtn">Daylight</button>
                            <button class="btn settings-btn" id="darkThemeBtn">Midnight</button>
                        </div>
                        <div class="toggle-switch-container">
                            <label class="toggle-description">Daily Progress Bar</label>
                            <div class="toggle-switch" id="showProgressBarToggle">
                                <span class="toggle-label off">OFF</span>
                                <div class="toggle-slider">
                                    <div class="toggle-indicator"></div>
                                </div>
                                <span class="toggle-label on">ON</span>
                            </div>
                        </div>
                    </div>

                    <div class="settings-panel">
                        <h3>About</h3>
                        <div class="button-wrapper">

                            <a href="https://t.me/m8y_chat"id="myLink" >
                                <span>
                                    <strong class="shiny-text">Join Community</strong>
                                </span>
                            </a>
                        </div>
                        <p>Trading Diary PRO v2.0</p>
                        <p>Developed for convenient tracking of trading results</p>
                        <button class="btn btn-success settings-btn" id="openGuideBtn">Trading Diary Guide</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Guide Container -->
    <div id="guideContainer" style="display: none;">
        <!-- Content will be loaded here -->
        <div class="container">
            <div class="header">
                <div class="header-left-actions">
                    <button class="corner-btn theme-btn" id="theme-toggle" aria-label="Переключить тему">
                        <span>🌙</span>
                    </button>
                    <button class="language-btn" id="language-toggle" aria-label="Переключить язык">
                        RU
                    </button>
                </div>
                <div class="header-right-actions">
                    <button class="corner-btn close-btn" id="close-guide" aria-label="Закрыть гид">
                        <span>✕</span>
                    </button>
                </div>
                <h1 tabindex="-1" data-ru="Торговый Дневник" data-en="Trading Diary">Торговый Дневник</h1>
                <p data-ru="Полное руководство по использованию приложения" data-en="Complete guide to using the application">Полное руководство по использованию приложения</p>
            </div>

            <!-- Horizontal Tab Navigation -->
            <nav class="tab-navigation" role="tablist" aria-label="Trading diary guide sections">
                <button class="tab-button active" id="general-button" data-tab="general" role="tab" aria-selected="true" aria-controls="general-content">
                    <span class="tab-icon">📈</span>
                    <span class="tab-text" data-ru="Monthly" data-en="Monthly">Monthly</span>
                </button>
                <button class="tab-button" id="table-button" data-tab="table" role="tab" aria-selected="false" aria-controls="table-content">
                    <span class="tab-icon">📊</span>
                    <span class="tab-text" data-ru="Daily" data-en="Daily">Daily</span>
                </button>
                <button class="tab-button" id="history-button" data-tab="history" role="tab" aria-selected="false" aria-controls="history-content">
                    <span class="tab-icon">📚</span>
                    <span class="tab-text" data-ru="History" data-en="History">History</span>
                </button>
                <button class="tab-button" id="settings-button" data-tab="settings" role="tab" aria-selected="false" aria-controls="settings-content">
                    <span class="tab-icon">⚙️</span>
                    <span class="tab-text" data-ru="Settings" data-en="Settings">Settings</span>
                </button>
                <button class="tab-button" id="examples-button" data-tab="examples" role="tab" aria-selected="false" aria-controls="examples-content">
                    <span class="tab-icon">💡</span>
                    <span class="tab-text" data-ru="Examples" data-en="Examples">Examples</span>
                </button>
            </nav>

            <!-- Main Content with Tabbed Cards -->
            <div class="main-content">
                <!-- Tab Content Container -->
                <div class="tab-content-container">
                    <!-- General Section Card -->
                    <div class="tab-content" id="general-content" role="tabpanel" aria-labelledby="general-button">
                        <div class="swipeable-content">
                            <!-- Card 1: Overview -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Вкладка Monthly - Общая статистика" data-en="Monthly Tab - General Statistics">Вкладка Monthly - Общая статистика</h3>
                                    <p data-ru="Вкладка <strong>Monthly</strong> предоставляет обзор торговой активности за месяц. Здесь вы можете устанавливать дневные цели, отслеживать достижения и управлять выводами средств." data-en="The <strong>Monthly</strong> tab provides an overview of trading activity for the month. Here you can set daily goals, track achievements, and manage withdrawals.">Вкладка <strong>Monthly</strong> предоставляет обзор торговой активности за месяц. Здесь вы можете устанавливать дневные цели, отслеживать достижения и управлять выводами средств.</p>
                                </div>
                            </div>

                            <!-- Card 2: Navigation and Daily Stats -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Навигация по месяцам" data-en="Month Navigation">Навигация по месяцам</h3>
                                    <p data-ru="В верхней части вкладки расположены элементы навигации по месяцам с кнопками-стрелками и отображением текущего месяца." data-en="At the top of the tab are month navigation elements with arrow buttons and current month display.">В верхней части вкладки расположены элементы навигации по месяцам с кнопками-стрелками и отображением текущего месяца.</p>

                                    <h3 data-ru="Таблица дневной статистики" data-en="Daily Statistics Table">Таблица дневной статистики</h3>


                                    <p data-ru="Основная таблица показывает статистику по дням месяца:" data-en="The main table shows statistics by days of the month:">Основная таблица показывает статистику по дням месяца:</p>

                                    <div class="element-description">
                                        <div class="element-title" data-ru="Day (День)" data-en="Day (Day)">Day (День)</div>
                                        <p data-ru="Номер дня в месяце." data-en="Day number in the month.">Номер дня в месяце.</p>
                                    </div>

                                    <div class="element-description">
                                        <div class="element-title" data-ru="Profit Target (Цель по прибыли)" data-en="Profit Target (Profit Target)">Profit Target (Цель по прибыли)</div>
                                        <p data-ru="Целевая прибыль на день в процентах. Нажмите на ячейку для установки цели." data-en="Target profit for the day in percent. Click on the cell to set the goal.">Целевая прибыль на день в процентах. Нажмите на ячейку для установки цели.</p>
                                    </div>

                                    <div class="element-description">
                                        <div class="element-title" data-ru="Loss Target (Цель по убыткам)" data-en="Loss Target (Loss Target)">Loss Target (Цель по убыткам)</div>
                                        <p data-ru="Максимально допустимый убыток на день в процентах. Нажмите на ячейку для установки цели." data-en="Maximum allowable loss for the day in percent. Click on the cell to set the goal.">Максимально допустимый убыток на день в процентах. Нажмите на ячейку для установки цели.</p>
                                    </div>

                                </div>
                            </div>

                            <!-- Card 3: Daily Results -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Результаты торгов" data-en="Trading Results">Результаты торгов</h3>

                                    <div class="element-description">
                                        <div class="element-title" data-ru="Actual P/L (Фактический P/L)" data-en="Actual P/L (Actual P/L)">Actual P/L (Фактический P/L)</div>
                                        <p data-ru="Реальный результат торгов за день в процентах от начального баланса." data-en="Actual trading result for the day in percent of initial balance.">Реальный результат торгов за день в процентах от начального баланса.</p>
                                    </div>

                                    <div class="element-description">
                                        <div class="element-title" data-ru="Winning Trades (Выигрышные опционы)" data-en="Winning Trades (Winning Trades)">Winning Trades (Выигрышные опционы)</div>
                                        <p data-ru="Количество опционов, которые принесли прибыль за день." data-en="Number of options that brought profit for the day.">Количество опционов, которые принесли прибыль за день.</p>
                                    </div>

                                    <div class="element-description">
                                        <div class="element-title" data-ru="Losing Trades (Проигрышные опционы)" data-en="Losing Trades (Losing Trades)">Losing Trades (Проигрышные опционы)</div>
                                        <p data-ru="Количество опционов, которые принесли убыток за день." data-en="Number of options that brought loss for the day.">Количество опционов, которые принесли убыток за день.</p>
                                    </div>

                                </div>
                            </div>

                            <!-- Card 4: Withdrawals and Comments -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Выводы средств и комментарии" data-en="Withdrawals and Comments">Выводы средств и комментарии</h3>

                                    <h4 data-ru="Таблица выводов" data-en="Withdrawal Table">Таблица выводов</h4>

                                    <div class="element-description">
                                        <div class="element-title" data-ru="Date (Дата)" data-en="Date (Date)">Date (Дата)</div>
                                        <p data-ru="Дата вывода средств." data-en="Withdrawal date.">Дата вывода средств.</p>
                                    </div>

                                    <div class="element-description">
                                        <div class="element-title" data-ru="Withdrawal (Вывод)" data-en="Withdrawal (Withdrawal)">Withdrawal (Вывод)</div>
                                        <p data-ru="Сумма выведенных средств." data-en="Amount of withdrawn funds.">Сумма выведенных средств.</p>
                                    </div>

                                    <div class="element-description">
                                        <div class="element-title">+ Add Withdrawal</div>
                                        <p data-ru="Кнопка для добавления новой записи о выводе средств." data-en="Button to add a new withdrawal record.">Кнопка для добавления новой записи о выводе средств.</p>
                                    </div>

                                    <h4 data-ru="Комментарии к месяцу" data-en="Monthly Comments">Комментарии к месяцу</h4>
                                    <p data-ru="В нижней части вкладки расположено текстовое поле для комментариев к текущему месяцу. Здесь можно описать общие наблюдения, изменения в стратегии, рыночные условия и т.д." data-en="At the bottom of the tab there is a text field for comments on the current month. Here you can describe general observations, strategy changes, market conditions, etc.">В нижней части вкладки расположено текстовое поле для комментариев к текущему месяцу. Здесь можно описать общие наблюдения, изменения в стратегии, рыночные условия и т.д.</p>

                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Table Section Card -->
                    <div class="tab-content" id="table-content" role="tabpanel" aria-labelledby="table-button">
                        <div class="swipeable-content">
                            <!-- Card 1: Overview -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Вкладка Daily - Таблица опционов" data-en="Daily Tab - Options Table">Вкладка Daily - Таблица опционов</h3>
                                    <p data-ru="Вкладка <strong>Daily</strong> является основной рабочей областью приложения. Здесь вы можете добавлять, редактировать и управлять своими торговыми опционами в реальном времени. Таблица автоматически рассчитывает прибыль/убыток и обновляет общую статистику." data-en="The <strong>Daily</strong> tab is the main workspace of the application. Here you can add, edit and manage your trading options in real time. The table automatically calculates profit/loss and updates the overall statistics.">Вкладка <strong>Daily</strong> является основной рабочей областью приложения. Здесь вы можете добавлять, редактировать и управлять своими торговыми опционами в реальном времени. Таблица автоматически рассчитывает прибыль/убыток и обновляет общую статистику.</p>

                                    <h4 data-ru="Основные возможности" data-en="Main Features">Основные возможности</h4>
                                    <ul>
                                        <li data-ru='Добавление новых опционов с помощью кнопки "+ Add Trade"' data-en='Adding new options using the "+ Add Trade" button'>Добавление новых опционов с помощью кнопки "+ Add Trade"</li>
                                        <li data-ru="Редактирование существующих опционов двойным кликом" data-en="Editing existing options with double-click">Редактирование существующих опционов двойным кликом</li>
                                        <li data-ru="Автоматический расчет прибыли и убытков" data-en="Automatic calculation of profits and losses">Автоматический расчет прибыли и убытков</li>
                                        <li data-ru="Отображение дневного прогресса в виде индикатора" data-en="Displaying daily progress as an indicator">Отображение дневного прогресса в виде индикатора</li>
                                        <li data-ru="Фильтрация и сортировка данных" data-en="Filtering and sorting data">Фильтрация и сортировка данных</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Card 2: Controls -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Элементы управления" data-en="Control Elements">Элементы управления</h3>

                                    <div class="feature-list">
                                        <div class="feature-item">
                                            <h4 data-ru="Панель баланса" data-en="Balance Panel">Панель баланса</h4>
                                            <p data-ru="В верхней части экрана расположена панель с тремя основными показателями:" data-en="At the top of the screen there is a panel with three main indicators:">В верхней части экрана расположена панель с тремя основными показателями:</p>
                                            <ul>
                                                <li data-ru="<strong>Starting Balance</strong> - начальный баланс на начало дня" data-en='<strong>Starting Balance</strong> - initial balance at the beginning of the day'><strong>Starting Balance</strong> - начальный баланс на начало дня</li>
                                                <li data-ru="<strong>Current Balance</strong> - текущий баланс с учетом всех опционов" data-en='<strong>Current Balance</strong> - current balance taking into account all options'><strong>Current Balance</strong> - текущий баланс с учетом всех опционов</li>
                                                <li data-ru="<strong>Day Result</strong> - результат торгов за текущий день" data-en='<strong>Day Result</strong> - trading result for the current day'><strong>Day Result</strong> - результат торгов за текущий день</li>
                                            </ul>
                                        </div>

                                        <div class="feature-item">
                                            <h4 data-ru="Прогресс-бар" data-en="Progress Bar">Прогресс-бар</h4>
                                            <p data-ru="Под панелью баланса находится индикатор дневного прогресса, который показывает достижение целей по прибыли и убыткам в процентах от начального баланса." data-en="Under the balance panel there is a daily progress indicator that shows achievement of profit and loss targets as percentages of the initial balance.">Под панелью баланса находится индикатор дневного прогресса, который показывает достижение целей по прибыли и убыткам в процентах от начального баланса.</p>
                                        </div>

                                        <div class="feature-item">
                                            <h4 data-ru="Навигация по дням" data-en="Day Navigation">Навигация по дням</h4>
                                            <p data-ru="Кнопки со стрелками позволяют перемещаться между днями для просмотра и редактирования исторических данных." data-en="Arrow buttons allow moving between days to view and edit historical data.">Кнопки со стрелками позволяют перемещаться между днями для просмотра и редактирования исторических данных.</p>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- Card 3: Table Structure -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Таблица опционов" data-en="Options Table">Таблица опционов</h3>


                                    <p data-ru="Таблица состоит из следующих столбцов:" data-en="The table consists of the following columns:">Таблица состоит из следующих столбцов:</p>

                                    <div class="element-description">
                                        <div class="element-title" data-ru="Trade (Номер опциона)" data-en="Trade (Option Number)">Trade (Номер опциона)</div>
                                        <p data-ru="Порядковый номер опциона в списке. Автоматически присваивается при добавлении нового опциона." data-en="Sequential number of the option in the list. Automatically assigned when adding a new option.">Порядковый номер опциона в списке. Автоматически присваивается при добавлении нового опциона.</p>
                                    </div>

                                    <div class="element-description">
                                        <div class="element-title" data-ru="Trade Amount (Сумма опциона)" data-en="Trade Amount (Option Amount)">Trade Amount (Сумма опциона)</div>
                                        <p data-ru="Сумма, инвестированная в бинарный опцион. Нажмите на ячейку "Click to enter amount" для ввода суммы. Поддерживаются десятичные числа." data-en="Amount invested in the binary option. Click on the "Click to enter amount" cell to enter the amount. Decimal numbers are supported.">Сумма, инвестированная в бинарный опцион. Нажмите на ячейку "Click to enter amount" для ввода суммы. Поддерживаются десятичные числа.</p>
                                    </div>

                                    <div class="element-description">
                                        <div class="element-title" data-ru="Profit/Loss Refund (Результат опциона)" data-en="Profit/Loss Refund (Option Result)">Profit/Loss Refund (Результат опциона)</div>
                                        <p data-ru="Результат бинарного опциона. Возможные варианты:" data-en="Binary option result. Possible options:">Результат бинарного опциона. Возможные варианты:
                                            <ul>
                                                <li data-ru='<span class="profit-text">Profit</span> - опцион выиграл (зеленый цвет)' data-en='<span class="profit-text">Profit</span> - option won (green color)'><span class="profit-text">Profit</span> - опцион выиграл (зеленый цвет)</li>
                                                <li data-ru='<span class="loss-text">Loss</span> - опцион проиграл (красный цвет)' data-en='<span class="loss-text">Loss</span> - option lost (red color)'><span class="loss-text">Loss</span> - опцион проиграл (красный цвет)</li>
                                                <li data-ru='<span class="refund-text">Refund</span> - возврат средств (синий цвет)' data-en='<span class="refund-text">Refund</span> - refund of funds (blue color)'><span class="refund-text">Refund</span> - возврат средств (синий цвет)</li>
                                            </ul>
                                        </p>
                                    </div>

                                </div>
                            </div>

                            <!-- Card 4: Table Actions -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Действия с таблицей" data-en="Table Actions">Действия с таблицей</h3>

                                    <div class="important">
                                        <p data-ru="Все ячейки таблицы становятся доступными для редактирования только в текущий день. Для просмотра прошлых дней используйте навигацию по дням." data-en="All table cells become available for editing only on the current day. To view past days, use day navigation.">Все ячейки таблицы становятся доступными для редактирования только в текущий день. Для просмотра прошлых дней используйте навигацию по дням.</p>
                                    </div>

                                    <h3 data-ru='Кнопка "Add Trade"' data-en='Button "Add Trade"'>Кнопка "Add Trade"</h3>
                                    <p data-ru="Кнопка <strong>+ Add Trade</strong> в нижней части экрана позволяет добавить новый опцион в таблицу. После нажатия появляется новая пустая строка, готовую для заполнения." data-en="The <strong>+ Add Trade</strong> button at the bottom of the screen allows you to add a new option to the table. After clicking, a new empty row appears, ready to be filled.">Кнопка <strong>+ Add Trade</strong> в нижней части экрана позволяет добавить новый опцион в таблицу. После нажатия появляется новая пустая строка, готовую для заполнения.</p>

                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- History Section Card -->
                    <div class="tab-content" id="history-content" role="tabpanel" aria-labelledby="history-button">
                        <div class="swipeable-content">
                            <!-- Card 1: Overview -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Вкладка History - История торгов" data-en="History Tab - Trading History">Вкладка History - История торгов</h3>
                                    <p data-ru="Вкладка <strong>History</strong> показывает историю всех торговых дней с итоговыми результатами. Это позволяет анализировать долгосрочные тенденции и эффективность торговли." data-en="The <strong>History</strong> tab shows the history of all trading days with final results. This allows analyzing long-term trends and trading effectiveness.">Вкладка <strong>History</strong> показывает историю всех торговых дней с итоговыми результатами. Это позволяет анализировать долгосрочные тенденции и эффективность торговли.</p>


                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Section Card -->
                    <div class="tab-content" id="settings-content" role="tabpanel" aria-labelledby="settings-button">
                        <div class="swipeable-content">
                            <!-- Card 1: Data Management -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Вкладка Settings - Настройки приложения" data-en="Settings Tab - Application Settings">Вкладка Settings - Настройки приложения</h3>
                                    <p data-ru="Вкладка <strong>Settings</strong> содержит настройки приложения и функции управления данными." data-en="The <strong>Settings</strong> tab contains application settings and data management functions.">Вкладка <strong>Settings</strong> содержит настройки приложения и функции управления данными.</p>

                                    <h3 data-ru="Управление данными" data-en="Data Management">Управление данными</h3>

                                    <div class="element-description">
                                        <div class="element-title">Clear Current Day</div>
                                        <p data-ru="Кнопка для очистки всех данных текущего дня. После подтверждения все опционы и результаты дня будут удалены." data-en="Button to clear all data for the current day. After confirmation, all options and day results will be deleted.">Кнопка для очистки всех данных текущего дня. После подтверждения все опционы и результаты дня будут удалены.</p>
                                    </div>

                                    <div class="element-description">
                                        <div class="element-title">Delete all history</div>
                                        <p data-ru="Кнопка для полного удаления всех данных. Это действие нельзя отменить, поэтому требует дополнительного подтверждения." data-en="Button to completely delete all data. This action cannot be undone, so it requires additional confirmation.">Кнопка для полного удаления всех данных. Это действие нельзя отменить, поэтому требует дополнительного подтверждения.</p>
                                    </div>

                                </div>
                            </div>

                            <!-- Card 2: Display Settings -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Настройки отображения" data-en="Display Settings">Настройки отображения</h3>

                                    <div class="element-description">
                                        <div class="element-title">Daily Progress Bar</div>
                                        <p data-ru="Переключатель для показа/скрытия индикатора дневного прогресса на вкладке Table." data-en="Toggle to show/hide the daily progress indicator on the Table tab.">Переключатель для показа/скрытия индикатора дневного прогресса на вкладке Table.</p>
                                    </div>

                                    <div class="element-description">
                                        <div class="element-title">Daylight / Midnight</div>
                                        <p data-ru="Кнопки для переключения между светлой и темной темой интерфейса." data-en="Buttons to switch between light and dark interface themes.">Кнопки для переключения между светлой и темной темой интерфейса.</p>
                                    </div>

                                    <h3 data-ru="Информация о приложении" data-en="Application Information">Информация о приложении</h3>
                                    <p data-ru="В нижней части вкладки отображается информация о версии приложения и его назначении." data-en="Information about the application version and its purpose is displayed at the bottom of the tab.">В нижней части вкладки отображается информация о версии приложения и его назначении.</p>

                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Examples Section Card -->
                    <div class="tab-content" id="examples-content" role="tabpanel" aria-labelledby="examples-button">
                        <div class="swipeable-content">
                            <!-- Card 1: Basic Examples - Part 1 -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Примеры использования - Часть 1" data-en="Usage Examples - Part 1">Примеры использования - Часть 1</h3>

                                    <div class="example">
                                        <h4 data-ru="Пример 1: Добавление выигрышного опциона" data-en="Example 1: Adding a winning option">Пример 1: Добавление выигрышного опциона</h4>
                                        <ol class="step-list">
                                            <li data-ru="Откройте вкладку <strong>Daily</strong>" data-en='Open the <strong>Daily</strong> tab'>Откройте вкладку <strong>Daily</strong></li>
                                            <li data-ru="Нажмите кнопку <strong>+ Add Trade</strong> в нижней части экрана" data-en='Click the <strong>"+ Add Trade"</strong> button at the bottom of the screen'>Нажмите кнопку <strong>"+ Add Trade"</strong> в нижней части экрана</li>
                                            <li data-ru='В новой строке нажмите на ячейку "Click to enter amount" в столбце <strong>Trade Amount</strong>' data-en='In the new row, click on the "Click to enter amount" cell in the <strong>Trade Amount</strong> column'>В новой строке нажмите на ячейку "Click to enter amount" в столбце <strong>Trade Amount</strong></li>
                                            <li data-ru='Введите сумму опциона, например <strong>100</strong>, и нажмите "Save"' data-en='Enter the option amount, for example <strong>100</strong>, and click "Save"'>Введите сумму опциона, например <strong>100</strong>, и нажмите "Save"</li>
                                            <li data-ru="Нажмите на ячейку в столбце <strong>Profit/Loss Refund</strong>" data-en="Click on the cell in the <strong>Profit/Loss Refund</strong> column">Нажмите на ячейку в столбце <strong>Profit/Loss Refund</strong></li>
                                            <li data-ru="Выберите <strong>Profit</strong> и введите сумму выигрыша, например <strong>80</strong>" data-en="Select <strong>Profit</strong> and enter the winnings amount, for example <strong>80</strong>">Выберите <strong>Profit</strong> и введите сумму выигрыша, например <strong>80</strong></li>
                                            <li data-ru="Нажмите на ячейку в столбце <strong>Emotional State</strong> и выберите подходящую эмоцию, например <strong>Joy</strong>" data-en="Click on the cell in the <strong>Emotional State</strong> column and select an appropriate emotion, for example <strong>Joy</strong>">Нажмите на ячейку в столбце <strong>Emotional State</strong> и выберите подходящую эмоцию, например <strong>Joy</strong></li>
                                            <li data-ru='Добавьте комментарий в столбце <strong>Comments</strong>, например "Хороший сигнал на EUR/USD"' data-en='Add a comment in the <strong>Comments</strong> column, for example "Good signal on EUR/USD"'>Добавьте комментарий в столбце <strong>Comments</strong>, например "Хороший сигнал на EUR/USD"</li>
                                        </ol>
                                        <p data-ru="После выполнения этих шагов опцион будет добавлен в таблицу, а баланс автоматически пересчитан." data-en="After completing these steps, the option will be added to the table, and the balance will be recalculated automatically.">После выполнения этих шагов опцион будет добавлен в таблицу, а баланс автоматически пересчитан.</p>
                                    </div>

                                </div>
                            </div>

                            <!-- Card 2: Basic Examples - Part 2 -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Примеры использования - Часть 2" data-en="Usage Examples - Part 2">Примеры использования - Часть 2</h3>

                                    <div class="example">
                                        <h4 data-ru="Пример 2: Установка дневных целей" data-en="Example 2: Setting daily goals">Пример 2: Установка дневных целей</h4>
                                        <ol class="step-list">
                                            <li data-ru="Перейдите на вкладку <strong>Monthly</strong>" data-en="Go to the <strong>Monthly</strong> tab">Перейдите на вкладку <strong>Monthly</strong></li>
                                            <li data-ru="Выберите нужный месяц с помощью стрелок навигации" data-en="Select the required month using navigation arrows">Выберите нужный месяц с помощью стрелок навигации</li>
                                            <li data-ru="Найдите нужный день в таблице (сегодняшний день выделен)" data-en="Find the required day in the table (today's day is highlighted)">Найдите нужный день в таблице (сегодняшний день выделен)</li>
                                            <li data-ru="Нажмите на ячейку в столбце <strong>Profit Target</strong> для дня" data-en="Click on the cell in the <strong>Profit Target</strong> column for the day">Нажмите на ячейку в столбце <strong>Profit Target</strong> для дня</li>
                                            <li data-ru="Введите желаемую цель по прибыли, например <strong>5</strong> (5% от начального баланса)" data-en="Enter the desired profit target, for example <strong>5</strong> (5% of initial balance)">Введите желаемую цель по прибыли, например <strong>5</strong> (5% от начального баланса)</li>
                                            <li data-ru="Аналогично установите цель по убыткам в столбце <strong>Loss Target</strong>, например <strong>-3</strong>" data-en="Similarly, set the loss target in the <strong>Loss Target</strong> column, for example <strong>-3</strong>">Аналогично установите цель по убыткам в столбце <strong>Loss Target</strong>, например <strong>-3</strong></li>
                                        </ol>
                                        <p data-ru="Установленные цели будут отображаться в прогресс-баре на вкладке Daily." data-en="The set goals will be displayed in the progress bar on the Daily tab.">Установленные цели будут отображаться в прогресс-баре на вкладке Daily.</p>
                                    </div>

                                </div>
                            </div>

                            <!-- Card 3: Advanced Examples - Part 1 -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Примеры использования - Часть 3" data-en="Usage Examples - Part 3">Примеры использования - Часть 3</h3>

                                    <div class="example">
                                        <h4 data-ru="Пример 3: Добавление вывода средств" data-en="Example 3: Adding a withdrawal">Пример 3: Добавление вывода средств</h4>
                                        <ol class="step-list">
                                            <li data-ru="Откройте вкладку <strong>Monthly</strong>" data-en="Open the <strong>Monthly</strong> tab">Откройте вкладку <strong>Monthly</strong></li>
                                            <li data-ru="Убедитесь, что выбран текущий месяц" data-en="Make sure the current month is selected">Убедитесь, что выбран текущий месяц</li>
                                            <li data-ru="Нажмите кнопку <strong>+ Add Withdrawal</strong>" data-en='Click the <strong>"+ Add Withdrawal"</strong> button'>Нажмите кнопку <strong>"+ Add Withdrawal"</strong></li>
                                            <li data-ru="Введите сумму вывода, например <strong>500</strong>" data-en="Enter the withdrawal amount, for example <strong>500</strong>">Введите сумму вывода, например <strong>500</strong></li>
                                            <li data-ru="Нажмите <strong>Save</strong>" data-en="Click <strong>Save</strong>">Нажмите <strong>Save</strong></li>
                                        </ol>
                                        <p data-ru="Вывод будет добавлен в таблицу выводов, а текущий баланс автоматически пересчитан." data-en="The withdrawal will be added to the withdrawal table, and the current balance will be automatically recalculated.">Вывод будет добавлен в таблицу выводов, а текущий баланс автоматически пересчитан.</p>
                                    </div>

                                </div>
                            </div>

                            <!-- Card 4: Advanced Examples and Notes -->
                            <div class="content-section">
                                <div class="content">
                                    <h3 data-ru="Примеры использования - Часть 4" data-en="Usage Examples - Part 4">Примеры использования - Часть 4</h3>

                                    <div class="example">
                                        <h4 data-ru="Пример 4: Анализ месячной статистики" data-en="Example 4: Analyzing monthly statistics">Пример 4: Анализ месячной статистики</h4>
                                        <ol class="step-list">
                                            <li data-ru="Перейдите на вкладку <strong>Monthly</strong>" data-en="Go to the <strong>Monthly</strong> tab">Перейдите на вкладку <strong>Monthly</strong></li>
                                            <li data-ru="Просмотрите таблицу дневной статистики" data-en="Review the daily statistics table">Просмотрите таблицу дневной статистики</li>
                                            <li data-ru="Оцените достижение целей в столбцах <strong>Actual P/L</strong>" data-en="Assess goal achievement in the <strong>Actual P/L</strong> columns">Оцените достижение целей в столбцах <strong>Actual P/L</strong></li>
                                            <li data-ru="Посмотрите количество выигрышных и проигрышных опционов" data-en="Look at the number of winning and losing options">Посмотрите количество выигрышных и проигрышных опционов</li>
                                            <li data-ru="Добавьте комментарии к месяцу в поле в нижней части экрана" data-en="Add comments to the month in the field at the bottom of the screen">Добавьте комментарии к месяцу в поле в нижней части экрана</li>
                                        </ol>
                                        <p data-ru="Используйте эту информацию для корректировки торговой стратегии." data-en="Use this information to adjust your trading strategy.">Используйте эту информацию для корректировки торговой стратегии.</p>
                                    </div>

                                    <div class="important">
                                        <strong data-ru="Важные замечания:" data-en="Important notes:">Важные замечания:</strong>
                                        <ul>
                                            <li data-ru="Все данные сохраняются автоматически при внесении изменений" data-en="All data is saved automatically when changes are made">Все данные сохраняются автоматически при внесении изменений</li>
                                            <li data-ru="Редактирование возможно только для текущего дня и текущего месяца" data-en="Editing is only possible for the current day and current month">Редактирование возможно только для текущего дня и текущего месяца</li>
                                            <li data-ru="Прошлые дни доступны только для просмотра" data-en="Past days are only available for viewing">Прошлые дни доступны только для просмотра</li>
                                            <li data-ru="Регулярно делайте резервные копии важных данных" data-en="Regularly make backups of important data">Регулярно делайте резервные копии важных данных</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Back to Top Button -->
            <button id="back-to-top" class="back-to-top" aria-label="Наверх">
                ↑
            </button>

            <!-- Card Navigation Buttons -->
            <div class="card-navigation-buttons">
                <button class="nav-btn prev-btn" disabled data-ru="← Предыдущая" data-en="← Previous">← Предыдущая</button>
                <span class="card-counter" data-ru="1 из 4" data-en="1 of 4">1 из 4</span>
                <button class="nav-btn next-btn" data-ru="Следующая →" data-en="Next →">Следующая →</button>
            </div>
        </div>
    </div>

    <!-- стили для гида дневника -->
    <style id="guide-styles">
        /* CSS Variables for Light and Dark Themes */
        #guideContainer:root {
            --guide-bg-color: #ffffff;
            --guide-text-color: #2c3e50;
            --guide-secondary-bg: rgba(235, 232, 232, 0.95);
            --guide-hint-color: rgba(0, 0, 0, 0.3);
            --guide-button-color: #3498db;
            --guide-button-text-color: #ffffff;
            --guide-border-color: #a0a0a0;
            --guide-shadow-color: rgba(0, 0, 0, 0.8);
            --guide-positive-color: #2ecc71;
            --guide-negative-color: #e74c3c;
            --guide-refund-color: #3498db;
            --guide-profit-bg: #e8f5e9;
            --guide-loss-bg: #ffebee;
            --guide-refund-bg: #e3f2fd;
            --guide-cell-bg: #fafafa;
            --guide-cell-hover-bg: #e3f2fd;
            --guide-modal-bg: #ffffff;
            --guide-input-bg: #ffffff;
            --guide-input-border: #ddd;
            --guide-progress-bg: #e0e0e0;
            --guide-progress-profit: #4CAF50;
            --guide-progress-loss: #F44336;
            --guide-tab-bg: #ecf0f1;
            --guide-tab-active-bg: #3498db;
            --guide-notification-success: #27ae60;
            --guide-notification-error: #e74c3c;
        }

        #guideContainer[data-theme="dark"] {
            --guide-bg-color: #242424;
            --guide-text-color: #dddddd;
            --guide-secondary-bg: #2d2d2d;
            --guide-hint-color: rgba(255, 255, 255, 0.3);
            --guide-button-color: #3498db;
            --guide-button-text-color: #dddddd;
            --guide-border-color: #7c7c7c;
            --guide-shadow-color: rgba(0, 0, 0, 0.8);
            --guide-positive-color: #4CAF50;
            --guide-negative-color: #F44336;
            --guide-refund-color: #2196F3;
            --guide-profit-bg: #1b2e1b;
            --guide-loss-bg: #2e1b1b;
            --guide-refund-bg: #1b1e2e;
            --guide-cell-bg: #2d2d2d;
            --guide-cell-hover-bg: #3d3d3d;
            --guide-modal-bg: #2d2d2d;
            --guide-input-bg: #3d3d3d;
            --guide-input-border: #555555;
            --guide-progress-bg: #444444;
            --guide-progress-profit: #4CAF50;
            --guide-progress-loss: #F44336;
            --guide-tab-bg: #2d2d2d;
            --guide-tab-active-bg: #3498db;
            --guide-notification-success: #4CAF50;
            --guide-notification-error: #F44336;
        }

        #guideContainer * {
            box-sizing: border-box;
        }

        #guideContainer {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--guide-text-color);
            max-width: 1000px;
            margin: 0 auto;
            padding: 5px;
            padding-bottom: 1px; /* Increased space for fixed navigation */
            background: var(--guide-bg-color);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            position: relative;
        }

        /* Very small screens */
        @media (max-width: 360px) {
            #guideContainer {
                padding: 1px;
                font-size: 12px;
                padding-bottom: 1px; /* Ensure adequate bottom padding on very small screens */
            }

            #guideContainer .swipeable-content {
                max-height: calc(100vh - 210px); /* Adjust for very small screens */
            }

            #guideContainer .content-section {
                min-height: calc(100vh - 210px); /* Adjust for very small screens */
            }

            #guideContainer .header {
                padding: 12px 10px;
                margin-bottom: 5px;
            }

            #guideContainer .header h1 {
                font-size: 1.2em;
            }

            #guideContainer .header p {
                font-size: 0.8em;
                margin: 2px 0 0 0;
            }

            #guideContainer .content {
                padding: 8px;
                margin-bottom: 8px;
            }

            #guideContainer .tab-button {
                min-width: 45px;
                max-width: 45px;
                padding: 1px 0.5px;
                margin: 0.5px;
            }

            #guideContainer .tab-icon {
                font-size: 0.75em;
            }

            #guideContainer .tab-text {
                font-size: 0.5em;
            }

            #guideContainer .tab-title {
                font-size: 1.3em;
                margin-bottom: 10px;
                padding-left: 8px;
            }

            #guideContainer .element-description {
                padding: 8px;
                margin: 8px 0;
            }

            #guideContainer .example {
                padding: 8px;
                margin: 8px 0;
            }

            #guideContainer .important {
                padding: 8px;
                margin: 8px 0;
            }

            #guideContainer .feature-item {
                padding: 6px;
            }

            #guideContainer .card-navigation {
                margin-top: 6px;
                padding: 4px 3px;
                gap: 2px;
            }

            #guideContainer .nav-btn {
                min-height: 28px;
                padding: 5px 8px;
                font-size: 0.75em;
            }

            #guideContainer .card-counter {
                font-size: 0.7em;
                margin: 0 2px;
            }
        }

        .header {
            text-align: center;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 20px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            position: relative;
        }
        
        .header > h1 {
            margin: 0 60px; /* Leave space for buttons */
            font-size: 1.8em;
            font-weight: 300;
            letter-spacing: 1px;
        }
        
        .header > p {
            margin: 3px 60px 0 60px; /* Leave space for buttons */
            font-size: 1em;
            opacity: 0.9;
        }

        .header-actions {
            position: absolute;
            top: 5px;
            right: 10px;
            display: flex;
            gap: 10px;
        }
        
        .header-left-actions {
            position: absolute;
            top: 5px;
            left: 10px;
            display: flex;
            gap: 10px;
        }
        
        .header-right-actions {
            position: absolute;
            top: 5px;
            right: 10px;
            display: flex;
            gap: 10px;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .search-container {
            margin: 20px 0;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text-color);
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--button-color);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--hint-color);
            font-size: 18px;
        }

        .progress-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 8px;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--progress-bg);
            transition: background-color 0.3s ease;
            cursor: pointer;
        }

        .progress-dot.active {
            background: var(--button-color);
        }

        .header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .header p {
            margin: 3px 0 0 0;
            font-size: 1em;
            opacity: 0.9;
        }

        /* Mobile Navigation Toggle */
        .mobile-nav-toggle {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            outline: none;
        }

        .mobile-nav-toggle button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            transition: all 0.3s;
            outline: none;
        }

        .mobile-nav-toggle button:hover {
            background: linear-gradient(135deg, #2980b9 0%, #21618c 100%);
            transform: scale(1.05);
        }

        .mobile-nav-toggle button span {
            width: 25px;
            height: 3px;
            background: white;
            margin: 2px 0;
            transition: all 0.3s;
            border-radius: 2px;
        }

        .mobile-nav-toggle button.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .mobile-nav-toggle button.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-nav-toggle button.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* Navigation */
        .navigation {
            background: #34495e;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .navigation.open {
            max-height: 500px;
        }

        .navigation h2 {
            margin-top: 0;
            text-align: center;
        }

        .nav-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: #adb5bd;
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .nav-links a:hover {
            background: #495057;
            color: white;
        }

        /* Horizontal Tab Navigation for Guide */
        #guideContainer .tab-navigation {
            display: flex;
            background: var(--guide-secondary-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            margin-bottom: 0px;
            overflow-x: auto;
            -ms-overflow-style: none;
            padding: 0 10px;
            justify-content: center;
            scrollbar-width: thin;
            scrollbar-color: rgba(0,0,0,0.2) transparent;
            border: 1px solid var(--guide-border-color);
        }

        #guideContainer .tab-navigation::-webkit-scrollbar {
            display: none;
        }

        #guideContainer .tab-button {
            flex: 0 0;
            min-width: 50px;
            max-width: 60px;
            padding: 8px 4px;
            background: var(--guide-cell-bg);
            border: 1px solid var(--border-color);
            color: var(--guide-text-color);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            position: relative;
            border-radius: 10px;
            margin: 4px;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            outline: none;
            /* Изолируем стили от основного приложения */
            z-index: 1000;
        }
        
        #guideContainer .tab-button:hover {
            background: var(--guide-cell-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        #guideContainer .tab-button.active {
            background: var(--guide-button-color);
            color: var(--guide-button-text-color);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        #guideContainer .tab-content {
            display: none;
            background: var(--guide-bg-color);
            border-radius: 12px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            overflow: hidden;
            animation: guideFadeIn 0.5s ease-in-out;
            border: 1px solid var(--guide-border-color);
            /* Изолируем контент вкладок гида */
            position: relative;
            z-index: 1000;
        }

        #guideContainer .tab-button:hover {
            background: var(--guide-cell-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #guideContainer .tab-button.active {
            background: var(--guide-button-color);
            color: var(--guide-button-text-color);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.9);
        }

        #guideContainer .tab-button.active .tab-icon {
            transform: scale(1.1);
        }

        #guideContainer .tab-icon {
            font-size: 1.4em;
            transition: transform 0.3s ease;
        }

        #guideContainer .tab-text {
            font-size: 0.65em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Tab Content for Guide */
        #guideContainer .tab-content-container {
            position: relative;
        }

        #guideContainer .tab-content {
            display: none;
            background: var(--guide-bg-color);
            border-radius: 12px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.08);
            overflow: hidden;
            animation: guideFadeIn 0.5s ease-in-out;
            border: 1px solid var(--guide-border-color);
        }

        #guideContainer .tab-content.active {
            display: block;
        }

        @keyframes guideFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #guideContainer .tab-content {
            animation: guideFadeIn 0.5s ease-in-out;
        }

        /* Swipeable Content */
        .swipeable-content {
            position: relative;
            overflow-x: auto;
            -ms-overflow-style: none;
            scroll-snap-type: x mandatory;
            display: flex;
            width: 100%;
            max-height: calc(100vh - 200px); /* Account for header, navigation, and bottom buttons */
            scrollbar-width: thin;
            scrollbar-color: rgba(0,0,0,0.2) transparent;
        }

        .swipeable-content::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .swipeable-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .swipeable-content::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }

        .swipeable-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }

        .content-section {
            min-width: 100%;
            max-width: 100%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            scroll-snap-align: start;
            box-sizing: border-box;
            min-height: calc(100vh - 200px); /* Ensure minimum height accounts for navigation */
        }

        /* Swipe Indicators */
        .swipe-indicator {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .swipe-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
        }

        .swipe-dot.active {
            background: #667eea;
            transform: scale(1.2);
        }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            z-index: 1000;
            outline: none;
        }

        .back-to-top.show {
            opacity: 1;
            visibility: visible;
        }

        .back-to-top:hover {
            background: linear-gradient(135deg, #2980b9 0%, #21618c 100%);
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        /* Content Styles */
        .content {
            background: var(--bg-color);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }

        .tab-section {
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
        }

        .tab-section:last-child {
            border-bottom: none;
        }

        .tab-title {
            color: var(--text-color);
            font-size: 2em;
            margin-bottom: 10px;
            border-left: 5px solid var(--button-color);
            padding-left: 15px;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .screenshot {
            display: none;
        }

        .element-description {
            background: var(--secondary-bg);
            padding: 10px;
            border-radius: 8px;
            margin: 8px 0;
            border-left: 4px solid var(--button-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }

        .element-title {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .example {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .example h4 {
            color: var(--button-color);
            margin-top: 0;
            font-weight: 600;
        }

        .step-list {
            counter-reset: step-counter;
            list-style: none;
        }

        .step-list li {
            counter-increment: step-counter;
            margin-bottom: 6px;
            padding-left: 30px;
            position: relative;
        }

        .step-list li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            background: var(--button-color);
            color: var(--button-text-color);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            line-height: 20px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
        }

        .highlight {
            background-color: #fff8e1;
            border: 1px solid #ffcc02;
            border-radius: 4px;
            padding: 2px 2px;
            font-weight: 500;
            color: #f39c12;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .profit-text {
            color: var(--positive-color);
            font-weight: 600;
        }

        .loss-text {
            color: var(--negative-color);
            font-weight: 600;
        }

        .refund-text {
            color: var(--refund-color);
            font-weight: 600;
        }

        .important {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            border: 1px solid #e17055;
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            box-shadow: 0 2px 10px rgba(231, 112, 85, 0.2);
            color: #000000;
        }

        [data-theme="dark"] .important {
            color: #000000;
        }

        [data-theme="dark"] .important li::marker {
            color: #000000;
        }

        .important::before {
            content: "⚠️ ";
            font-weight: bold;
        }

        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .feature-item {
            background: var(--secondary-bg);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }

        .feature-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .feature-item h4 {
            margin-top: 0;
            color: var(--text-color);
            font-weight: 600;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            body {
                padding: 3px;
                font-size: 14px;
                -webkit-text-size-adjust: 100%;
                text-size-adjust: 100%;
                max-width: 100%;
            }

            .swipeable-content {
                max-height: calc(100vh - 180px); /* Adjust for mobile screen */
            }

            .content-section {
                min-height: calc(100vh - 180px); /* Adjust for mobile screen */
            }

            .header {
                padding: 12px 15px;
                margin-bottom: 10px;
            }

            .header h1 {
                font-size: 1.4em;
                margin: 0;
            }

            .header p {
                font-size: 0.9em;
                margin: 4px 0 0 0;
            }

            .content {
                padding: 12px;
                margin-bottom: 12px;
            }

            .feature-list {
                grid-template-columns: 1fr;
                gap: 8px;
                margin: 12px 0;
            }

            .tab-navigation {
                padding: 2px;
                margin: 0 2px 3px 2px;
                overflow-x: auto;
            }

            .tab-navigation::-webkit-scrollbar {
                width: 4px;
                height: 4px;
            }

            .tab-navigation::-webkit-scrollbar-track {
                background: transparent;
            }

            .tab-navigation::-webkit-scrollbar-thumb {
                background: rgba(0,0,0,0.2);
                border-radius: 2px;
            }

            .tab-navigation::-webkit-scrollbar-thumb:hover {
                background: rgba(0,0,0,0.3);
            }

            .tab-button {
                min-width: 55px;
                max-width: 55px;
                padding: 2px 1px;
                margin: 1px;
                flex-shrink: 0;
                touch-action: manipulation;
            }

            .nav-btn {
                min-height: 32px;
                padding: 5px 8px;
                font-size: 0.75em;
                flex-shrink: 0;
            }

            .tab-icon {
                font-size: 0.9em;
            }

            .tab-text {
                font-size: 0.6em;
                line-height: 1.1;
            }

            .content-section {
                padding: 0 6px;
                box-sizing: border-box;
            }

            .swipe-indicator {
                display: flex;
            }

            .swipeable-content {
                scroll-behavior: smooth;
            }

            .tab-title {
                font-size: 1.6em;
                margin-bottom: 15px;
                padding-left: 12px;
            }

            .element-description {
                padding: 12px;
                margin: 12px 0;
            }

            .example {
                padding: 12px;
                margin: 12px 0;
            }

            .step-list li {
                padding-left: 22px;
                margin-bottom: 4px;
            }

            .step-list li::before {
                width: 16px;
                height: 16px;
                font-size: 10px;
                line-height: 16px;
            }

            .important {
                padding: 12px;
                margin: 12px 0;
            }

            .feature-item {
                padding: 10px;
            }
        }

        /* Card Navigation */
        .card-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding: 6px;
            border-top: 1px solid var(--border-color);
            background: var(--secondary-bg);
            border-radius: 6px;
        }

        .nav-btn {
            background: var(--button-color);
            color: var(--button-text-color);
            border: inherit;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 3px;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
            outline: none;
            min-height: 44px;
            min-width: 44px;
            justify-content: center;
        }

        .nav-btn:hover:not(:disabled) {
            background: var(--button-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(69, 172, 241, 0.952);
            opacity: 0.9;
        }

        .nav-btn:disabled {
            background: var(--progress-bg);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .card-counter {
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9em;
        }

        /* Card Navigation Buttons */
        .card-navigation-buttons {
            position: fixed;
            bottom: 5px;
            width: 99%;
            transform: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 5px 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            backdrop-filter: blur(10px);
            margin: 0 auto;
            left: 0;
            right: 0;
            max-width: 1000px; /* Match body max-width */
        }

        /* Corner Buttons */
        .corner-btn {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            outline: none;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .corner-btn:hover {
            background: var(--cell-hover-bg);
            transform: scale(1.3);
        }

        .language-btn {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            z-index: 1000;
        }

        .language-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .theme-btn {
            position: static;
        }
        
        .close-btn {
            position: static;
            white-space: nowrap;
            width: auto;
            padding: 2px 2px;
            font-size: 10px;
        }
        
        .header-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }
        
        .header-left-actions {
            position: absolute;
            top: 5px;
            left: 5px;
            display: flex;
            gap: 10px;
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .tab-button {
                min-height: 40px;
                padding: 5px 2px;
            }

            .tab-button:active {
                transform: scale(0.95);
            }

            .swipeable-content {
                scroll-behavior: smooth;
                overscroll-behavior-x: contain;
                overflow-y: auto;
            }

            .content-section {
                touch-action: pan-x;
            }

            .nav-btn {
                min-height: 36px;
                padding: 7px 12px;
                font-size: 0.9em;
                flex-shrink: 0;
            }

            .back-to-top {
                width: 48px;
                height: 48px;
                font-size: 1.0em;
            }

            body {
                overflow-y: auto;
                -webkit-text-size-adjust: 100%;
                text-size-adjust: 100%;
                -webkit-tap-highlight-color: rgba(52, 152, 219, 0.2);
            }

            .content {
                -webkit-tap-highlight-color: rgba(52, 152, 219, 0.2);
                touch-action: manipulation;
            }

            .card-navigation {
                margin-top: 6px;
                padding: 5px;
                flex-wrap: wrap;
                justify-content: space-between;
            }

            .card-counter {
                font-size: 0.9em;
                flex-shrink: 0;
            }
        }

        /* Extra small screens (phones < 480px) */
        @media (max-width: 480px) {
            body {
                padding: 2px;
                font-size: 13px;
                padding-bottom: 1px; /* Ensure adequate bottom padding on small screens */
            }

            .swipeable-content {
                max-height: calc(100vh - 160px); /* Adjust for extra small screens */
            }

            .content-section {
                min-height: calc(100vh - 160px); /* Adjust for extra small screens */
            }

            .header {
                padding: 10px 12px;
                margin-bottom: 8px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .header p {
                font-size: 0.85em;
                margin: 3px 0 0 0;
            }

            .content {
                padding: 10px;
                margin-bottom: 10px;
            }

            .tab-navigation {
                padding: 1px;
                margin: 0 1px 2px 1px;
            }

            .tab-button {
                min-width: 50px;
                max-width: 50px;
                padding: 1px 0.5px;
                margin: 0.5px;
            }

            .tab-icon {
                font-size: 0.8em;
            }

            .tab-text {
                font-size: 0.55em;
            }

            .tab-title {
                font-size: 1.4em;
                margin-bottom: 12px;
                padding-left: 10px;
            }

            .element-description {
                padding: 10px;
                margin: 10px 0;
            }

            .example {
                padding: 10px;
                margin: 10px 0;
            }

            .important {
                padding: 10px;
                margin: 10px 0;
            }

            .feature-item {
                padding: 8px;
            }

            .card-navigation {
                flex-direction: row;
                gap: 3px;
                margin-top: 8px;
                padding: 6px 4px;
                align-items: center;
            }

            .nav-btn {
                min-height: 30px;
                padding: 6px 10px;
                font-size: 0.8em;
                justify-content: center;
                flex: 1;
                max-width: none;
            }

            .nav-btn span {
                font-size: 0.8em;
                line-height: 1.2;
            }

            .card-counter {
                text-align: center;
                font-size: 0.75em;
                margin: 0 3px;
                flex-shrink: 0;
                line-height: 1.4;
            }

            .card-navigation .nav-btn:first-child {
                margin-right: 0;
            }

            .card-navigation .nav-btn:last-child {
                margin-left: 0;
            }
        }
    </style>
    
    <!-- функции для гида -->
    <script>
        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }

        // Utility functions for performance optimization
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Theme Manager
        class ThemeManager {
            constructor() {
                this.currentTheme = localStorage.getItem('guide-theme') || 'dark';
                this.init();
            }

            init() {
                this.applyTheme(this.currentTheme);
                this.bindEvents();
            }

            applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('guide-theme', theme);
                this.currentTheme = theme;
            }

            toggleTheme() {
                const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
                this.applyTheme(newTheme);
            }

            bindEvents() {
                const themeBtn = document.getElementById('theme-toggle');
                if (themeBtn) {
                    themeBtn.addEventListener('click', () => this.toggleTheme());
                }
            }
        }

        // Language Manager
        class LanguageManager {
            constructor() {
                this.currentLanguage = localStorage.getItem('guide-language') || 'ru';
                this.init();
            }

            init() {
                this.applyLanguage(this.currentLanguage);
                this.bindEvents();
            }

            applyLanguage(language) {
                // Update HTML lang attribute
                document.documentElement.setAttribute('lang', language);

                // Update all elements with data attributes
                const elements = document.querySelectorAll('[data-ru], [data-en]');
                elements.forEach(element => {
                    const text = element.getAttribute(`data-${language}`);
                    if (text !== null) {
                        if (element.tagName === 'META') {
                            element.setAttribute('content', text);
                        } else if (element.tagName === 'TITLE') {
                            document.title = text;
                        } else {
                            element.innerHTML = text;
                        }
                    }
                });

                // Update toggle button text
                const toggleBtn = document.getElementById('language-toggle');
                if (toggleBtn) {
                    toggleBtn.textContent = language === 'ru' ? 'EN' : 'RU';
                }

                localStorage.setItem('guide-language', language);
                this.currentLanguage = language;
            }

            toggleLanguage() {
                const newLanguage = this.currentLanguage === 'ru' ? 'en' : 'ru';
                this.applyLanguage(newLanguage);
            }

            bindEvents() {
                const languageBtn = document.getElementById('language-toggle');
                if (languageBtn) {
                    languageBtn.addEventListener('click', () => this.toggleLanguage());
                }
            }
        }

        // Search Manager
        class SearchManager {
            constructor() {
                this.searchInput = document.getElementById('search-input');
                this.searchableContent = [];
                this.init();
            }

            init() {
                this.collectSearchableContent();
                this.bindEvents();
            }

            collectSearchableContent() {
                const sections = document.querySelectorAll('.content-section');
                sections.forEach((section, index) => {
                    const title = section.querySelector('h3')?.textContent || '';
                    const content = section.textContent;
                    this.searchableContent.push({
                        index,
                        title,
                        content,
                        element: section
                    });
                });
            }

            bindEvents() {
                if (this.searchInput) {
                    this.searchInput.addEventListener('input', debounce(() => {
                        this.performSearch(this.searchInput.value);
                    }, 300));
                }
            }

            performSearch(query) {
                if (!query.trim()) {
                    this.clearHighlights();
                    return;
                }

                const lowerQuery = query.toLowerCase();
                let hasResults = false;

                this.searchableContent.forEach(item => {
                    const matches = item.title.toLowerCase().includes(lowerQuery) ||
                                  item.content.toLowerCase().includes(lowerQuery);

                    if (matches) {
                        this.highlightSection(item.element);
                        hasResults = true;
                    } else {
                        this.unhighlightSection(item.element);
                    }
                });

                if (!hasResults) {
                    this.showNoResults();
                }
            }

            highlightSection(element) {
                element.style.display = 'block';
                element.style.opacity = '1';
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            unhighlightSection(element) {
                element.style.display = 'none';
            }

            clearHighlights() {
                this.searchableContent.forEach(item => {
                    item.element.style.display = 'block';
                    item.element.style.opacity = '1';
                });
            }

            showNoResults() {
                // Could add a "no results" message
                console.log('No search results found');
            }
        }

        // Progress Manager
        class ProgressManager {
            constructor() {
                this.progressIndicator = document.getElementById('progress-indicator');
                this.tabs = ['general', 'table', 'history', 'settings', 'examples'];
                this.currentTab = 'general';
                this.init();
            }

            init() {
                this.createProgressDots();
                this.updateProgress();
            }

            createProgressDots() {
                if (!this.progressIndicator) return;

                this.progressIndicator.innerHTML = '';
                this.tabs.forEach((tab, index) => {
                    const dot = document.createElement('div');
                    dot.className = 'progress-dot';
                    dot.dataset.tab = tab;
                    dot.addEventListener('click', () => this.navigateToTab(tab));
                    this.progressIndicator.appendChild(dot);
                });
            }

            updateProgress() {
                const dots = this.progressIndicator?.querySelectorAll('.progress-dot');
                if (!dots) return;

                dots.forEach((dot, index) => {
                    const isActive = this.tabs[index] === this.currentTab;
                    dot.classList.toggle('active', isActive);
                });
            }

            navigateToTab(tabId) {
                this.currentTab = tabId;
                this.updateProgress();

                // Trigger tab switch
                const tabButton = document.querySelector(`[data-tab="${tabId}"]`);
                if (tabButton) {
                    tabButton.click();
                }
            }

            setCurrentTab(tabId) {
                this.currentTab = tabId;
                this.updateProgress();
            }
        }

        // Card Navigation Buttons Manager
        class CardNavigationButtonsManager {
            constructor() {
                this.prevBtn = document.querySelector('.card-navigation-buttons .prev-btn');
                this.nextBtn = document.querySelector('.card-navigation-buttons .next-btn');
                this.counter = document.querySelector('.card-navigation-buttons .card-counter');
                this.cardNavManager = null;
                this.progressManager = null;
                this.init();
            }

            setManagers(cardNavManager, progressManager) {
                this.cardNavManager = cardNavManager;
                this.progressManager = progressManager;
            }

            init() {
                if (this.prevBtn) {
                    this.prevBtn.addEventListener('click', () => this.navigateCard(-1));
                }
                if (this.nextBtn) {
                    this.nextBtn.addEventListener('click', () => this.navigateCard(1));
                }
            }

            navigateCard(direction) {
                if (this.cardNavManager && this.progressManager) {
                    this.cardNavManager.navigateCard(this.progressManager.currentTab, direction);
                }
            }

            updateButtons(tabId) {
                const tabContent = document.getElementById(`${tabId}-content`);
                if (!tabContent || !this.cardNavManager) return;

                const contentSections = tabContent.querySelectorAll('.content-section');
                const currentIndex = this.cardNavManager.currentCards.get(tabId) || 0;

                if (this.prevBtn) this.prevBtn.disabled = (currentIndex === 0);
                if (this.nextBtn) this.nextBtn.disabled = (currentIndex === contentSections.length - 1);
                if (this.counter) this.counter.textContent = `${currentIndex + 1} из ${contentSections.length}`;
            }
        }

        // Tab Manager for horizontal navigation
        class TabManager {
            constructor() {
                this.tabs = document.querySelectorAll('.tab-button');
                this.contents = document.querySelectorAll('.tab-content');
                this.activeTab = 'general';
                this.init();
            }

            init() {
                this.tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchTab(tab.dataset.tab);
                    });

                    // Keyboard navigation
                    tab.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            this.switchTab(tab.dataset.tab);
                        }

                        // Arrow key navigation
                        if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                            e.preventDefault();
                            this.navigateTabs(e.key === 'ArrowLeft' ? -1 : 1);
                        }
                    });
                });

                // Initialize first tab
                this.switchTab(this.activeTab);
            }

            switchTab(tabId) {
                // Update tab states
                this.tabs.forEach(tab => {
                    const isActive = tab.dataset.tab === tabId;
                    tab.classList.toggle('active', isActive);
                    tab.setAttribute('aria-selected', isActive);
                });

                // Update content states
                this.contents.forEach(content => {
                    const isActive = content.id === `${tabId}-content`;
                    content.classList.toggle('active', isActive);
                    content.setAttribute('aria-hidden', !isActive);
                });

                this.activeTab = tabId;

                // Notify progress manager
                if (this.onTabSwitch) {
                    this.onTabSwitch(tabId);
                }

                // Scroll tab into view on mobile
                if (window.innerWidth <= 768) {
                    const activeTab = document.querySelector(`[data-tab="${tabId}"]`);
                    if (activeTab) {
                        activeTab.scrollIntoView({
                            behavior: 'smooth',
                            block: 'nearest',
                            inline: 'center'
                        });
                    }
                }
            }

            navigateTabs(direction) {
                const currentIndex = Array.from(this.tabs).findIndex(tab => tab.dataset.tab === this.activeTab);
                const newIndex = Math.max(0, Math.min(this.tabs.length - 1, currentIndex + direction));
                const newTabId = this.tabs[newIndex].dataset.tab;
                this.switchTab(newTabId);
            }
        }

        // Card Navigation Manager
        class CardNavigationManager {
            constructor() {
                this.currentCards = new Map(); // tabId -> current card index
                this.init();
            }

            init() {
                // Initialize card counters for each tab
                document.querySelectorAll('.tab-content').forEach(tabContent => {
                    const tabId = tabContent.id.replace('-content', '');
                    this.currentCards.set(tabId, 0);
                    this.updateNavigation(tabId);
                });

                // Add event listeners for navigation buttons
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('nav-btn') && !e.target.disabled) {
                        const tabContent = e.target.closest('.tab-content');
                        if (tabContent) {
                            const tabId = tabContent.id.replace('-content', '');
                            const direction = e.target.classList.contains('next-btn') ? 1 : -1;
                            this.navigateCard(tabId, direction);
                        }
                    }
                });
            }

            navigateCard(tabId, direction) {
                const tabContent = document.getElementById(`${tabId}-content`);
                if (!tabContent) return;

                const swipeableContent = tabContent.querySelector('.swipeable-content');
                if (!swipeableContent) return;

                const contentSections = swipeableContent.querySelectorAll('.content-section');
                const currentIndex = this.currentCards.get(tabId) || 0;
                const newIndex = Math.max(0, Math.min(contentSections.length - 1, currentIndex + direction));

                if (newIndex !== currentIndex) {
                    this.currentCards.set(tabId, newIndex);
                    this.scrollToCard(swipeableContent, newIndex);
                    this.updateNavigation(tabId);
                }
            }

            scrollToCard(container, cardIndex) {
                const contentSections = container.querySelectorAll('.content-section');
                const targetSection = contentSections[cardIndex];
                if (targetSection) {
                    const containerWidth = container.clientWidth;
                    const scrollLeft = cardIndex * containerWidth;

                    container.scrollTo({
                        left: scrollLeft,
                        behavior: 'smooth'
                    });

                    // Update swipe indicators
                    this.updateSwipeIndicators(container, cardIndex);
                }
            }

            updateSwipeIndicators(container, activeIndex) {
                const tabContent = container.closest('.tab-content');
                if (!tabContent) return;

                const indicator = tabContent.querySelector('.swipe-indicator');
                if (indicator) {
                    const dots = indicator.querySelectorAll('.swipe-dot');
                    dots.forEach((dot, index) => {
                        dot.classList.toggle('active', index === activeIndex);
                    });
                }
            }

            updateNavigation(tabId) {
                const tabContent = document.getElementById(`${tabId}-content`);
                if (!tabContent) return;

                const contentSections = tabContent.querySelectorAll('.content-section');
                const currentIndex = this.currentCards.get(tabId) || 0;

                // Update all navigation buttons in this tab
                const navButtons = tabContent.querySelectorAll('.card-navigation');
                navButtons.forEach((nav, index) => {
                    const prevBtn = nav.querySelector('.prev-btn');
                    const nextBtn = nav.querySelector('.next-btn');
                    const counter = nav.querySelector('.card-counter');

                    if (prevBtn) prevBtn.disabled = (index === 0);
                    if (nextBtn) nextBtn.disabled = (index === contentSections.length - 1);
                    if (counter) counter.textContent = `${index + 1} из ${contentSections.length}`;
                });

                // Update global card navigation buttons
                const globalPrevBtn = document.querySelector('.card-navigation-buttons .prev-btn');
                const globalNextBtn = document.querySelector('.card-navigation-buttons .next-btn');
                const globalCounter = document.querySelector('.card-navigation-buttons .card-counter');

                if (globalPrevBtn) globalPrevBtn.disabled = (currentIndex === 0);
                if (globalNextBtn) globalNextBtn.disabled = (currentIndex === contentSections.length - 1);
                if (globalCounter) globalCounter.textContent = `${currentIndex + 1} из ${contentSections.length}`;
            }
        }

        // Swipe Manager for mobile content
        class SwipeManager {
            constructor() {
                this.containers = document.querySelectorAll('.swipeable-content');
                this.touchStartX = 0;
                this.touchStartY = 0;
                this.touchEndX = 0;
                this.touchEndY = 0;
                this.minSwipeDistance = 50;
                this.cardNavManager = null;
                this.isSwiping = false;
                this.init();
            }

            setCardNavigationManager(manager) {
                this.cardNavManager = manager;
            }

            init() {
                this.containers.forEach(container => {
                    // Touch events for swipe
                    container.addEventListener('touchstart', (e) => {
                        this.touchStartX = e.changedTouches[0].screenX;
                        this.touchStartY = e.changedTouches[0].screenY;
                        this.isSwiping = false;
                    }, { passive: true });

                    container.addEventListener('touchmove', (e) => {
                        if (!this.isSwiping) {
                            const deltaX = Math.abs(e.changedTouches[0].screenX - this.touchStartX);
                            const deltaY = Math.abs(e.changedTouches[0].screenY - this.touchStartY);
                            if (deltaX > 10 || deltaY > 10) {
                                this.isSwiping = true;
                            }
                        }
                    }, { passive: true });

                    container.addEventListener('touchend', (e) => {
                        if (this.isSwiping) {
                            this.touchEndX = e.changedTouches[0].screenX;
                            this.touchEndY = e.changedTouches[0].screenY;
                            this.handleSwipe(container);
                        }
                        this.isSwiping = false;
                    }, { passive: true });

                    // Mouse events for desktop testing
                    container.addEventListener('mousedown', (e) => {
                        this.touchStartX = e.screenX;
                        this.touchStartY = e.screenY;
                        this.isSwiping = false;
                    });

                    container.addEventListener('mousemove', (e) => {
                        if (e.buttons === 1 && !this.isSwiping) { // Left mouse button
                            const deltaX = Math.abs(e.screenX - this.touchStartX);
                            const deltaY = Math.abs(e.screenY - this.touchStartY);
                            if (deltaX > 10 || deltaY > 10) {
                                this.isSwiping = true;
                            }
                        }
                    });

                    container.addEventListener('mouseup', (e) => {
                        if (this.isSwiping) {
                            this.touchEndX = e.screenX;
                            this.touchEndY = e.screenY;
                            this.handleSwipe(container);
                        }
                        this.isSwiping = false;
                    });

                    // Update navigation on scroll
                    container.addEventListener('scroll', debounce(() => {
                        this.updateCardNavigation(container);
                    }, 100));
                });
            }

            handleSwipe(container) {
                const swipeDistanceX = this.touchStartX - this.touchEndX;
                const swipeDistanceY = this.touchStartY - this.touchEndY;

                // Only handle horizontal swipes (prevent vertical scroll interference)
                if (Math.abs(swipeDistanceX) > this.minSwipeDistance && Math.abs(swipeDistanceX) > Math.abs(swipeDistanceY)) {
                    const tabContent = container.closest('.tab-content');
                    if (tabContent) {
                        const tabId = tabContent.id.replace('-content', '');
                        const direction = swipeDistanceX > 0 ? 1 : -1; // positive = left swipe = next

                        if (this.cardNavManager) {
                            this.cardNavManager.navigateCard(tabId, direction);
                        }
                    }
                }
            }

            updateCardNavigation(container) {
                const tabContent = container.closest('.tab-content');
                if (!tabContent || !this.cardNavManager) return;

                const tabId = tabContent.id.replace('-content', '');
                const scrollLeft = container.scrollLeft;
                const containerWidth = container.clientWidth;
                const currentIndex = Math.round(scrollLeft / containerWidth);

                this.cardNavManager.currentCards.set(tabId, currentIndex);
                this.cardNavManager.updateNavigation(tabId);

                // Update swipe indicators
                this.updateSwipeIndicators(container, currentIndex);
            }
        }

        // Mobile Navigation Manager
        class NavigationManager {
            constructor() {
                this.navToggle = document.getElementById('nav-toggle');
                this.navigation = document.getElementById('main-navigation');
                this.navLinks = document.querySelectorAll('.nav-links a');
                this.init();
            }

            init() {
                // Toggle button handler
                this.navToggle.addEventListener('click', () => {
                    this.toggleNavigation();
                });

                // Close navigation when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.navigation.contains(e.target) && !this.navToggle.contains(e.target)) {
                        this.closeNavigation();
                    }
                });

                // Smooth scrolling for navigation links
                this.navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.handleNavLinkClick(link);
                    });
                });

                // Keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.navigation.classList.contains('open')) {
                        this.closeNavigation();
                    }
                });
            }

            toggleNavigation() {
                const isOpen = this.navigation.classList.contains('open');
                if (isOpen) {
                    this.closeNavigation();
                } else {
                    this.openNavigation();
                }
            }

            openNavigation() {
                this.navigation.classList.add('open');
                this.navToggle.classList.add('active');
                this.navToggle.setAttribute('aria-expanded', 'true');
                this.navigation.setAttribute('aria-hidden', 'false');
            }

            closeNavigation() {
                this.navigation.classList.remove('open');
                this.navToggle.classList.remove('active');
                this.navToggle.setAttribute('aria-expanded', 'false');
                this.navigation.setAttribute('aria-hidden', 'true');
            }

            handleNavLinkClick(link) {
                const targetId = link.getAttribute('href');
                const targetElement = document.querySelector(targetId);

                if (targetElement) {
                    const headerOffset = 80;
                    const elementPosition = targetElement.offsetTop;
                    const offsetPosition = elementPosition - headerOffset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }

                // Close mobile navigation after clicking a link
                this.closeNavigation();
            }
        }

        // Back to Top Manager
        class BackToTopManager {
            constructor() {
                this.button = document.getElementById('back-to-top');
                this.scrollThreshold = 300;
                this.init();
            }

            init() {
                // Debounced scroll handler for performance
                const debouncedScrollHandler = debounce(() => {
                    this.handleScroll();
                }, 10);

                window.addEventListener('scroll', debouncedScrollHandler);

                // Click handler
                this.button.addEventListener('click', () => {
                    this.scrollToTop();
                });

                // Keyboard support
                this.button.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.scrollToTop();
                    }
                });
            }

            handleScroll() {
                const scrolled = window.pageYOffset;
                if (scrolled > this.scrollThreshold) {
                    this.showButton();
                } else {
                    this.hideButton();
                }
            }

            showButton() {
                this.button.classList.add('show');
                this.button.setAttribute('aria-hidden', 'false');
            }

            hideButton() {
                this.button.classList.remove('show');
                this.button.setAttribute('aria-hidden', 'true');
            }

            scrollToTop() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });

                // Focus management - move focus to top of page
                document.querySelector('h1').focus();
            }
        }

        // Initialize all managers when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme management
            const themeManager = new ThemeManager();

            // Initialize language management
            const languageManager = new LanguageManager();

            // Initialize search functionality
            const searchManager = new SearchManager();

            // Initialize progress tracking
            const progressManager = new ProgressManager();

            // Initialize tab management
            const tabManager = new TabManager();

            // Initialize card navigation
            const cardNavManager = new CardNavigationManager();

            // Initialize card navigation buttons
            const cardNavButtonsManager = new CardNavigationButtonsManager();
            cardNavButtonsManager.setManagers(cardNavManager, progressManager);

            // Initialize swipe functionality for mobile
            const swipeManager = new SwipeManager();
            swipeManager.setCardNavigationManager(cardNavManager);

            // Initialize back-to-top functionality
            const backToTopManager = new BackToTopManager();

            // Connect managers
            tabManager.onTabSwitch = (tabId) => {
                progressManager.setCurrentTab(tabId);
                cardNavButtonsManager.updateButtons(tabId);
            };

            // Performance monitoring
            if ('performance' in window) {
                window.addEventListener('load', () => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    const loadTime = perfData.loadEventEnd - perfData.loadEventStart;
                    console.log(`Page load time: ${loadTime}ms`);
                });
            }

            // Initialize swipe indicators and card navigation for mobile
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                const tabId = content.id.replace('-content', '');
                // Skip creating swipe indicators for the General tab
                if (tabId !== 'general') {
                    const swipeable = content.querySelector('.swipeable-content');
                    if (swipeable && swipeable.scrollWidth > swipeable.clientWidth) {
                        const indicator = document.createElement('div');
                        indicator.className = 'swipe-indicator';
                        const sectionCount = swipeable.querySelectorAll('.content-section').length;
                        let dotsHtml = '';
                        for (let i = 0; i < sectionCount; i++) {
                            dotsHtml += `<div class="swipe-dot ${i === 0 ? 'active' : ''}" data-slide="${i}"></div>`;
                        }
                        indicator.innerHTML = dotsHtml;
    
                        // Add click handlers for dots
                        indicator.addEventListener('click', (e) => {
                            if (e.target.classList.contains('swipe-dot')) {
                                const slideIndex = parseInt(e.target.dataset.slide);
                                const tabId = content.id.replace('-content', '');
                                cardNavManager.navigateCard(tabId, slideIndex - cardNavManager.currentCards.get(tabId));
                            }
                        });
    
                        content.appendChild(indicator);
                    }
                }
            });

            // Update card navigation buttons on tab switch
            tabManager.onTabSwitch = (tabId) => {
                progressManager.setCurrentTab(tabId);
                cardNavButtonsManager.updateButtons(tabId);
            };
        });

        // Error handling for missing elements
        window.addEventListener('error', (e) => {
            console.warn('JavaScript error:', e.message);
        });

        // Graceful degradation for older browsers
        if (!window.requestAnimationFrame) {
            window.requestAnimationFrame = (callback) => setTimeout(callback, 16);
        }
    </script>

    <script>
        
        // Function to show guide
        function showGuide() {
            const mainApp = document.getElementById('mainApp');
            const guideContainer = document.getElementById('guideContainer');
            
            if (mainApp && guideContainer) {
                mainApp.style.display = 'none';
                guideContainer.style.display = 'block';
                document.body.classList.add('guide-active');
                
                // Update the close button in the guide to say "Back to Diary" and link to main app
                const guideCloseBtn = document.getElementById('close-guide');
                if (guideCloseBtn) {
                    guideCloseBtn.textContent = ' Back to Diary ↩';
                    guideCloseBtn.onclick = function(e) {
                        e.preventDefault();
                        showMainApp();
                    };
                }
                
                // Initialize the guide tabs when showing the guide
                // Make sure the first tab in the guide is active
                setTimeout(() => {
                    const guideTabs = guideContainer.querySelectorAll('.tab-button');
                    const guideTabContents = guideContainer.querySelectorAll('.tab-content');
                    
                    // Remove active class from all guide tabs and contents
                    guideTabs.forEach(tab => tab.classList.remove('active'));
                    guideTabContents.forEach(tc => tc.classList.remove('active'));
                    
                    // Activate the first guide tab and its content
                    if (guideTabs.length > 0) {
                        guideTabs[0].classList.add('active');
                        guideTabs[0].setAttribute('aria-selected', 'true');
                        
                        // Find corresponding content tab
                        const firstTabId = guideTabs[0].dataset.tab;
                        const firstTabContent = document.getElementById(firstTabId + '-content');
                        if (firstTabContent) {
                            firstTabContent.classList.add('active');
                            firstTabContent.setAttribute('aria-hidden', 'false');
                        }
                    }
                    
                    // Also ensure the first card in the active tab is visible
                    const activeTabContent = guideContainer.querySelector('.tab-content.active');
                    if (activeTabContent) {
                        const firstCard = activeTabContent.querySelector('.content-section');
                        if (firstCard) {
                            // Scroll to the first card if needed
                            firstCard.scrollIntoView({ behavior: 'auto', block: 'start' });
                        }
                    }
                    
                    // Trigger a resize event to make sure swipe managers update properly
                    setTimeout(() => {
                        window.dispatchEvent(new Event('resize'));
                        // Also simulate a scroll event on the swipeable content to trigger updates
                        const swipeableContents = guideContainer.querySelectorAll('.swipeable-content');
                        swipeableContents.forEach(content => {
                            content.dispatchEvent(new Event('scroll'));
                        });
                        
                        // Update card navigation buttons state for the active tab
                        setTimeout(() => {
                            // Use the globally available managers if they exist
                            if (typeof cardNavButtonsManager !== 'undefined' && typeof progressManager !== 'undefined') {
                                const activeTabBtn = guideContainer.querySelector('.tab-button.active');
                                if (activeTabBtn) {
                                    const tabId = activeTabBtn.dataset.tab;
                                    cardNavButtonsManager.updateButtons(tabId);
                                }
                            }
                        }, 50);
                    }, 100);
                    
                    // Reinitialize all guide navigation components to ensure they work properly
                    setTimeout(() => {
                        // Ensure the first tab is properly activated with all functionality
                        const firstTabButton = guideContainer.querySelector('.tab-button.active');
                        if (firstTabButton) {
                            const tabId = firstTabButton.dataset.tab;
                            // Make sure card navigation is properly set to the first card
                            if (typeof cardNavManager !== 'undefined') {
                                cardNavManager.currentCards.set(tabId, 0);
                                cardNavManager.updateNavigation(tabId);
                                
                                // Also update the card navigation buttons manager
                                if (typeof cardNavButtonsManager !== 'undefined') {
                                    cardNavButtonsManager.updateButtons(tabId);
                                }
                            }
                        }
                        
                        // Force reinitialization of swipe indicators
                        const swipeableContents = guideContainer.querySelectorAll('.swipeable-content');
                        swipeableContents.forEach(content => {
                            const tabContent = content.closest('.tab-content');
                            if (tabContent) {
                                const tabId = tabContent.id.replace('-content', '');
                                
                                // Update swipe indicators
                                const indicator = tabContent.querySelector('.swipe-indicator');
                                if (indicator) {
                                    const dots = indicator.querySelectorAll('.swipe-dot');
                                    dots.forEach((dot, index) => {
                                        dot.classList.toggle('active', index === 0); // First card is active
                                    });
                                }
                                
                                // Ensure content is scrolled to the beginning
                                content.scrollTo({ left: 0, behavior: 'auto' });
                            }
                        });
                        
                        // Initialize or reinitialize navigation managers specifically for the guide
                        if (typeof TabManager !== 'undefined' && typeof CardNavigationManager !== 'undefined' && typeof SwipeManager !== 'undefined') {
                            // These managers should already be available globally, but ensure they're properly set up
                            const guideTabButtons = guideContainer.querySelectorAll('.tab-button');
                            const guideCardNavButtons = guideContainer.querySelectorAll('.card-navigation-buttons');
                            
                            // Ensure all tab buttons have proper event listeners
                            guideTabButtons.forEach(tabBtn => {
                                tabBtn.addEventListener('click', function() {
                                    const clickedTabId = this.dataset.tab;
                                    
                                    // Update tab states
                                    guideTabButtons.forEach(btn => {
                                        const isActive = btn.dataset.tab === clickedTabId;
                                        btn.classList.toggle('active', isActive);
                                        btn.setAttribute('aria-selected', isActive);
                                    });
                                    
                                    // Update content states
                                    const allGuideContents = guideContainer.querySelectorAll('.tab-content');
                                    allGuideContents.forEach(content => {
                                        const isActive = content.id === `${clickedTabId}-content`;
                                        content.classList.toggle('active', isActive);
                                        content.setAttribute('aria-hidden', !isActive);
                                        
                                        // Update navigation buttons for this tab
                                        if (isActive && typeof cardNavButtonsManager !== 'undefined') {
                                            cardNavButtonsManager.updateButtons(clickedTabId);
                                        }
                                    });
                                    
                                    // Update card navigation buttons state for the active tab
                                    if (typeof cardNavButtonsManager !== 'undefined') {
                                        cardNavButtonsManager.updateButtons(clickedTabId);
                                    }
                                });
                            });
                        }
                    }, 150);
                }, 50); // Small delay to ensure DOM is ready
            }
        }
        
        // Function to show main app
        function showMainApp() {
            const mainApp = document.getElementById('mainApp');
            const guideContainer = document.getElementById('guideContainer');
            
            if (mainApp && guideContainer) {
                guideContainer.style.display = 'none';
                mainApp.style.display = 'block';
                document.body.classList.remove('guide-active');
                
                // Ensure only one tab content is visible when returning from guide
                const allTabs = document.querySelectorAll('.tab');
                const allTabContents = document.querySelectorAll('.tab-content');
                
                // Remove active class from all tabs and contents
                allTabs.forEach(tab => tab.classList.remove('active'));
                allTabContents.forEach(tc => tc.classList.remove('active'));
                
                // Set General tab as the active tab when returning to main app
                const generalTab = document.querySelector('.tab[data-tab="general"]');
                if (generalTab) {
                    generalTab.classList.add('active');
                    const generalTabContent = document.getElementById('general-tab');
                    if (generalTabContent) {
                        generalTabContent.classList.add('active');
                    }
                }
                
                // Update the guide tab to be inactive when returning to main app
                const guideTab = document.querySelector('.tab[data-tab="guide"]');
                if (guideTab) {
                    guideTab.classList.remove('active');
                }
                
                // Reinitialize the main app's navigation components to ensure they work properly after returning from guide
                setTimeout(() => {
                    // Reinitialize the general tab content
                    if (typeof initGeneralTab !== 'undefined') {
                        initGeneralTab();
                    }
                    
                    // Update the date navigation buttons
                    if (typeof updateNavigationButtons !== 'undefined') {
                        updateNavigationButtons();
                    }
                    
                    // Update the current day label
                    if (typeof updateCurrentDayLabel !== 'undefined') {
                        updateCurrentDayLabel();
                    }
                    
                    // Update permissions for editing
                    if (typeof updateEditPermissions !== 'undefined') {
                        updateEditPermissions();
                    }
                    
                    // Update progress bar
                    if (typeof updateProgressBar !== 'undefined') {
                        updateProgressBar();
                    }
                    
                    // Update percentage indicator
                    if (typeof updatePercentageIndicator !== 'undefined') {
                        updatePercentageIndicator();
                    }
                    
                    // Trigger resize event to make sure all components are properly displayed
                    window.dispatchEvent(new Event('resize'));
                }, 100); // Small delay to ensure the main app is fully displayed before reinitializing
            }
        }
        
        // Initialize guide functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize guide container and main app visibility
            const mainApp = document.getElementById('mainApp');
            const guideContainer = document.getElementById('guideContainer');
            
            if (mainApp && guideContainer) {
                // Initially show main app and hide guide
                mainApp.style.display = 'block';
                guideContainer.style.display = 'none';
            }
            
            // Add click handler to the open guide button in settings
            const openGuideBtn = document.getElementById('openGuideBtn');
            if (openGuideBtn) {
                openGuideBtn.addEventListener('click', showGuide);
            }
            
            // Load the guide content
            loadGuide();
        });
    </script>
</body>
</html>
